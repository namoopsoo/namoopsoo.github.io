<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>michal.piekarczyk.xyz</title><meta name=keywords content><meta name=description content="List indexes From here SELECT tablename, indexname, indexdef FROM pg_indexes WHERE schemaname = 'public' ORDER BY tablename, indexname; Disk Usage per table from the postgresql wiki except one minor change &mldr; for ('user_blah', 'user_blar', 'schema1', 'schema2') schemas only &mldr; SELECT *, pg_size_pretty(total_bytes) AS total , pg_size_pretty(index_bytes) AS INDEX , pg_size_pretty(toast_bytes) AS toast , pg_size_pretty(table_bytes) AS TABLE FROM ( SELECT *, total_bytes-index_bytes-COALESCE(toast_bytes,0) AS table_bytes FROM ( SELECT c.oid,nspname AS table_schema, relname AS TABLE_NAME , c."><meta name=author content="Michal Piekarczyk"><link rel=canonical href=https://michal.piekarczyk.xyz/handy/sql/hmm/><link crossorigin=anonymous href=/assets/css/stylesheet.dd867d536fb6202811c1ee15fa181ef8945826662b49d3016ac91365a2621d58.css integrity="sha256-3YZ9U2+2ICgRwe4V+hge+JRYJmYrSdMBaskTZaJiHVg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://michal.piekarczyk.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://michal.piekarczyk.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://michal.piekarczyk.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://michal.piekarczyk.xyz/apple-touch-icon.png><link rel=mask-icon href=https://michal.piekarczyk.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-74MK08REDT"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-74MK08REDT",{anonymize_ip:!1})}</script><meta property="og:title" content><meta property="og:description" content="List indexes From here SELECT tablename, indexname, indexdef FROM pg_indexes WHERE schemaname = 'public' ORDER BY tablename, indexname; Disk Usage per table from the postgresql wiki except one minor change &mldr; for ('user_blah', 'user_blar', 'schema1', 'schema2') schemas only &mldr; SELECT *, pg_size_pretty(total_bytes) AS total , pg_size_pretty(index_bytes) AS INDEX , pg_size_pretty(toast_bytes) AS toast , pg_size_pretty(table_bytes) AS TABLE FROM ( SELECT *, total_bytes-index_bytes-COALESCE(toast_bytes,0) AS table_bytes FROM ( SELECT c.oid,nspname AS table_schema, relname AS TABLE_NAME , c."><meta property="og:type" content="article"><meta property="og:url" content="https://michal.piekarczyk.xyz/handy/sql/hmm/"><meta property="article:section" content="handy"><meta property="og:site_name" content="michal.piekarczyk.xyz"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="List indexes From here SELECT tablename, indexname, indexdef FROM pg_indexes WHERE schemaname = 'public' ORDER BY tablename, indexname; Disk Usage per table from the postgresql wiki except one minor change &mldr; for ('user_blah', 'user_blar', 'schema1', 'schema2') schemas only &mldr; SELECT *, pg_size_pretty(total_bytes) AS total , pg_size_pretty(index_bytes) AS INDEX , pg_size_pretty(toast_bytes) AS toast , pg_size_pretty(table_bytes) AS TABLE FROM ( SELECT *, total_bytes-index_bytes-COALESCE(toast_bytes,0) AS table_bytes FROM ( SELECT c.oid,nspname AS table_schema, relname AS TABLE_NAME , c."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Handies","item":"https://michal.piekarczyk.xyz/handy/"},{"@type":"ListItem","position":2,"name":"","item":"https://michal.piekarczyk.xyz/handy/sql/hmm/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"","name":"","description":"List indexes From here SELECT tablename, indexname, indexdef FROM pg_indexes WHERE schemaname = \u0026#39;public\u0026#39; ORDER BY tablename, indexname; Disk Usage per table from the postgresql wiki except one minor change \u0026hellip; for ('user_blah', 'user_blar', 'schema1', 'schema2') schemas only \u0026hellip; SELECT *, pg_size_pretty(total_bytes) AS total , pg_size_pretty(index_bytes) AS INDEX , pg_size_pretty(toast_bytes) AS toast , pg_size_pretty(table_bytes) AS TABLE FROM ( SELECT *, total_bytes-index_bytes-COALESCE(toast_bytes,0) AS table_bytes FROM ( SELECT c.oid,nspname AS table_schema, relname AS TABLE_NAME , c.","keywords":[],"articleBody":"List indexes From here SELECT tablename, indexname, indexdef FROM pg_indexes WHERE schemaname = 'public' ORDER BY tablename, indexname; Disk Usage per table from the postgresql wiki except one minor change … for ('user_blah', 'user_blar', 'schema1', 'schema2') schemas only … SELECT *, pg_size_pretty(total_bytes) AS total , pg_size_pretty(index_bytes) AS INDEX , pg_size_pretty(toast_bytes) AS toast , pg_size_pretty(table_bytes) AS TABLE FROM ( SELECT *, total_bytes-index_bytes-COALESCE(toast_bytes,0) AS table_bytes FROM ( SELECT c.oid,nspname AS table_schema, relname AS TABLE_NAME , c.reltuples AS row_estimate , pg_total_relation_size(c.oid) AS total_bytes , pg_indexes_size(c.oid) AS index_bytes , pg_total_relation_size(reltoastrelid) AS toast_bytes FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE relkind = 'r' and nspname in ('user_blah', 'user_blar', 'schema1', 'schema2') ) a ) a detect blocked queries? This didnt exactly work for me as expected, but colleague had mentioned this … SELECT COALESCE(blockingl.relation::regclass::text,blockingl.locktype) as locked_item, now() - blockeda.query_start AS waiting_duration, blockeda.pid AS blocked_pid, blockeda.query as blocked_query, blockedl.mode as blocked_mode, blockinga.pid AS blocking_pid, blockinga.query as blocking_query, blockingl.mode as blocking_mode FROM pg_catalog.pg_locks blockedl JOIN pg_stat_activity blockeda ON blockedl.pid = blockeda.pid JOIN pg_catalog.pg_locks blockingl ON( ( (blockingl.transactionid=blockedl.transactionid) OR (blockingl.relation=blockedl.relation AND blockingl.locktype=blockedl.locktype) ) AND blockedl.pid != blockingl.pid) JOIN pg_stat_activity blockinga ON blockingl.pid = blockinga.pid AND blockinga.datid = blockeda.datid WHERE NOT blockedl.granted AND blockinga.datname = current_database() hmmmm how about this select blockingl.relation, blockingl.pid, blockingl.mode, blockingl.granted, pgclass.relname, stat.usename, stat.application_name, stat.wait_event_type, stat.wait_event, stat.state, stat.query from pg_catalog.pg_locks blockingl join pg_class pgclass on blockingl.relation = pgclass.oid join pg_stat_activity stat on stat.pid = blockingl.pid check role membership select rr.*, pam.* from pg_catalog.pg_roles rr join pg_catalog.pg_auth_members pam on rr.\"oid\" = pam.roleid in line table using a CTE … with datar(col1,col2) as ( values (1,2), (2,3), (4,5) ) select col1, col2 from datar COALESCE uses early stopping I had a pretty expensive COALESCE(col1, col2, ..., col50) with 50 arguments recently. And in testing whether my non-null value was first or last made a big difference! round does not work on double precision Wow interesting. I was comparing features generated in two tables to do some QA. Table 1 was the original or “target gold” table and table 2 was a table generated by production code. Using a simple table1.col1 = table2.col1 comparison, a particular float column was coming back as 0.092 , for about 100k rows. Hand inspecting, this looked like a difference of precision, but when I applied round(table1.col1, 3) = round(table2.col1, 3) instead, I got UndefinedFunction: function round(double precision, integer) does not exist And surely enough after reading the docs , oddly enough round with precision is only defined for numeric and not float8 (aka double precision). After casting to numeric my result of round(table1.col1::numeric, 3) = round(table2.col1::numeric, 3) was 0.990. Can dig deeper about the implementation later!\nTo infinity and beyond select 999999\u003e 'infinity'::float unnesting , the opposite of crosstab (aka pivoting) CREATE TABLE foo (id int, a text, b text, c text); INSERT INTO foo VALUES (1, 'ant', 'cat', 'chimp'), (2, 'grape', 'mint', 'basil'), (3, 'blur', 'cart', 'jump'); select * from foo id a b c 1 ant cat chimp 2 grape mint basil 3 blur cart jump SELECT id, unnest(array['a', 'b', 'c']) AS colname, unnest(array[a, b, c]) AS thing FROM foo ORDER BY id; id colname thing 1 a ant 1 b cat 1 c chimp 2 a grape 2 b mint 2 c basil 3 a blur 3 b cart 3 c jump copy paste a table with create table as Copy-pastaing a table with CREATE TABLE AS is sort of obvious, but laying it out doesn’t hurt CREATE TABLE blah_backup AS SELECT * FROM source_table cool stack overflow response here too Create user CREATE USER blah_user WITH PASSWORD 'swear_words'; GRANT CONNECT ON DATABASE mycooldb TO blah_user; GRANT USAGE ON SCHEMA myschema TO blah_user; GRANT SELECT ON myschema.quick_table TO blah_user; Change password ALTER USER user_name WITH PASSWORD 'new_password'; check grants.. ( user w/ appropriate permissions ) SELECT table_catalog, table_schema, table_name, privilege_type, grantee FROM information_schema.table_privileges list users select * from pg_user set lock_timeout to avoid waiting endlessly on table alter # example from article , which bit me personally.. SET lock_timeout TO '2s'; ALTER TABLE items ADD COLUMN last_update timestamptz; source: here arbitrarily select unrelated data for presentation purposes Not sure if this is the best way to do this, but I wanted to be able select three different max values in one shot with arf as (select 1 as aa, max(id) as max_arf from mytable where key = 'arf'), bar as (select 1 as aa, max(id) as max_bar from mytable where key = 'bar'), car as (select 1 as aa, max(id) as max_car from mytable where key = 'car') select arf.*, bar.*, car.* from arf join bar on arf.aa = bar.aa join car on arf.aa = car.aa aa max_arf aa max_bar aa max_car 1 4,585,834 1 4,046,591 1 4,585,835 Random sample from a table Read this cool solution here SELECT * FROM myTable WHERE attribute = 'myValue' ORDER BY random() LIMIT 1000; in place jsonb extraction / unnesting If we have a table with a jsonb type column , called value , and we want to “un-nest” or normalize some data that happens to be one level below, in the jsonb… ids_sql = '(1, 2, 3)' blah_key = 'green_type' # some additional constraint other than the id target_cols = ['norm_col_1', 'norm_col_2', 'norm_col_3'] # Map between foovec = [['norm_col_1', 'nested_col_1'], ['norm_col_2', 'nested_col_2'], ['norm_col_3', 'nested_col_3']] select_cols = ', '.join([f'''value-\u003e\u003e'{x[1]}' as \"{x[0]}\"''' for x in foovec]) col_str = ', '.join([f'\"{x}\"' for x in target_cols]) targetcol_str = ', '.join([f'blah.\"{x}\"' for x in target_cols]) UPDATE {schema}.mytable as dp SET ({col_str}) = ({targetcol_str}) FROM (select id, key, {select_cols} -- json-\u003eexpressions-\u003eto-\u003eunpack-\u003edata! from {schema}.mytable where {ids_sql} and key = '{blah_key}' ) as blah(id, key, {col_str}) WHERE (blah.id = dp.id AND blah.key = dp.key) order of joins matters looks like I had two gigantic tables (10million+ each) , t1, t2, this first query was taking forever… with ids(foo) as ( select * from generate_series(1, 5000) as foo ) select * from t1 join t2 on t1.id = t2.id where t2.id in (select foo from ids) but this one was quick , I think because the join was done after constraining the ids not before with ids(foo) as ( select * from generate_series(1, 5000) as foo ) select * from t1 join t2 on t1.id = t2.id where t1.id in (select foo from ids) hashtag binning width_bucket very nice func for binning some data and then running a sum() aggregation afterwards for instance, the array passed to width_bucket is an array of the lower bounds with deltas(delta, countt) as ( values (-1, 3), (0, 4), (19, 9), (50, 2), (2, 8), (189, 3), (2000, 98), (2001, 3), (null::int, 2), (null, 9) ), binned as ( select width_bucket (deltas.delta::float, array[ 0, 50, 100, 150,200, 2000]::float[] ) as bin, deltas.delta, deltas.countt from deltas ) select delta, countt, bin -- sum(countt) from binned delta countt bin -1 3 0 0 4 1 19 9 1 50 2 2 2 8 1 189 3 4 2,000 98 6 2,001 3 6 [NULL] 2 [NULL] [NULL] 9 [NULL] with deltas(delta, countt) as ( values (10, 3), (11, 4), (19, 9), (50, 2), (2, 8), (189, 3), (77, 98), (178, 3)), binned as ( select width_bucket (deltas.delta::float, array[ 0::float, 50::float, 100::float, 150::float,200::float, 2000::float] ) as bin, deltas.delta, deltas.countt from deltas ) select bin, sum(countt) from binned group by bin order by bin bin sum 1 24 2 100 4 6 auto make that markdown table header line def make_table_header_line(header): dashes = ['--' for x in header.split('|')] return '|'.join(dashes) list constraints from stack overflow … SELECT con.* FROM pg_catalog.pg_constraint con INNER JOIN pg_catalog.pg_class rel ON rel.oid = con.conrelid INNER JOIN pg_catalog.pg_namespace nsp ON nsp.oid = connamespace WHERE nsp.nspname = '' AND rel.relname = ''; Oh wow… also this section from the ALTER TABLE ADD CONSTRAINT postgresql doc was super useful/well written.. Scanning a large table to verify a new foreign key or check constraint can take a long time, and other updates to the table are locked out until the ALTER TABLE ADD CONSTRAINT command is committed. The main purpose of the NOT VALID constraint option is to reduce the impact of adding a constraint on concurrent updates. With NOT VALID, the ADD CONSTRAINT command does not scan the table and can be committed immediately. After that, a VALIDATE CONSTRAINT command can be issued to verify that existing rows satisfy the constraint. The validation step does not need to lock out concurrent updates, since it knows that other transactions will be enforcing the constraint for rows that they insert or update; only pre-existing rows need to be checked. Hence, validation acquires only a SHARE UPDATE EXCLUSIVE lock on the table being altered. (If the constraint is a foreign key then a ROW SHARE lock is also required on the table referenced by the constraint.) In addition to improving concurrency, it can be useful to use NOT VALID and VALIDATE CONSTRAINT in cases where the table is known to contain pre-existing violations. Once the constraint is in place, no new violations can be inserted, and the existing problems can be corrected at leisure until VALIDATE CONSTRAINT finally succeeds.\n-- step one. alter table the_table_name ADD constraint the_constraint_name unique (col1, col2) NOT VALID -- step two.. alter table the_table_name VALIDATE CONSTRAINT the_constraint_name Having Interesting conditional syntax aroung group by , without using a CTE… select id, key , count(*) countt from my_table group by id, key having count(*) \u003e 1 =\u003e id key countt 1 foo 2 2 bar 3 invalid input syntax for integer Having come across this a few times, writing down here.. InvalidTextRepresentation: invalid input syntax for integer: \"\" This typically means a blank string is being coaxed as an integer somewhere. The solution is basically to find these and make sure they’re nulls on the db. And can also partition with an id column too for example, to do a little at a time to experiment. update mytable set blahcol = null where blahcol = '' and ( id between 1 and 100000) A warning about CTEs Per this article , postgresql will run full CTE and store it, which is why I feel the only practical way of using CTEs in large expressions is along with partitioning . In other words, although most postgresql queries will be able to run only the first 200 rows like a “generator” and return that to you really quickly, when you have a CTE in there, it has to run the whole thing first. Triggers Per here SELECT trigger_schema,event_object_table,trigger_schema,trigger_name,event_manipulation,action_statement,action_timing FROM information_schema.triggers ORDER BY event_object_table,event_manipulation Using window function to dedupe some data Given some rows like user_id laptop purchase_date 1 sony 1 1 nokia 2 1 bell 3 2 3m 2 2 nokia 8 If we want to dedupe by this simplified integer purchase_date with laptops(user_id, laptop, purchase_date) as ( values (1, 'sony', 1), (1, 'nokia', 2), (1, 'bell', 3), (2, '3m', 2), (2, 'nokia', 8) ) select l.*, row_number() over w as rnum from laptops as l window w as (partition by l.user_id order by purchase_date asc ) user_id laptop purchase_date rnum 1 sony 1 1 1 nokia 2 2 1 bell 3 3 2 3m 2 1 2 nokia 8 2 And then keep only the rnum = 1 …\nwith laptops(user_id, laptop, purchase_date) as ( values (1, 'sony', 1), (1, 'nokia', 2), (1, 'bell', 3), (2, '3m', 2), (2, 'nokia', 8) ), select aa.* from ( select l.*, row_number() over w as rnum from laptops as l window w as (partition by l.user_id order by purchase_date asc ) ) as aa where aa.rnum = 1 user_id laptop purchase_date rnum 1 sony 1 1 2 3m 2 1 length of an array is cardinality select cardinality(ARRAY[[1,2],[3,4]]) 4 logistic CREATE or replace FUNCTION myschema.logistic(val float) RETURNS float AS $$ BEGIN RETURN (1/(1 + ( exp(1)^(-(val))))) ; END; $$ LANGUAGE PLPGSQL; left join two tables with an extra condition and keep the null join rows This was bothering me for a bit but I think I have found the solution multiple times now. Writing this out for later In this example, there are authors and authors can have one or multiple articles. Self Join articles , to get multiple articles, but only where the left id is less than the right id. This is a contrived example, but my use case typically is not a self join but a join with different tables, but the idea still holds. with articles(author, article_id, article_title) as (values ('joe', 1, 'birds'), ('joe', 2, 'more birds'), ('sally', 3, 'eagles'), ('sally', 4, 'seagulls'), ('jan', 5, 'the philosophical of flying')) select a.author, a.article_id as left_id, a.article_title as left_title, b.article_id as right_id, b.article_title as right_title from articles as a left join articles as b on (a.author = b.author and a.article_id \u003c b.article_id) author left_id left_title right_id right_title joe 1 birds 2 more birds joe 2 more birds [NULL] [NULL] sally 3 eagles 4 seagulls sally 4 seagulls [NULL] [NULL] jan 5 the philosophical of flying [NULL] [NULL] ","wordCount":"2146","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Michal Piekarczyk"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://michal.piekarczyk.xyz/handy/sql/hmm/"},"publisher":{"@type":"Organization","name":"michal.piekarczyk.xyz","logo":{"@type":"ImageObject","url":"https://michal.piekarczyk.xyz/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://michal.piekarczyk.xyz/ accesskey=h title="michal.piekarczyk.xyz (Alt + H)">michal.piekarczyk.xyz</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://michal.piekarczyk.xyz/post/ title=posts><span>posts</span></a></li><li><a href=https://michal.piekarczyk.xyz/project/ title=projects><span>projects</span></a></li><li><a href=https://michal.piekarczyk.xyz/handy/ title=handy><span>handy</span></a></li><li><a href=https://michal.piekarczyk.xyz/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://michal.piekarczyk.xyz/about/ title=about><span>about</span></a></li><li><a href=https://world.hey.com/michal.piekarczyk title=frivolity><span>frivolity</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://michal.piekarczyk.xyz/>Home</a>&nbsp;»&nbsp;<a href=https://michal.piekarczyk.xyz/handy/>Handies</a></div><h1 class=post-title></h1><div class=post-meta>11 min&nbsp;·&nbsp;2146 words&nbsp;·&nbsp;Michal Piekarczyk</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li></li></ul></li></ul></nav></div></details></div><div class=post-content><h4 id=list-indexes>List indexes<a hidden class=anchor aria-hidden=true href=#list-indexes>#</a></h4><ul><li>From <a href=https://www.postgresqltutorial.com/postgresql-indexes/postgresql-list-indexes/>here</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    tablename,
</span></span><span style=display:flex><span>    indexname,
</span></span><span style=display:flex><span>    indexdef
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    pg_indexes
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex><span>    schemaname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;public&#39;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span>
</span></span><span style=display:flex><span>    tablename,
</span></span><span style=display:flex><span>    indexname;
</span></span></code></pre></div><h4 id=disk-usage-per-table>Disk Usage per table<a hidden class=anchor aria-hidden=true href=#disk-usage-per-table>#</a></h4><ul><li>from <a href=https://wiki.postgresql.org/wiki/Disk_Usage>the postgresql wiki</a></li><li>except one minor change &mldr; for <code>('user_blah', 'user_blar', 'schema1', 'schema2')</code> schemas only &mldr;</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>, pg_size_pretty(total_bytes) <span style=color:#66d9ef>AS</span> total
</span></span><span style=display:flex><span>    , pg_size_pretty(index_bytes) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>INDEX</span>
</span></span><span style=display:flex><span>    , pg_size_pretty(toast_bytes) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>toast</span>
</span></span><span style=display:flex><span>    , pg_size_pretty(table_bytes) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>TABLE</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>, total_bytes<span style=color:#f92672>-</span>index_bytes<span style=color:#f92672>-</span>COALESCE(toast_bytes,<span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>AS</span> table_bytes <span style=color:#66d9ef>FROM</span> (
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>c</span>.oid,nspname <span style=color:#66d9ef>AS</span> table_schema, relname <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>TABLE_NAME</span>
</span></span><span style=display:flex><span>              , <span style=color:#66d9ef>c</span>.reltuples <span style=color:#66d9ef>AS</span> row_estimate
</span></span><span style=display:flex><span>              , pg_total_relation_size(<span style=color:#66d9ef>c</span>.oid) <span style=color:#66d9ef>AS</span> total_bytes
</span></span><span style=display:flex><span>              , pg_indexes_size(<span style=color:#66d9ef>c</span>.oid) <span style=color:#66d9ef>AS</span> index_bytes
</span></span><span style=display:flex><span>              , pg_total_relation_size(reltoastrelid) <span style=color:#66d9ef>AS</span> toast_bytes
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>FROM</span> pg_class <span style=color:#66d9ef>c</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>JOIN</span> pg_namespace n <span style=color:#66d9ef>ON</span> n.oid <span style=color:#f92672>=</span> <span style=color:#66d9ef>c</span>.relnamespace
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>WHERE</span> relkind <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;r&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>and</span> nspname <span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#39;user_blah&#39;</span>, <span style=color:#e6db74>&#39;user_blar&#39;</span>, <span style=color:#e6db74>&#39;schema1&#39;</span>, <span style=color:#e6db74>&#39;schema2&#39;</span>)
</span></span><span style=display:flex><span>  ) a
</span></span><span style=display:flex><span>) a
</span></span></code></pre></div><h4 id=detect-blocked-queries>detect blocked queries?<a hidden class=anchor aria-hidden=true href=#detect-blocked-queries>#</a></h4><ul><li>This didnt exactly work for me as expected, but colleague had mentioned this &mldr;</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>  COALESCE(blockingl.relation::regclass::text,blockingl.locktype) <span style=color:#66d9ef>as</span> locked_item,
</span></span><span style=display:flex><span>  now() <span style=color:#f92672>-</span> blockeda.query_start <span style=color:#66d9ef>AS</span> waiting_duration, blockeda.pid <span style=color:#66d9ef>AS</span> blocked_pid,
</span></span><span style=display:flex><span>  blockeda.query <span style=color:#66d9ef>as</span> blocked_query, blockedl.<span style=color:#66d9ef>mode</span> <span style=color:#66d9ef>as</span> blocked_mode,
</span></span><span style=display:flex><span>  blockinga.pid <span style=color:#66d9ef>AS</span> blocking_pid, blockinga.query <span style=color:#66d9ef>as</span> blocking_query,
</span></span><span style=display:flex><span>  blockingl.<span style=color:#66d9ef>mode</span> <span style=color:#66d9ef>as</span> blocking_mode
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> pg_catalog.pg_locks blockedl
</span></span><span style=display:flex><span><span style=color:#66d9ef>JOIN</span> pg_stat_activity blockeda <span style=color:#66d9ef>ON</span> blockedl.pid <span style=color:#f92672>=</span> blockeda.pid
</span></span><span style=display:flex><span><span style=color:#66d9ef>JOIN</span> pg_catalog.pg_locks blockingl <span style=color:#66d9ef>ON</span>(
</span></span><span style=display:flex><span>  ( (blockingl.transactionid<span style=color:#f92672>=</span>blockedl.transactionid) <span style=color:#66d9ef>OR</span>
</span></span><span style=display:flex><span>  (blockingl.relation<span style=color:#f92672>=</span>blockedl.relation <span style=color:#66d9ef>AND</span> blockingl.locktype<span style=color:#f92672>=</span>blockedl.locktype)
</span></span><span style=display:flex><span>  ) <span style=color:#66d9ef>AND</span> blockedl.pid <span style=color:#f92672>!=</span> blockingl.pid)
</span></span><span style=display:flex><span><span style=color:#66d9ef>JOIN</span> pg_stat_activity blockinga <span style=color:#66d9ef>ON</span> blockingl.pid <span style=color:#f92672>=</span> blockinga.pid
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> blockinga.datid <span style=color:#f92672>=</span> blockeda.datid
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>NOT</span> blockedl.<span style=color:#66d9ef>granted</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>AND</span> blockinga.datname <span style=color:#f92672>=</span> current_database()
</span></span></code></pre></div><h4 id=hmmmm-how-about-this>hmmmm how about this<a hidden class=anchor aria-hidden=true href=#hmmmm-how-about-this>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> blockingl.relation, blockingl.pid, blockingl.<span style=color:#66d9ef>mode</span>, blockingl.<span style=color:#66d9ef>granted</span>,
</span></span><span style=display:flex><span>        pgclass.relname, stat.usename, stat.application_name, stat.wait_event_type, stat.wait_event, stat.<span style=color:#66d9ef>state</span>, stat.query
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>from</span> pg_catalog.pg_locks blockingl
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>join</span> pg_class pgclass <span style=color:#66d9ef>on</span> blockingl.relation <span style=color:#f92672>=</span> pgclass.oid 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>join</span> pg_stat_activity stat <span style=color:#66d9ef>on</span> stat.pid <span style=color:#f92672>=</span> blockingl.pid 
</span></span></code></pre></div><h4 id=check-role-membership>check role membership<a hidden class=anchor aria-hidden=true href=#check-role-membership>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> rr.<span style=color:#f92672>*</span>, pam.<span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> pg_catalog.pg_roles rr 
</span></span><span style=display:flex><span> <span style=color:#66d9ef>join</span> pg_catalog.pg_auth_members pam <span style=color:#66d9ef>on</span> rr.<span style=color:#e6db74>&#34;oid&#34;</span> <span style=color:#f92672>=</span> pam.roleid 
</span></span><span style=display:flex><span> 
</span></span></code></pre></div><h4 id=in-line-table>in line table<a hidden class=anchor aria-hidden=true href=#in-line-table>#</a></h4><ul><li>using a CTE &mldr;</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> datar(col1,col2) <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>values</span> (<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>), (<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> col1, col2 <span style=color:#66d9ef>from</span> datar
</span></span></code></pre></div><h4 id=coalesce-uses-early-stopping>COALESCE uses early stopping<a hidden class=anchor aria-hidden=true href=#coalesce-uses-early-stopping>#</a></h4><ul><li>I had a pretty expensive <code>COALESCE(col1, col2, ..., col50)</code> with 50 arguments recently. And in testing whether my non-null value was first or last made a big difference!</li></ul><h4 id=round-does-not-work-on-double-precision>round does not work on double precision<a hidden class=anchor aria-hidden=true href=#round-does-not-work-on-double-precision>#</a></h4><ul><li>Wow interesting. I was comparing features generated in two tables to do some QA. Table 1 was the original or &ldquo;target gold&rdquo; table and table 2 was a table generated by production code. Using a simple <code>table1.col1 = table2.col1</code> comparison, a particular float column was coming back as <code>0.092</code> , for about <code>100k</code> rows. Hand inspecting, this looked like a difference of precision, but when I applied <code>round(table1.col1, 3) = round(table2.col1, 3)</code> instead, I got</li></ul><pre tabindex=0><code>UndefinedFunction: function round(double precision, integer) does not exist
</code></pre><p>And surely enough after reading the <a href=https://www.postgresql.org/docs/9.6/functions-math.html>docs</a> , oddly enough <code>round</code> with precision is only defined for <code>numeric</code> and not <code>float8</code> (aka <code>double precision</code>). After casting to <code>numeric</code> my result of <code>round(table1.col1::numeric, 3) = round(table2.col1::numeric, 3)</code> was <code>0.990</code>. Can dig deeper about the implementation later!</p><h4 id=to-infinity-and-beyond>To infinity and beyond<a hidden class=anchor aria-hidden=true href=#to-infinity-and-beyond>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#ae81ff>999999</span><span style=color:#f92672>&gt;</span> <span style=color:#e6db74>&#39;infinity&#39;</span>::float 
</span></span></code></pre></div><h4 id=unnesting--the-opposite-of-crosstab-aka-pivoting>unnesting , the opposite of crosstab (aka pivoting)<a hidden class=anchor aria-hidden=true href=#unnesting--the-opposite-of-crosstab-aka-pivoting>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span>  <span style=color:#66d9ef>TABLE</span> foo (id int, a text, b text, <span style=color:#66d9ef>c</span> text);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> foo <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;ant&#39;</span>, <span style=color:#e6db74>&#39;cat&#39;</span>, <span style=color:#e6db74>&#39;chimp&#39;</span>), (<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;grape&#39;</span>, <span style=color:#e6db74>&#39;mint&#39;</span>, <span style=color:#e6db74>&#39;basil&#39;</span>),
</span></span><span style=display:flex><span>                        (<span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#39;blur&#39;</span>, <span style=color:#e6db74>&#39;cart&#39;</span>, <span style=color:#e6db74>&#39;jump&#39;</span>);
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> foo
</span></span></code></pre></div><table><thead><tr><th>id</th><th>a</th><th>b</th><th>c</th></tr></thead><tbody><tr><td>1</td><td>ant</td><td>cat</td><td>chimp</td></tr><tr><td>2</td><td>grape</td><td>mint</td><td>basil</td></tr><tr><td>3</td><td>blur</td><td>cart</td><td>jump</td></tr></tbody></table><pre tabindex=0><code>SELECT id,
       unnest(array[&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]) AS colname,
       unnest(array[a, b, c]) AS thing
FROM foo
ORDER BY id;
</code></pre><table><thead><tr><th>id</th><th>colname</th><th>thing</th></tr></thead><tbody><tr><td>1</td><td>a</td><td>ant</td></tr><tr><td>1</td><td>b</td><td>cat</td></tr><tr><td>1</td><td>c</td><td>chimp</td></tr><tr><td>2</td><td>a</td><td>grape</td></tr><tr><td>2</td><td>b</td><td>mint</td></tr><tr><td>2</td><td>c</td><td>basil</td></tr><tr><td>3</td><td>a</td><td>blur</td></tr><tr><td>3</td><td>b</td><td>cart</td></tr><tr><td>3</td><td>c</td><td>jump</td></tr></tbody></table><h4 id=copy-paste-a-table-with-create-table-as>copy paste a table with create table as<a hidden class=anchor aria-hidden=true href=#copy-paste-a-table-with-create-table-as>#</a></h4><ul><li>Copy-pastaing a table with <code>CREATE TABLE AS</code> is sort of obvious, but laying it out doesn&rsquo;t hurt</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> blah_backup <span style=color:#66d9ef>AS</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> source_table
</span></span></code></pre></div><ul><li><a href="https://dba.stackexchange.com/questions/156105/create-table-as-vs-select-into?newreg=f13041cd0d564c7f97956cde8793af0e">cool stack overflow response here too</a></li></ul><h4 id=create-user>Create user<a hidden class=anchor aria-hidden=true href=#create-user>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>USER</span> blah_user <span style=color:#66d9ef>WITH</span> PASSWORD <span style=color:#e6db74>&#39;swear_words&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GRANT</span> <span style=color:#66d9ef>CONNECT</span> <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DATABASE</span> mycooldb <span style=color:#66d9ef>TO</span> blah_user;
</span></span><span style=display:flex><span><span style=color:#66d9ef>GRANT</span> <span style=color:#66d9ef>USAGE</span> <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>SCHEMA</span> myschema <span style=color:#66d9ef>TO</span> blah_user;
</span></span><span style=display:flex><span><span style=color:#66d9ef>GRANT</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>ON</span> myschema.quick_table <span style=color:#66d9ef>TO</span> blah_user;
</span></span></code></pre></div><ul><li>Change password</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>USER</span> user_name <span style=color:#66d9ef>WITH</span> PASSWORD <span style=color:#e6db74>&#39;new_password&#39;</span>;
</span></span></code></pre></div><ul><li>check grants.. ( user w/ appropriate permissions )</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> table_catalog, table_schema, <span style=color:#66d9ef>table_name</span>, privilege_type, grantee
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>   information_schema.table_privileges 
</span></span></code></pre></div><ul><li>list users</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> pg_user
</span></span></code></pre></div><h4 id=set-lock_timeout-to-avoid-waiting-endlessly-on-table-alter>set lock_timeout to avoid waiting endlessly on table alter<a hidden class=anchor aria-hidden=true href=#set-lock_timeout-to-avoid-waiting-endlessly-on-table-alter>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>#</span> example <span style=color:#66d9ef>from</span> article , which bit me personally..
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> lock_timeout <span style=color:#66d9ef>TO</span> <span style=color:#e6db74>&#39;2s&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> items <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>COLUMN</span> last_update timestamptz;
</span></span></code></pre></div><ul><li>source: <a href=https://www.citusdata.com/blog/2018/02/22/seven-tips-for-dealing-with-postgres-locks/>here</a></li></ul><h4 id=arbitrarily-select-unrelated-data-for-presentation-purposes>arbitrarily select unrelated data for presentation purposes<a hidden class=anchor aria-hidden=true href=#arbitrarily-select-unrelated-data-for-presentation-purposes>#</a></h4><ul><li>Not sure if this is the best way to do this, but I wanted to be able select three different max values in one shot</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> arf <span style=color:#66d9ef>as</span> (<span style=color:#66d9ef>select</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>as</span> aa, 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>max</span>(id) <span style=color:#66d9ef>as</span> max_arf
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>from</span> mytable 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>where</span> <span style=color:#66d9ef>key</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;arf&#39;</span>),
</span></span><span style=display:flex><span>bar <span style=color:#66d9ef>as</span> (<span style=color:#66d9ef>select</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>as</span> aa, 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>max</span>(id) <span style=color:#66d9ef>as</span> max_bar
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>from</span> mytable
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>where</span> <span style=color:#66d9ef>key</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;bar&#39;</span>),
</span></span><span style=display:flex><span>car <span style=color:#66d9ef>as</span> (<span style=color:#66d9ef>select</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>as</span> aa,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>max</span>(id) <span style=color:#66d9ef>as</span> max_car
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>from</span> mytable 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>where</span> <span style=color:#66d9ef>key</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;car&#39;</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> arf.<span style=color:#f92672>*</span>, bar.<span style=color:#f92672>*</span>, car.<span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> arf <span style=color:#66d9ef>join</span> bar <span style=color:#66d9ef>on</span> arf.aa <span style=color:#f92672>=</span> bar.aa
</span></span><span style=display:flex><span><span style=color:#66d9ef>join</span> car <span style=color:#66d9ef>on</span> arf.aa <span style=color:#f92672>=</span> car.aa
</span></span></code></pre></div><table><thead><tr><th>aa</th><th>max_arf</th><th>aa</th><th>max_bar</th><th>aa</th><th>max_car</th></tr></thead><tbody><tr><td>1</td><td>4,585,834</td><td>1</td><td>4,046,591</td><td>1</td><td>4,585,835</td></tr></tbody></table><h4 id=random-sample-from-a-table>Random sample from a table<a hidden class=anchor aria-hidden=true href=#random-sample-from-a-table>#</a></h4><ul><li>Read this cool solution <a href=https://anitagraser.com/2011/03/12/selecting-a-random-sample-from-postgresql/>here</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> myTable
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> attribute <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;myValue&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> random()
</span></span><span style=display:flex><span><span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>1000</span>;
</span></span></code></pre></div><h4 id=in-place-jsonb--extraction--unnesting>in place jsonb extraction / unnesting<a hidden class=anchor aria-hidden=true href=#in-place-jsonb--extraction--unnesting>#</a></h4><ul><li>If we have a table with a <code>jsonb</code> type column , called <code>value</code> , and we want to &ldquo;un-nest&rdquo; or normalize some data that happens to be one level below, in the jsonb&mldr;</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>ids_sql <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;(1, 2, 3)&#39;</span> 
</span></span><span style=display:flex><span>blah_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;green_type&#39;</span> <span style=color:#75715e># some additional constraint other than the id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>target_cols <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;norm_col_1&#39;</span>, <span style=color:#e6db74>&#39;norm_col_2&#39;</span>, <span style=color:#e6db74>&#39;norm_col_3&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Map between </span>
</span></span><span style=display:flex><span>foovec <span style=color:#f92672>=</span> [[<span style=color:#e6db74>&#39;norm_col_1&#39;</span>, <span style=color:#e6db74>&#39;nested_col_1&#39;</span>], 
</span></span><span style=display:flex><span>          [<span style=color:#e6db74>&#39;norm_col_2&#39;</span>, <span style=color:#e6db74>&#39;nested_col_2&#39;</span>],
</span></span><span style=display:flex><span>          [<span style=color:#e6db74>&#39;norm_col_3&#39;</span>, <span style=color:#e6db74>&#39;nested_col_3&#39;</span>]]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>select_cols <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;, &#39;</span><span style=color:#f92672>.</span>join([<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;&#39;&#39;value-&gt;&gt;&#39;</span><span style=color:#e6db74>{</span>x[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39; as &#34;</span><span style=color:#e6db74>{</span>x[<span style=color:#ae81ff>0</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>                         <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> foovec])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>col_str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;, &#39;</span><span style=color:#f92672>.</span>join([<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;&#34;</span><span style=color:#e6db74>{</span>x<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;&#39;</span> <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> target_cols])
</span></span><span style=display:flex><span>targetcol_str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;, &#39;</span><span style=color:#f92672>.</span>join([<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;blah.&#34;</span><span style=color:#e6db74>{</span>x<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;&#39;</span> <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> target_cols])
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>UPDATE</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>schema</span><span style=color:#960050;background-color:#1e0010>}</span>.mytable <span style=color:#66d9ef>as</span> dp
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> (<span style=color:#960050;background-color:#1e0010>{</span>col_str<span style=color:#960050;background-color:#1e0010>}</span>) <span style=color:#f92672>=</span> (<span style=color:#960050;background-color:#1e0010>{</span>targetcol_str<span style=color:#960050;background-color:#1e0010>}</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>select</span> id, <span style=color:#66d9ef>key</span>, 
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>{</span>select_cols<span style=color:#960050;background-color:#1e0010>}</span>  <span style=color:#75715e>-- json-&gt;expressions-&gt;to-&gt;unpack-&gt;data!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>from</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>schema</span><span style=color:#960050;background-color:#1e0010>}</span>.mytable
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>where</span> <span style=color:#960050;background-color:#1e0010>{</span>ids_sql<span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>and</span> <span style=color:#66d9ef>key</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;{blah_key}&#39;</span>
</span></span><span style=display:flex><span>        ) <span style=color:#66d9ef>as</span> blah(id, <span style=color:#66d9ef>key</span>, <span style=color:#960050;background-color:#1e0010>{</span>col_str<span style=color:#960050;background-color:#1e0010>}</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> (blah.id <span style=color:#f92672>=</span> dp.id
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>AND</span> blah.<span style=color:#66d9ef>key</span> <span style=color:#f92672>=</span> dp.<span style=color:#66d9ef>key</span>)
</span></span></code></pre></div><h4 id=order-of-joins-matters-looks-like>order of joins matters looks like<a hidden class=anchor aria-hidden=true href=#order-of-joins-matters-looks-like>#</a></h4><ul><li>I had two gigantic tables (10million+ each) , t1, t2,</li><li>this first query was taking forever&mldr;</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> ids(foo) <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> generate_series(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>5000</span>) <span style=color:#66d9ef>as</span> foo    
</span></span><span style=display:flex><span>    )    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> t1 <span style=color:#66d9ef>join</span> t2 
</span></span><span style=display:flex><span><span style=color:#66d9ef>on</span> t1.id <span style=color:#f92672>=</span> t2.id
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span> t2.id <span style=color:#66d9ef>in</span> (<span style=color:#66d9ef>select</span> foo <span style=color:#66d9ef>from</span> ids)
</span></span></code></pre></div><ul><li>but this one was quick , I think because the join was done after constraining the ids not before</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> ids(foo) <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> generate_series(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>5000</span>) <span style=color:#66d9ef>as</span> foo    
</span></span><span style=display:flex><span>    )    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> t1 <span style=color:#66d9ef>join</span> t2 
</span></span><span style=display:flex><span><span style=color:#66d9ef>on</span> t1.id <span style=color:#f92672>=</span> t2.id
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span> t1.id <span style=color:#66d9ef>in</span> (<span style=color:#66d9ef>select</span> foo <span style=color:#66d9ef>from</span> ids)
</span></span></code></pre></div><h4 id=hashtag-binning>hashtag binning<a hidden class=anchor aria-hidden=true href=#hashtag-binning>#</a></h4><ul><li><code>width_bucket</code> very nice func for binning some data and then running a <code>sum()</code> aggregation afterwards for instance,</li><li>the array passed to <code>width_bucket</code> is an array of the lower bounds</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> deltas(delta, countt) <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>values</span> (<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>), (<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>4</span>), (<span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>9</span>), 
</span></span><span style=display:flex><span>           (<span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>8</span>), (<span style=color:#ae81ff>189</span>, <span style=color:#ae81ff>3</span>), 
</span></span><span style=display:flex><span>           (<span style=color:#ae81ff>2000</span>, <span style=color:#ae81ff>98</span>), (<span style=color:#ae81ff>2001</span>, <span style=color:#ae81ff>3</span>),
</span></span><span style=display:flex><span>           (<span style=color:#66d9ef>null</span>::int, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>           (<span style=color:#66d9ef>null</span>, <span style=color:#ae81ff>9</span>)
</span></span><span style=display:flex><span>           ),
</span></span><span style=display:flex><span>binned <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span>  width_bucket (deltas.delta::float, array[
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>150</span>,<span style=color:#ae81ff>200</span>, <span style=color:#ae81ff>2000</span>]::float[] ) <span style=color:#66d9ef>as</span> bin, 
</span></span><span style=display:flex><span>    deltas.delta, deltas.countt
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>from</span> deltas 
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> delta, countt, bin  <span style=color:#75715e>-- sum(countt) 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>from</span> binned 
</span></span></code></pre></div><table><thead><tr><th>delta</th><th>countt</th><th>bin</th></tr></thead><tbody><tr><td>-1</td><td>3</td><td>0</td></tr><tr><td>0</td><td>4</td><td>1</td></tr><tr><td>19</td><td>9</td><td>1</td></tr><tr><td>50</td><td>2</td><td>2</td></tr><tr><td>2</td><td>8</td><td>1</td></tr><tr><td>189</td><td>3</td><td>4</td></tr><tr><td>2,000</td><td>98</td><td>6</td></tr><tr><td>2,001</td><td>3</td><td>6</td></tr><tr><td>[NULL]</td><td>2</td><td>[NULL]</td></tr><tr><td>[NULL]</td><td>9</td><td>[NULL]</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> deltas(delta, countt) <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>values</span> (<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>3</span>), (<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>4</span>), (<span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>9</span>), 
</span></span><span style=display:flex><span>           (<span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>8</span>), (<span style=color:#ae81ff>189</span>, <span style=color:#ae81ff>3</span>), 
</span></span><span style=display:flex><span>           (<span style=color:#ae81ff>77</span>, <span style=color:#ae81ff>98</span>), (<span style=color:#ae81ff>178</span>, <span style=color:#ae81ff>3</span>)),
</span></span><span style=display:flex><span>binned <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span>  width_bucket (deltas.delta::float, array[
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>0</span>::float, <span style=color:#ae81ff>50</span>::float, <span style=color:#ae81ff>100</span>::float, <span style=color:#ae81ff>150</span>::float,<span style=color:#ae81ff>200</span>::float, <span style=color:#ae81ff>2000</span>::float] ) <span style=color:#66d9ef>as</span> bin, 
</span></span><span style=display:flex><span>    deltas.delta, deltas.countt
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>from</span> deltas 
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> bin, <span style=color:#66d9ef>sum</span>(countt) 
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> binned
</span></span><span style=display:flex><span><span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> bin 
</span></span><span style=display:flex><span><span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> bin
</span></span></code></pre></div><table><thead><tr><th>bin</th><th>sum</th></tr></thead><tbody><tr><td>1</td><td>24</td></tr><tr><td>2</td><td>100</td></tr><tr><td>4</td><td>6</td></tr></tbody></table><h4 id=auto-make-that-markdown-table-header-line>auto make that markdown table header line<a hidden class=anchor aria-hidden=true href=#auto-make-that-markdown-table-header-line>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_table_header_line</span>(header):
</span></span><span style=display:flex><span>    dashes <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;--&#39;</span> <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> header<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;|&#39;</span>)]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;|&#39;</span><span style=color:#f92672>.</span>join(dashes)
</span></span><span style=display:flex><span>    
</span></span></code></pre></div><h4 id=list-constraints>list constraints<a hidden class=anchor aria-hidden=true href=#list-constraints>#</a></h4><ul><li>from <a href=https://dba.stackexchange.com/a/214877>stack overflow</a> &mldr;</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> con.<span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>FROM</span> pg_catalog.pg_constraint con
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> pg_catalog.pg_class rel
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>ON</span> rel.oid <span style=color:#f92672>=</span> con.conrelid
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> pg_catalog.pg_namespace nsp
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>ON</span> nsp.oid <span style=color:#f92672>=</span> connamespace
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>WHERE</span> nsp.nspname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&lt;schema name&gt;&#39;</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>AND</span> rel.relname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&lt;table name&gt;&#39;</span>;
</span></span></code></pre></div><ul><li>Oh wow&mldr; also this section from the <a href=https://www.postgresql.org/docs/9.6/sql-altertable.html>ALTER TABLE ADD CONSTRAINT postgresql doc</a> was super useful/well written..</li></ul><blockquote><p><em>Scanning a large table to verify a new foreign key or check constraint can take a long time, and other updates to the table are locked out until the <code>ALTER TABLE ADD CONSTRAINT</code> command is committed. The main purpose of the <code>NOT VALID</code> constraint option is to reduce the impact of adding a constraint on concurrent updates. With <code>NOT VALID</code>, the <code>ADD CONSTRAINT</code> command does not scan the table and can be committed immediately. After that, a VALIDATE CONSTRAINT command can be issued to verify that existing rows satisfy the constraint. The validation step does not need to lock out concurrent updates, since it knows that other transactions will be enforcing the constraint for rows that they insert or update; only pre-existing rows need to be checked. Hence, validation acquires only a <code>SHARE UPDATE EXCLUSIVE</code> lock on the table being altered. (If the constraint is a foreign key then a ROW SHARE lock is also required on the table referenced by the constraint.) In addition to improving concurrency, it can be useful to use <code>NOT VALID</code> and <code>VALIDATE CONSTRAINT</code> in cases where the table is known to contain pre-existing violations. Once the constraint is in place, no new violations can be inserted, and the existing problems can be corrected <em>at leisure</em> until <code>VALIDATE CONSTRAINT</code> finally succeeds.</em></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- step one.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span>    the_table_name
</span></span><span style=display:flex><span><span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>constraint</span> the_constraint_name <span style=color:#66d9ef>unique</span> (col1, col2) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>VALID</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- step two..
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> the_table_name
</span></span><span style=display:flex><span>    VALIDATE <span style=color:#66d9ef>CONSTRAINT</span> the_constraint_name
</span></span></code></pre></div><h4 id=having>Having<a hidden class=anchor aria-hidden=true href=#having>#</a></h4><ul><li>Interesting conditional syntax aroung group by , without using a CTE&mldr;</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> id, <span style=color:#66d9ef>key</span>  , <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>) countt
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> my_table
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> id, <span style=color:#66d9ef>key</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>having</span> <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><ul><li>=></li></ul><table><thead><tr><th>id</th><th>key</th><th>countt</th></tr></thead><tbody><tr><td>1</td><td>foo</td><td>2</td></tr><tr><td>2</td><td>bar</td><td>3</td></tr></tbody></table><h4 id=invalid-input-syntax-for-integer>invalid input syntax for integer<a hidden class=anchor aria-hidden=true href=#invalid-input-syntax-for-integer>#</a></h4><ul><li>Having come across this a few times, writing down here..</li></ul><pre tabindex=0><code>InvalidTextRepresentation: invalid input syntax for integer: &#34;&#34;
</code></pre><ul><li>This typically means a blank string is being coaxed as an integer somewhere.</li><li>The solution is basically to find these and make sure they&rsquo;re nulls on the db.</li><li>And can also partition with an <code>id</code> column too for example, to do a little at a time to experiment.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>update</span> mytable
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>set</span> blahcol <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span>  blahcol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>and</span> ( id <span style=color:#66d9ef>between</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>and</span> <span style=color:#ae81ff>100000</span>)
</span></span></code></pre></div><h4 id=a-warning-about-ctes>A warning about CTEs<a hidden class=anchor aria-hidden=true href=#a-warning-about-ctes>#</a></h4><ul><li>Per <a href=https://hakibenita.medium.com/be-careful-with-cte-in-postgresql-fca5e24d2119>this article</a> , postgresql will run full CTE and store it, which is why I feel the only practical way of using CTEs in large expressions is along with partitioning .</li><li>In other words, although most postgresql queries will be able to run only the first <code>200</code> rows like a &ldquo;generator&rdquo; and return that to you really quickly, when you have a CTE in there, it has to run the whole thing first.</li></ul><h4 id=triggers>Triggers<a hidden class=anchor aria-hidden=true href=#triggers>#</a></h4><ul><li>Per <a href=https://serverfault.com/questions/331024/how-can-i-show-the-content-of-a-trigger-with-psql>here</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>trigger_schema</span>,event_object_table,<span style=color:#66d9ef>trigger_schema</span>,<span style=color:#66d9ef>trigger_name</span>,event_manipulation,action_statement,action_timing 
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> information_schema.triggers 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> event_object_table,event_manipulation
</span></span></code></pre></div><h4 id=using-window-function-to-dedupe-some-data>Using window function to dedupe some data<a hidden class=anchor aria-hidden=true href=#using-window-function-to-dedupe-some-data>#</a></h4><ul><li>Given some rows like</li></ul><table><thead><tr><th>user_id</th><th>laptop</th><th>purchase_date</th></tr></thead><tbody><tr><td>1</td><td>sony</td><td>1</td></tr><tr><td>1</td><td>nokia</td><td>2</td></tr><tr><td>1</td><td>bell</td><td>3</td></tr><tr><td>2</td><td>3m</td><td>2</td></tr><tr><td>2</td><td>nokia</td><td>8</td></tr></tbody></table><ul><li>If we want to dedupe by this simplified integer <code>purchase_date</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> laptops(user_id, laptop, purchase_date) <span style=color:#66d9ef>as</span>  (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>values</span> (<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;sony&#39;</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>           (<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;nokia&#39;</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>           (<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;bell&#39;</span>, <span style=color:#ae81ff>3</span>),
</span></span><span style=display:flex><span>           (<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;3m&#39;</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>           (<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;nokia&#39;</span>, <span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> l.<span style=color:#f92672>*</span>, row_number() over w <span style=color:#66d9ef>as</span> rnum
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> laptops <span style=color:#66d9ef>as</span> l
</span></span><span style=display:flex><span>window w <span style=color:#66d9ef>as</span> (partition <span style=color:#66d9ef>by</span> l.user_id <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> purchase_date <span style=color:#66d9ef>asc</span> )
</span></span></code></pre></div><table><thead><tr><th>user_id</th><th>laptop</th><th>purchase_date</th><th>rnum</th></tr></thead><tbody><tr><td>1</td><td>sony</td><td>1</td><td>1</td></tr><tr><td>1</td><td>nokia</td><td>2</td><td>2</td></tr><tr><td>1</td><td>bell</td><td>3</td><td>3</td></tr><tr><td>2</td><td>3m</td><td>2</td><td>1</td></tr><tr><td>2</td><td>nokia</td><td>8</td><td>2</td></tr></tbody></table><p>And then keep only the <code>rnum = 1</code> &mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> laptops(user_id, laptop, purchase_date) <span style=color:#66d9ef>as</span>  (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>values</span> (<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;sony&#39;</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>           (<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;nokia&#39;</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>           (<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;bell&#39;</span>, <span style=color:#ae81ff>3</span>),
</span></span><span style=display:flex><span>           (<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;3m&#39;</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>           (<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;nokia&#39;</span>, <span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>),
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> aa.<span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> 
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> l.<span style=color:#f92672>*</span>, row_number() over w <span style=color:#66d9ef>as</span> rnum
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>from</span> laptops <span style=color:#66d9ef>as</span> l
</span></span><span style=display:flex><span>    window w <span style=color:#66d9ef>as</span> (partition <span style=color:#66d9ef>by</span> l.user_id <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> purchase_date <span style=color:#66d9ef>asc</span> )
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>as</span> aa
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span> aa.rnum <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><table><thead><tr><th>user_id</th><th>laptop</th><th>purchase_date</th><th>rnum</th></tr></thead><tbody><tr><td>1</td><td>sony</td><td>1</td><td>1</td></tr><tr><td>2</td><td>3m</td><td>2</td><td>1</td></tr></tbody></table><h4 id=length-of-an-array--is-cardinality>length of an array is cardinality<a hidden class=anchor aria-hidden=true href=#length-of-an-array--is-cardinality>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#66d9ef>cardinality</span>(ARRAY[[<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>],[<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>4</span>]])
</span></span></code></pre></div><pre tabindex=0><code>4
</code></pre><h4 id=logistic>logistic<a hidden class=anchor aria-hidden=true href=#logistic>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>replace</span> <span style=color:#66d9ef>FUNCTION</span> myschema.logistic(val float) <span style=color:#66d9ef>RETURNS</span> float <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>BEGIN</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>RETURN</span> (<span style=color:#ae81ff>1</span><span style=color:#f92672>/</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> ( exp(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>^</span>(<span style=color:#f92672>-</span>(val))))) ;
</span></span><span style=display:flex><span><span style=color:#66d9ef>END</span>; <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>LANGUAGE</span> PLPGSQL;
</span></span></code></pre></div><h4 id=left-join-two-tables-with-an-extra-condition-and-keep-the-null-join-rows>left join two tables with an extra condition and keep the null join rows<a hidden class=anchor aria-hidden=true href=#left-join-two-tables-with-an-extra-condition-and-keep-the-null-join-rows>#</a></h4><ul><li>This was bothering me for a bit but I think I have found the solution multiple times now.</li><li>Writing this out for later</li><li>In this example, there are authors and authors can have one or multiple articles. Self Join articles , to get multiple articles, but only where the left id is less than the right id.</li><li>This is a contrived example, but my use case typically is not a self join but a join with different tables, but the idea still holds.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> articles(author, article_id, article_title) <span style=color:#66d9ef>as</span> (<span style=color:#66d9ef>values</span> 
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;joe&#39;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;birds&#39;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;joe&#39;</span>, <span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;more birds&#39;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;sally&#39;</span>, <span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#39;eagles&#39;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;sally&#39;</span>, <span style=color:#ae81ff>4</span>, <span style=color:#e6db74>&#39;seagulls&#39;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;jan&#39;</span>, <span style=color:#ae81ff>5</span>, <span style=color:#e6db74>&#39;the philosophical of flying&#39;</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> a.author, a.article_id <span style=color:#66d9ef>as</span> left_id, a.article_title <span style=color:#66d9ef>as</span> left_title, b.article_id <span style=color:#66d9ef>as</span> right_id, b.article_title <span style=color:#66d9ef>as</span> right_title
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> articles <span style=color:#66d9ef>as</span> a <span style=color:#66d9ef>left</span> <span style=color:#66d9ef>join</span> articles <span style=color:#66d9ef>as</span> b <span style=color:#66d9ef>on</span> (a.author <span style=color:#f92672>=</span> b.author <span style=color:#66d9ef>and</span> a.article_id <span style=color:#f92672>&lt;</span> b.article_id)
</span></span></code></pre></div><table><thead><tr><th>author</th><th>left_id</th><th>left_title</th><th>right_id</th><th>right_title</th></tr></thead><tbody><tr><td>joe</td><td>1</td><td>birds</td><td>2</td><td>more birds</td></tr><tr><td>joe</td><td>2</td><td>more birds</td><td>[NULL]</td><td>[NULL]</td></tr><tr><td>sally</td><td>3</td><td>eagles</td><td>4</td><td>seagulls</td></tr><tr><td>sally</td><td>4</td><td>seagulls</td><td>[NULL]</td><td>[NULL]</td></tr><tr><td>jan</td><td>5</td><td>the philosophical of flying</td><td>[NULL]</td><td>[NULL]</td></tr></tbody></table></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://michal.piekarczyk.xyz/>michal.piekarczyk.xyz</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>