<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Visualizing time of day and birth year | michal.piekarczyk.xyz</title>
<meta name=keywords content><meta name=description content="This is a mini post part of this project. (Originally posted here ).
Take a quick look at time of day distribution import matplotlib.pyplot as plt import numpy as np import pandas as pd datadir = '/opt/data' localdir = '/opt/program' tripsdf = pd.read_csv(f'{datadir}/2013-07 - Citi Bike trip data.csv') stationsdf = pd.read_csv(f'{localdir}/datas/stations/stations-2018-12-04-c.csv', index_col=0) tripsdf.iloc[0] tripduration 634 starttime 2013-07-01 00:00:00 stoptime 2013-07-01 00:10:34 start station id 164 start station name E 47 St & 2 Ave start station latitude 40."><meta name=author content="Michal Piekarczyk"><link rel=canonical href=https://michal.piekarczyk.xyz/post/2020-10-22-features-v3/><link crossorigin=anonymous href=/assets/css/stylesheet.dd867d536fb6202811c1ee15fa181ef8945826662b49d3016ac91365a2621d58.css integrity="sha256-3YZ9U2+2ICgRwe4V+hge+JRYJmYrSdMBaskTZaJiHVg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://michal.piekarczyk.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://michal.piekarczyk.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://michal.piekarczyk.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://michal.piekarczyk.xyz/apple-touch-icon.png><link rel=mask-icon href=https://michal.piekarczyk.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-74MK08REDT"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-74MK08REDT",{anonymize_ip:!1})}</script><meta property="og:title" content="Visualizing time of day and birth year"><meta property="og:description" content="This is a mini post part of this project. (Originally posted here ).
Take a quick look at time of day distribution import matplotlib.pyplot as plt import numpy as np import pandas as pd datadir = '/opt/data' localdir = '/opt/program' tripsdf = pd.read_csv(f'{datadir}/2013-07 - Citi Bike trip data.csv') stationsdf = pd.read_csv(f'{localdir}/datas/stations/stations-2018-12-04-c.csv', index_col=0) tripsdf.iloc[0] tripduration 634 starttime 2013-07-01 00:00:00 stoptime 2013-07-01 00:10:34 start station id 164 start station name E 47 St & 2 Ave start station latitude 40."><meta property="og:type" content="article"><meta property="og:url" content="https://michal.piekarczyk.xyz/post/2020-10-22-features-v3/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-10-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-26T18:33:54-05:00"><meta property="og:site_name" content="michal.piekarczyk.xyz"><meta name=twitter:card content="summary"><meta name=twitter:title content="Visualizing time of day and birth year"><meta name=twitter:description content="This is a mini post part of this project. (Originally posted here ).
Take a quick look at time of day distribution import matplotlib.pyplot as plt import numpy as np import pandas as pd datadir = '/opt/data' localdir = '/opt/program' tripsdf = pd.read_csv(f'{datadir}/2013-07 - Citi Bike trip data.csv') stationsdf = pd.read_csv(f'{localdir}/datas/stations/stations-2018-12-04-c.csv', index_col=0) tripsdf.iloc[0] tripduration 634 starttime 2013-07-01 00:00:00 stoptime 2013-07-01 00:10:34 start station id 164 start station name E 47 St & 2 Ave start station latitude 40."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://michal.piekarczyk.xyz/post/"},{"@type":"ListItem","position":2,"name":"Visualizing time of day and birth year","item":"https://michal.piekarczyk.xyz/post/2020-10-22-features-v3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Visualizing time of day and birth year","name":"Visualizing time of day and birth year","description":"This is a mini post part of this project. (Originally posted here ).\nTake a quick look at time of day distribution import matplotlib.pyplot as plt import numpy as np import pandas as pd datadir = \u0026#39;/opt/data\u0026#39; localdir = \u0026#39;/opt/program\u0026#39; tripsdf = pd.read_csv(f\u0026#39;{datadir}/2013-07 - Citi Bike trip data.csv\u0026#39;) stationsdf = pd.read_csv(f\u0026#39;{localdir}/datas/stations/stations-2018-12-04-c.csv\u0026#39;, index_col=0) tripsdf.iloc[0] tripduration 634 starttime 2013-07-01 00:00:00 stoptime 2013-07-01 00:10:34 start station id 164 start station name E 47 St \u0026amp; 2 Ave start station latitude 40.","keywords":[],"articleBody":"This is a mini post part of this project. (Originally posted here ).\nTake a quick look at time of day distribution import matplotlib.pyplot as plt import numpy as np import pandas as pd datadir = '/opt/data' localdir = '/opt/program' tripsdf = pd.read_csv(f'{datadir}/2013-07 - Citi Bike trip data.csv') stationsdf = pd.read_csv(f'{localdir}/datas/stations/stations-2018-12-04-c.csv', index_col=0) tripsdf.iloc[0] tripduration 634 starttime 2013-07-01 00:00:00 stoptime 2013-07-01 00:10:34 start station id 164 start station name E 47 St \u0026 2 Ave start station latitude 40.7532 start station longitude -73.9703 end station id 504 end station name 1 Ave \u0026 E 15 St end station latitude 40.7322 end station longitude -73.9817 bikeid 16950 usertype Customer birth year \\N gender 0 Name: 0, dtype: object tripsdf['starttime'].map(lambda x: x[11:13]).iloc[:10] 0 00 1 00 2 00 3 00 4 00 5 00 6 00 7 00 8 00 9 00 Name: starttime, dtype: object tripsdf['hour'] = tripsdf['starttime'].map(lambda x: x[11:13]) # For all time looks like maybe two peaks fig = plt.figure(figsize=(6, 6)) fig.patch.set_facecolor('xkcd:mint green') ax = fig.add_subplot(111, ) ax.hist(tripsdf.hour.tolist(), bins=24) plt.grid(True) # Perhaps on weekdays different? import fresh.utils as fu fu.prepare_weekday_feature(tripsdf) fig = plt.figure(figsize=(6, 6)) fig.patch.set_facecolor('xkcd:mint green') ax = fig.add_subplot(111, ) ax.hist(tripsdf[tripsdf.weekday == True].hour.tolist(), bins=24) ax.set_title('Weekday hour histogram') plt.grid(True) # Weekend wow big difference. fig = plt.figure(figsize=(6, 6)) fig.patch.set_facecolor('xkcd:mint green') ax = fig.add_subplot(111, ) ax.hist(tripsdf[tripsdf.weekday == False].hour.tolist(), bins=24) ax.set_title('Weekend hour histogram') plt.grid(True) # Ok based on the above, going to create a version 2... # time_of_day_v2_peaky # Not sure how to account for the different peaks on weekends # # 0: 6-10, 1: 11-15, 2: 16-20, 3: 21-00, 00-5 Age Somehow I did not include age this time around but I should. tripsdf[['usertype', 'birth year']].iloc[:5] .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } # Ok should basically fill these as np.nan for 'Customer' dict(tripsdf[tripsdf.usertype=='Customer']['birth year'].value_counts()) {'\\\\N': 174887, '1995': 28} # Luckily no nulls tripsdf[(tripsdf.usertype=='Subscriber')\u0026 (tripsdf['birth year'].isnull())].shape (0, 18) def make_xtick_labels(x, step=5): '''Given x, step the labels every Aka, take every th x label ''' x_ticks = [i for i in range(len(x)) if i % step == 0] x_labels = [x[i] for i in x_ticks] return x_ticks, x_labels import numpy as np tripsdf['birth year'] = tripsdf['birth year'].map(lambda x:int(x) if x != '\\\\N' else np.nan ) # Discard below 1913 as np.nan. TODO tripsdf[(tripsdf.usertype=='Subscriber')\u0026 (tripsdf['birth year'] \u003c 1913)].shape (226, 18) X = [x for x in tripsdf[(tripsdf.usertype == 'Subscriber')]['birth year'].tolist() if x \u003e 1913] print(len(X)) fig = plt.figure(figsize=(12, 6)) fig.patch.set_facecolor('xkcd:mint green') ax = fig.add_subplot(111, ) ax.hist(X[:10000], bins=70) # x_ticks, x_labels = make_xtick_labels(x[:1000], step=20) # ax.set_xticks(x_ticks) # ax.set_xticklabels(x_labels, rotation=-45) ax.set_title('Birth year binned (2013-07)') plt.grid(True) fig.show() 668262 # Ok this seems normal ish. so might as well just split somewhat arbitrarily or evenly def get_quantiles(unsorted): data = sorted(unsorted) minimum = data[0] Q1 = np.percentile(data, 25, interpolation = 'midpoint') median = np.median(data) Q3 = np.percentile(data, 75, interpolation = 'midpoint') maximum = data[-1] return [minimum, Q1, median, Q3, maximum] def show_da_stats(bundle): H, bins = bundle['hist'] quantiles = bundle['quantiles'] fig = plt.figure(figsize=(12, 6)) fig.patch.set_facecolor('xkcd:mint green') ax = fig.add_subplot(111, ) ax.scatter(quantiles, [1, 1, 1, 1, 1]) ax.axvline(quantiles[1], label='q:25%') ax.axvline(quantiles[2], label='q:50%') ax.axvline(quantiles[3], label='q:75%') ax.set_title(bundle['title']) ax.plot(bins, np.insert(H, 0, H[0]), drawstyle='steps', color='green') plt.grid(True) fig.legend() fig.show() # hist = np.histogram(X, bins=100, range=None) quantiles = get_quantiles(X) bundle = {'hist': hist, 'quantiles': quantiles, 'title': 'Birth year binned (2013-07)'} print('quantiles', quantiles) show_da_stats(bundle) quantiles [1920.0, 1969.0, 1978.0, 1984.0, 1997.0] # And the age quantiles to make this a year independent feature.. 2013 - np.array([1920.0, 1969.0, 1978.0, 1984.0, 1997.0]) array([93., 44., 35., 29., 16.]) import datetime; import pytz x = dict(tripsdf.iloc[2]) x (x['start_dt'] - datetime.datetime(int(x['birth year']), 1, 1, tzinfo=pytz.timezone('US/Eastern')) ).days/365. , (x['start_dt'] - np.nan) --------------------------------------------------------------------------- TypeError Traceback (most recent call last) in 5 (x['start_dt'] - 6 datetime.datetime(int(x['birth year']), 1, 1, tzinfo=pytz.timezone('US/Eastern')) ----\u003e 7 ).days/365. , (x['start_dt'] - np.nan) TypeError: unsupported operand type(s) for -: 'Timestamp' and 'float' x['start_dt'] - pd.NaT NaT # Reload once again since I modified a col tripsdf = pd.read_csv(f'{datadir}/2013-07 - Citi Bike trip data.csv') reload(fu) minidf = tripsdf.iloc[:1000].copy() fu.prepare_weekday_feature(minidf) fu.age_feature(minidf) list(reversed([93., 44., 35., 29., 16.])) [16.0, 29.0, 35.0, 44.0, 93.0] minidf['birth_bin'] = pd.cut(minidf['age'], bins=[16.0, 29.0, 35.0, 44.0, 93.0], labels=[0, 1, 2, 3]) minidf[['age', 'birth', 'birth_bin']].iloc[:10] .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } Prepare to build the v3 proc bundle I have a nice reference for testing And for building, I need to do some reverse engineering to maintain the train/test split from earlier. import fresh.predict_utils as fpu bundle = fpu.load_bundle_in_docker() Loading from bundle_loc /opt/ml/model/all_bundle_with_stationsdf.joblib print('original proc bundle notebook', bundle['proc_bundle']['bundle']['notebook']) bundle['proc_bundle']['bundle']['proc_bundle'].keys() print('this is the bundle glue notebook, cool', bundle['notebook']) print('model notebook', bundle['model_bundle']['bundle']['notebook']) print('train', bundle['model_bundle']['bundle']['train']) print('test', bundle['model_bundle']['bundle']['validation_metrics']['test']) original proc bundle notebook 2020-07-03-aws.ipynb this is the bundle glue notebook, cool 2020-08-18-glue.ipynb model notebook 2020-07-10-aws.ipynb train /home/ec2-user/SageMaker/learn-citibike/artifacts/2020-07-08T143732Z/train.libsvm test /home/ec2-user/SageMaker/learn-citibike/artifacts/2020-07-08T143732Z/test.libsvm import fresh.preproc.v3 as pv3 !pwd ","wordCount":"784","inLanguage":"en","datePublished":"2020-10-22T00:00:00Z","dateModified":"2023-02-26T18:33:54-05:00","author":{"@type":"Person","name":"Michal Piekarczyk"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://michal.piekarczyk.xyz/post/2020-10-22-features-v3/"},"publisher":{"@type":"Organization","name":"michal.piekarczyk.xyz","logo":{"@type":"ImageObject","url":"https://michal.piekarczyk.xyz/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://michal.piekarczyk.xyz/ accesskey=h title="michal.piekarczyk.xyz (Alt + H)">michal.piekarczyk.xyz</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://michal.piekarczyk.xyz/post/ title=posts><span>posts</span></a></li><li><a href=https://michal.piekarczyk.xyz/project/ title=projects><span>projects</span></a></li><li><a href=https://michal.piekarczyk.xyz/handy/ title=handy><span>handy</span></a></li><li><a href=https://michal.piekarczyk.xyz/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://michal.piekarczyk.xyz/about/ title=about><span>about</span></a></li><li><a href=https://world.hey.com/michal.piekarczyk title=frivolity><span>frivolity</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://michal.piekarczyk.xyz/>Home</a>&nbsp;»&nbsp;<a href=https://michal.piekarczyk.xyz/post/>Posts</a></div><h1 class=post-title>Visualizing time of day and birth year</h1><div class=post-meta>&lt;span title='2020-10-22 00:00:00 +0000 UTC'>October 22, 2020&lt;/span>&amp;nbsp;·&amp;nbsp;4 min&amp;nbsp;·&amp;nbsp;784 words&amp;nbsp;·&amp;nbsp;Michal Piekarczyk</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li></li></ul></li></ul></nav></div></details></div><div class=post-content><p>This is a mini post part of <a href=/project/2020-10-20-bike-share-learn-reboot/>this project</a>. (Originally posted <a href=https://github.com/namoopsoo/learn-citibike/blob/master/notes/2020-10-22-features-v3.md>here</a> ).</p><h4 id=take-a-quick-look-at-time-of-day-distribution>Take a quick look at time of day distribution<a hidden class=anchor aria-hidden=true href=#take-a-quick-look-at-time-of-day-distribution>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> matplotlib.pyplot <span style=color:#66d9ef>as</span> plt
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>datadir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/opt/data&#39;</span>
</span></span><span style=display:flex><span>localdir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/opt/program&#39;</span>
</span></span><span style=display:flex><span>tripsdf <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>datadir<span style=color:#e6db74>}</span><span style=color:#e6db74>/2013-07 - Citi Bike trip data.csv&#39;</span>)
</span></span><span style=display:flex><span>stationsdf <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>localdir<span style=color:#e6db74>}</span><span style=color:#e6db74>/datas/stations/stations-2018-12-04-c.csv&#39;</span>,
</span></span><span style=display:flex><span>                        index_col<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>tripsdf<span style=color:#f92672>.</span>iloc[<span style=color:#ae81ff>0</span>]
</span></span></code></pre></div><pre><code>tripduration                               634
starttime                  2013-07-01 00:00:00
stoptime                   2013-07-01 00:10:34
start station id                           164
start station name             E 47 St &amp; 2 Ave
start station latitude                 40.7532
start station longitude               -73.9703
end station id                             504
end station name               1 Ave &amp; E 15 St
end station latitude                   40.7322
end station longitude                 -73.9817
bikeid                                   16950
usertype                              Customer
birth year                                  \N
gender                                       0
Name: 0, dtype: object
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>tripsdf[<span style=color:#e6db74>&#39;starttime&#39;</span>]<span style=color:#f92672>.</span>map(<span style=color:#66d9ef>lambda</span> x: x[<span style=color:#ae81ff>11</span>:<span style=color:#ae81ff>13</span>])<span style=color:#f92672>.</span>iloc[:<span style=color:#ae81ff>10</span>]
</span></span></code></pre></div><pre><code>0    00
1    00
2    00
3    00
4    00
5    00
6    00
7    00
8    00
9    00
Name: starttime, dtype: object
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>tripsdf[<span style=color:#e6db74>&#39;hour&#39;</span>] <span style=color:#f92672>=</span> tripsdf[<span style=color:#e6db74>&#39;starttime&#39;</span>]<span style=color:#f92672>.</span>map(<span style=color:#66d9ef>lambda</span> x: x[<span style=color:#ae81ff>11</span>:<span style=color:#ae81ff>13</span>])
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># For all time looks like maybe two peaks</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fig <span style=color:#f92672>=</span> plt<span style=color:#f92672>.</span>figure(figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>6</span>))
</span></span><span style=display:flex><span>fig<span style=color:#f92672>.</span>patch<span style=color:#f92672>.</span>set_facecolor(<span style=color:#e6db74>&#39;xkcd:mint green&#39;</span>)
</span></span><span style=display:flex><span>ax <span style=color:#f92672>=</span> fig<span style=color:#f92672>.</span>add_subplot(<span style=color:#ae81ff>111</span>, )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ax<span style=color:#f92672>.</span>hist(tripsdf<span style=color:#f92672>.</span>hour<span style=color:#f92672>.</span>tolist(), bins<span style=color:#f92672>=</span><span style=color:#ae81ff>24</span>)
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>grid(<span style=color:#66d9ef>True</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Perhaps on weekdays different?</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> fresh.utils <span style=color:#66d9ef>as</span> fu
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fu<span style=color:#f92672>.</span>prepare_weekday_feature(tripsdf)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>fig <span style=color:#f92672>=</span> plt<span style=color:#f92672>.</span>figure(figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>6</span>))
</span></span><span style=display:flex><span>fig<span style=color:#f92672>.</span>patch<span style=color:#f92672>.</span>set_facecolor(<span style=color:#e6db74>&#39;xkcd:mint green&#39;</span>)
</span></span><span style=display:flex><span>ax <span style=color:#f92672>=</span> fig<span style=color:#f92672>.</span>add_subplot(<span style=color:#ae81ff>111</span>, )
</span></span><span style=display:flex><span>ax<span style=color:#f92672>.</span>hist(tripsdf[tripsdf<span style=color:#f92672>.</span>weekday <span style=color:#f92672>==</span> <span style=color:#66d9ef>True</span>]<span style=color:#f92672>.</span>hour<span style=color:#f92672>.</span>tolist(), bins<span style=color:#f92672>=</span><span style=color:#ae81ff>24</span>)
</span></span><span style=display:flex><span>ax<span style=color:#f92672>.</span>set_title(<span style=color:#e6db74>&#39;Weekday hour histogram&#39;</span>)
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>grid(<span style=color:#66d9ef>True</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Weekend wow big difference. </span>
</span></span><span style=display:flex><span>fig <span style=color:#f92672>=</span> plt<span style=color:#f92672>.</span>figure(figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>6</span>))
</span></span><span style=display:flex><span>fig<span style=color:#f92672>.</span>patch<span style=color:#f92672>.</span>set_facecolor(<span style=color:#e6db74>&#39;xkcd:mint green&#39;</span>)
</span></span><span style=display:flex><span>ax <span style=color:#f92672>=</span> fig<span style=color:#f92672>.</span>add_subplot(<span style=color:#ae81ff>111</span>, )
</span></span><span style=display:flex><span>ax<span style=color:#f92672>.</span>hist(tripsdf[tripsdf<span style=color:#f92672>.</span>weekday <span style=color:#f92672>==</span> <span style=color:#66d9ef>False</span>]<span style=color:#f92672>.</span>hour<span style=color:#f92672>.</span>tolist(), bins<span style=color:#f92672>=</span><span style=color:#ae81ff>24</span>)
</span></span><span style=display:flex><span>ax<span style=color:#f92672>.</span>set_title(<span style=color:#e6db74>&#39;Weekend hour histogram&#39;</span>)
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>grid(<span style=color:#66d9ef>True</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Ok based on the above, going to create a version 2...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># time_of_day_v2_peaky</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Not sure how to account for the different peaks on weekends</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     # 0: 6-10, 1: 11-15, 2: 16-20, 3: 21-00, 00-5</span>
</span></span></code></pre></div><h4 id=age>Age<a hidden class=anchor aria-hidden=true href=#age>#</a></h4><ul><li>Somehow I did not include age this time around but I should.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>tripsdf[[<span style=color:#e6db74>&#39;usertype&#39;</span>, <span style=color:#e6db74>&#39;birth year&#39;</span>]]<span style=color:#f92672>.</span>iloc[:<span style=color:#ae81ff>5</span>]
</span></span></code></pre></div><pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre><p></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Ok should basically fill these as np.nan for &#39;Customer&#39;</span>
</span></span><span style=display:flex><span>dict(tripsdf[tripsdf<span style=color:#f92672>.</span>usertype<span style=color:#f92672>==</span><span style=color:#e6db74>&#39;Customer&#39;</span>][<span style=color:#e6db74>&#39;birth year&#39;</span>]<span style=color:#f92672>.</span>value_counts())
</span></span></code></pre></div><pre><code>{'\\N': 174887, '1995': 28}
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Luckily no nulls</span>
</span></span><span style=display:flex><span>tripsdf[(tripsdf<span style=color:#f92672>.</span>usertype<span style=color:#f92672>==</span><span style=color:#e6db74>&#39;Subscriber&#39;</span>)<span style=color:#f92672>&amp;</span> (tripsdf[<span style=color:#e6db74>&#39;birth year&#39;</span>]<span style=color:#f92672>.</span>isnull())]<span style=color:#f92672>.</span>shape
</span></span></code></pre></div><pre><code>(0, 18)
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_xtick_labels</span>(x, step<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Given x, step the labels every &lt;step&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Aka, take every &lt;step&gt;th x label
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    x_ticks <span style=color:#f92672>=</span> [i <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span>  range(len(x)) <span style=color:#66d9ef>if</span> i <span style=color:#f92672>%</span> step <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    x_labels <span style=color:#f92672>=</span> [x[i] <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> x_ticks]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x_ticks, x_labels
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>tripsdf[<span style=color:#e6db74>&#39;birth year&#39;</span>] <span style=color:#f92672>=</span> tripsdf[<span style=color:#e6db74>&#39;birth year&#39;</span>]<span style=color:#f92672>.</span>map(<span style=color:#66d9ef>lambda</span> x:int(x) <span style=color:#66d9ef>if</span> x <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>N&#39;</span> <span style=color:#66d9ef>else</span> np<span style=color:#f92672>.</span>nan )
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Discard below 1913 as np.nan. TODO</span>
</span></span><span style=display:flex><span>tripsdf[(tripsdf<span style=color:#f92672>.</span>usertype<span style=color:#f92672>==</span><span style=color:#e6db74>&#39;Subscriber&#39;</span>)<span style=color:#f92672>&amp;</span> (tripsdf[<span style=color:#e6db74>&#39;birth year&#39;</span>] <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1913</span>)]<span style=color:#f92672>.</span>shape
</span></span></code></pre></div><pre><code>(226, 18)
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>X <span style=color:#f92672>=</span> [x <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> tripsdf[(tripsdf<span style=color:#f92672>.</span>usertype <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Subscriber&#39;</span>)][<span style=color:#e6db74>&#39;birth year&#39;</span>]<span style=color:#f92672>.</span>tolist()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> x <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1913</span>]
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(len(X))
</span></span><span style=display:flex><span>fig <span style=color:#f92672>=</span> plt<span style=color:#f92672>.</span>figure(figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>6</span>))
</span></span><span style=display:flex><span>fig<span style=color:#f92672>.</span>patch<span style=color:#f92672>.</span>set_facecolor(<span style=color:#e6db74>&#39;xkcd:mint green&#39;</span>)
</span></span><span style=display:flex><span>ax <span style=color:#f92672>=</span> fig<span style=color:#f92672>.</span>add_subplot(<span style=color:#ae81ff>111</span>, )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ax<span style=color:#f92672>.</span>hist(X[:<span style=color:#ae81ff>10000</span>], bins<span style=color:#f92672>=</span><span style=color:#ae81ff>70</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># x_ticks, x_labels = make_xtick_labels(x[:1000], step=20)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ax.set_xticks(x_ticks)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ax.set_xticklabels(x_labels, rotation=-45)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ax<span style=color:#f92672>.</span>set_title(<span style=color:#e6db74>&#39;Birth year binned (2013-07)&#39;</span>)
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>grid(<span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>fig<span style=color:#f92672>.</span>show()
</span></span></code></pre></div><pre><code>668262
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Ok this seems normal ish. so might as well just split somewhat arbitrarily or evenly</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_quantiles</span>(unsorted):
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> sorted(unsorted)
</span></span><span style=display:flex><span>    minimum <span style=color:#f92672>=</span> data[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    Q1 <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>percentile(data, <span style=color:#ae81ff>25</span>, interpolation <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;midpoint&#39;</span>) 
</span></span><span style=display:flex><span>    median <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>median(data)
</span></span><span style=display:flex><span>    Q3 <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>percentile(data, <span style=color:#ae81ff>75</span>, interpolation <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;midpoint&#39;</span>) 
</span></span><span style=display:flex><span>    maximum <span style=color:#f92672>=</span> data[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [minimum, Q1, median, Q3, maximum]
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>show_da_stats</span>(bundle):
</span></span><span style=display:flex><span>    H, bins <span style=color:#f92672>=</span> bundle[<span style=color:#e6db74>&#39;hist&#39;</span>]
</span></span><span style=display:flex><span>    quantiles <span style=color:#f92672>=</span> bundle[<span style=color:#e6db74>&#39;quantiles&#39;</span>]
</span></span><span style=display:flex><span>    fig <span style=color:#f92672>=</span> plt<span style=color:#f92672>.</span>figure(figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>6</span>))
</span></span><span style=display:flex><span>    fig<span style=color:#f92672>.</span>patch<span style=color:#f92672>.</span>set_facecolor(<span style=color:#e6db74>&#39;xkcd:mint green&#39;</span>)
</span></span><span style=display:flex><span>    ax <span style=color:#f92672>=</span> fig<span style=color:#f92672>.</span>add_subplot(<span style=color:#ae81ff>111</span>, )
</span></span><span style=display:flex><span>    ax<span style=color:#f92672>.</span>scatter(quantiles, [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    ax<span style=color:#f92672>.</span>axvline(quantiles[<span style=color:#ae81ff>1</span>], label<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;q:25%&#39;</span>)
</span></span><span style=display:flex><span>    ax<span style=color:#f92672>.</span>axvline(quantiles[<span style=color:#ae81ff>2</span>], label<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;q:50%&#39;</span>)
</span></span><span style=display:flex><span>    ax<span style=color:#f92672>.</span>axvline(quantiles[<span style=color:#ae81ff>3</span>], label<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;q:75%&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ax<span style=color:#f92672>.</span>set_title(bundle[<span style=color:#e6db74>&#39;title&#39;</span>])
</span></span><span style=display:flex><span>    ax<span style=color:#f92672>.</span>plot(bins, np<span style=color:#f92672>.</span>insert(H, <span style=color:#ae81ff>0</span>, H[<span style=color:#ae81ff>0</span>]), drawstyle<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;steps&#39;</span>, color<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;green&#39;</span>)
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>grid(<span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    fig<span style=color:#f92672>.</span>legend()
</span></span><span style=display:flex><span>    fig<span style=color:#f92672>.</span>show()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>hist <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>histogram(X, bins<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>, range<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>quantiles <span style=color:#f92672>=</span> get_quantiles(X)
</span></span><span style=display:flex><span>bundle <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;hist&#39;</span>: hist, <span style=color:#e6db74>&#39;quantiles&#39;</span>: quantiles,
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#39;title&#39;</span>: <span style=color:#e6db74>&#39;Birth year binned (2013-07)&#39;</span>}
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;quantiles&#39;</span>, quantiles)
</span></span><span style=display:flex><span>show_da_stats(bundle)
</span></span></code></pre></div><pre><code>quantiles [1920.0, 1969.0, 1978.0, 1984.0, 1997.0]
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># And the age quantiles to make this a year independent feature.. </span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2013</span> <span style=color:#f92672>-</span> np<span style=color:#f92672>.</span>array([<span style=color:#ae81ff>1920.0</span>, <span style=color:#ae81ff>1969.0</span>, <span style=color:#ae81ff>1978.0</span>, <span style=color:#ae81ff>1984.0</span>, <span style=color:#ae81ff>1997.0</span>])
</span></span></code></pre></div><pre><code>array([93., 44., 35., 29., 16.])
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> datetime; <span style=color:#f92672>import</span> pytz
</span></span><span style=display:flex><span>x <span style=color:#f92672>=</span> dict(tripsdf<span style=color:#f92672>.</span>iloc[<span style=color:#ae81ff>2</span>])
</span></span><span style=display:flex><span>x
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(x[<span style=color:#e6db74>&#39;start_dt&#39;</span>] <span style=color:#f92672>-</span> 
</span></span><span style=display:flex><span>     datetime<span style=color:#f92672>.</span>datetime(int(x[<span style=color:#e6db74>&#39;birth year&#39;</span>]), <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, tzinfo<span style=color:#f92672>=</span>pytz<span style=color:#f92672>.</span>timezone(<span style=color:#e6db74>&#39;US/Eastern&#39;</span>))
</span></span><span style=display:flex><span>)<span style=color:#f92672>.</span>days<span style=color:#f92672>/</span><span style=color:#ae81ff>365.</span> , (x[<span style=color:#e6db74>&#39;start_dt&#39;</span>] <span style=color:#f92672>-</span> np<span style=color:#f92672>.</span>nan)
</span></span></code></pre></div><pre><code>---------------------------------------------------------------------------

TypeError                                 Traceback (most recent call last)

&lt;ipython-input-102-ee3bddc50852&gt; in &lt;module&gt;
      5 (x['start_dt'] - 
      6      datetime.datetime(int(x['birth year']), 1, 1, tzinfo=pytz.timezone('US/Eastern'))
----&gt; 7 ).days/365. , (x['start_dt'] - np.nan)


TypeError: unsupported operand type(s) for -: 'Timestamp' and 'float'
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>x[<span style=color:#e6db74>&#39;start_dt&#39;</span>] <span style=color:#f92672>-</span> pd<span style=color:#f92672>.</span>NaT
</span></span></code></pre></div><pre><code>NaT
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Reload once again since I modified a col</span>
</span></span><span style=display:flex><span>tripsdf <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>datadir<span style=color:#e6db74>}</span><span style=color:#e6db74>/2013-07 - Citi Bike trip data.csv&#39;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>reload(fu)
</span></span><span style=display:flex><span>minidf <span style=color:#f92672>=</span> tripsdf<span style=color:#f92672>.</span>iloc[:<span style=color:#ae81ff>1000</span>]<span style=color:#f92672>.</span>copy()
</span></span><span style=display:flex><span>fu<span style=color:#f92672>.</span>prepare_weekday_feature(minidf)
</span></span><span style=display:flex><span>fu<span style=color:#f92672>.</span>age_feature(minidf)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>list(reversed([<span style=color:#ae81ff>93.</span>, <span style=color:#ae81ff>44.</span>, <span style=color:#ae81ff>35.</span>, <span style=color:#ae81ff>29.</span>, <span style=color:#ae81ff>16.</span>]))
</span></span></code></pre></div><pre><code>[16.0, 29.0, 35.0, 44.0, 93.0]
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>minidf[<span style=color:#e6db74>&#39;birth_bin&#39;</span>] <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>cut(minidf[<span style=color:#e6db74>&#39;age&#39;</span>], bins<span style=color:#f92672>=</span>[<span style=color:#ae81ff>16.0</span>, <span style=color:#ae81ff>29.0</span>, <span style=color:#ae81ff>35.0</span>, <span style=color:#ae81ff>44.0</span>, <span style=color:#ae81ff>93.0</span>],
</span></span><span style=display:flex><span>                            labels<span style=color:#f92672>=</span>[<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>])
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>minidf[[<span style=color:#e6db74>&#39;age&#39;</span>, <span style=color:#e6db74>&#39;birth&#39;</span>, <span style=color:#e6db74>&#39;birth_bin&#39;</span>]]<span style=color:#f92672>.</span>iloc[:<span style=color:#ae81ff>10</span>]
</span></span></code></pre></div><pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre><p></p><h4 id=prepare-to-build-the-v3-proc-bundle>Prepare to build the v3 proc bundle<a hidden class=anchor aria-hidden=true href=#prepare-to-build-the-v3-proc-bundle>#</a></h4><ul><li>I have a nice <a href=https://github.com/namoopsoo/learn-citibike/blob/master/notes/2020-08-18-glue.md>reference</a> for testing</li><li>And for building, I need to do some reverse engineering to maintain the train/test split from earlier.</li><li></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> fresh.predict_utils <span style=color:#66d9ef>as</span> fpu
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bundle <span style=color:#f92672>=</span> fpu<span style=color:#f92672>.</span>load_bundle_in_docker()
</span></span></code></pre></div><pre><code>Loading from bundle_loc /opt/ml/model/all_bundle_with_stationsdf.joblib
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(<span style=color:#e6db74>&#39;original proc bundle notebook&#39;</span>, bundle[<span style=color:#e6db74>&#39;proc_bundle&#39;</span>][<span style=color:#e6db74>&#39;bundle&#39;</span>][<span style=color:#e6db74>&#39;notebook&#39;</span>])
</span></span><span style=display:flex><span>bundle[<span style=color:#e6db74>&#39;proc_bundle&#39;</span>][<span style=color:#e6db74>&#39;bundle&#39;</span>][<span style=color:#e6db74>&#39;proc_bundle&#39;</span>]<span style=color:#f92672>.</span>keys()
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;this is the bundle glue notebook, cool&#39;</span>, bundle[<span style=color:#e6db74>&#39;notebook&#39;</span>])
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;model notebook&#39;</span>, bundle[<span style=color:#e6db74>&#39;model_bundle&#39;</span>][<span style=color:#e6db74>&#39;bundle&#39;</span>][<span style=color:#e6db74>&#39;notebook&#39;</span>])
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;train&#39;</span>, bundle[<span style=color:#e6db74>&#39;model_bundle&#39;</span>][<span style=color:#e6db74>&#39;bundle&#39;</span>][<span style=color:#e6db74>&#39;train&#39;</span>])
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;test&#39;</span>, bundle[<span style=color:#e6db74>&#39;model_bundle&#39;</span>][<span style=color:#e6db74>&#39;bundle&#39;</span>][<span style=color:#e6db74>&#39;validation_metrics&#39;</span>][<span style=color:#e6db74>&#39;test&#39;</span>])
</span></span></code></pre></div><pre><code>original proc bundle notebook 2020-07-03-aws.ipynb
this is the bundle glue notebook, cool 2020-08-18-glue.ipynb
model notebook 2020-07-10-aws.ipynb
train /home/ec2-user/SageMaker/learn-citibike/artifacts/2020-07-08T143732Z/train.libsvm
test /home/ec2-user/SageMaker/learn-citibike/artifacts/2020-07-08T143732Z/test.libsvm
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> fresh.preproc.v3 <span style=color:#66d9ef>as</span> pv3
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>!</span>pwd
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://michal.piekarczyk.xyz/post/2020-11-02-hmm-what-i-consume/><span class=title>« Prev</span><br><span>What I consume</span>
</a><a class=next href=https://michal.piekarczyk.xyz/project/2020-10-20-bike-share-learn-reboot/><span class=title>Next »</span><br><span>Bike Share Learn Reboot</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://michal.piekarczyk.xyz/>michal.piekarczyk.xyz</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>