<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Backprop and SGD From Scratch Part 3 | My blog</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="[[my back prop SGD from scratch 2022-Aug]] 12:38 so what happened last time? well let me look at the 2022-08-21.html notes I created. 13:20 darn so ok spent bunch of time figuring out why I couldnt view all the images in that html but basically combination of the html references images in log seq dir and also I have to copy them to my git repo area for this repo."><meta name=generator content="Hugo 0.104.2"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/ananke/dist/main.css_5c99d70a7725bacd4c701e995b969fea.css><meta property="og:title" content="Backprop and SGD From Scratch Part 3"><meta property="og:description" content="[[my back prop SGD from scratch 2022-Aug]] 12:38 so what happened last time? well let me look at the 2022-08-21.html notes I created. 13:20 darn so ok spent bunch of time figuring out why I couldnt view all the images in that html but basically combination of the html references images in log seq dir and also I have to copy them to my git repo area for this repo."><meta property="og:type" content="article"><meta property="og:url" content="https://michal.piekarczyk.xyz/post/2022-08-27-backprop-scratch/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-08-27T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-27T00:00:00+00:00"><meta property="og:site_name" content="My blog"><meta itemprop=name content="Backprop and SGD From Scratch Part 3"><meta itemprop=description content="[[my back prop SGD from scratch 2022-Aug]] 12:38 so what happened last time? well let me look at the 2022-08-21.html notes I created. 13:20 darn so ok spent bunch of time figuring out why I couldnt view all the images in that html but basically combination of the html references images in log seq dir and also I have to copy them to my git repo area for this repo."><meta itemprop=datePublished content="2022-08-27T00:00:00+00:00"><meta itemprop=dateModified content="2022-08-27T00:00:00+00:00"><meta itemprop=wordCount content="845"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Backprop and SGD From Scratch Part 3"><meta name=twitter:description content="[[my back prop SGD from scratch 2022-Aug]] 12:38 so what happened last time? well let me look at the 2022-08-21.html notes I created. 13:20 darn so ok spent bunch of time figuring out why I couldnt view all the images in that html but basically combination of the html references images in log seq dir and also I have to copy them to my git repo area for this repo."></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">My blog</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="About page">About</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/handy/ title="Handy page">Handy</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/post/ title="Post page">Post</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/project/ title="Side Projects page">Side Projects</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/foo/ title="The Foos page">The Foos</a></li></ul></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POST</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://michal.piekarczyk.xyz/post/2022-08-27-backprop-scratch/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://michal.piekarczyk.xyz/post/2022-08-27-backprop-scratch/&text=Backprop%20and%20SGD%20From%20Scratch%20Part%203" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://michal.piekarczyk.xyz/post/2022-08-27-backprop-scratch/&title=Backprop%20and%20SGD%20From%20Scratch%20Part%203" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Backprop and SGD From Scratch Part 3</h1><time class="f6 mv4 dib tracked" datetime=2022-08-27T00:00:00Z>August 27, 2022</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><div id=content><ul><li><a class=tag>[[my back prop SGD from scratch 2022-Aug]]</a><ul><li>12:38 so what happened last time? well let me look at the 2022-08-21.html notes I created.<ul><li>13:20 darn so ok spent bunch of time figuring out why I couldnt view all the images in that html but basically combination of the html references images in log seq dir and also I have to copy them to my git repo area for this repo. Anyway,</li><li>13:35 finally looking, so the weird issue was my log loss was getting worse with training when only affecting the final layer , so then I plotted the raw input data with a 3d surface plot but it was really weird looking and shapeless . I plotted this on a 2d plot instead and yea looked reasonable. But yea the 95% label=0 to to 5% label=1 maybe was contributing to why the 3d surface plot looked formless and uninteresting. And for fun I tweaked my 2d plotting code to use a spectrum of colors so I can perhaps look at my output data. But then oh wow oops I realized all the predictions were basically just 0.5 . So my main thought then was that haha probably training just the last layer of a network is basically not useful.</li></ul></li><li>13:44 ok so let me continue with a strategy to train the full network and not just the final layer ,<ul><li>look back at my network,</li><li><b>13:48</b> quick capture: <img src=https://s3.amazonaws.com/my-blog-content/2022/2022-08-27-Backprop-and-SGD-From-Scratch-Part-3/the-network.png title=the-network width=40%></li><li>Just going to write up the partial derivative parts of the gradient one at a time,<ul><li><img src=https://s3.amazonaws.com/my-blog-content/2022/2022-08-27-Backprop-and-SGD-From-Scratch-Part-3/2022-08-27-14-34-53.jpeg title=2022-08-27-14-34-53.jpeg width=40%></li><li><img src=https://s3.amazonaws.com/my-blog-content/2022/2022-08-27-Backprop-and-SGD-From-Scratch-Part-3/2022-08-27-15-42-39.jpeg title=2022-08-27-15-42-39.jpeg width=40%></li></ul></li><li>16:53 ok I have added this to the code now . let me try that train loop again then<pre><code data-lang=python class=python>			  import network as n
			  import plot
			  
			  X, Y = n.build_dataset_inside_outside_circle()
			  layers = n.initialize_network_layers()
			  loss_vec, layers = n.train_network(X, Y, layers)
			  
			  plot.plot_loss_vec(loss_vec)

</code></pre><p><br><img src=https://s3.amazonaws.com/my-blog-content/2022/2022-08-27-Backprop-and-SGD-From-Scratch-Part-3/2022-08-27T211116_1661634782044_0.png title=2022-08-27T211116.png><br></p></li><li>17:12 ok output above is pretty interesting. Probably if indeed things are working, the learning rate is too high. But haha in case something is actually working, let me actually try plotting the predictions for the loss after the first round which I think looks lowest.<p><br></p><pre><code data-lang=python class=python>			  layers = n.initialize_network_layers()
			  loss_vec, layers, artifacts = n.train_network(X, Y, layers, log_loss_each_round=True, steps=10)
			  
			  layers = artifacts[&quot;9&quot;][&quot;model&quot;]
			  Y_actual, total_loss = n.loss(layers, X, Y)

</code></pre><p><br><img src=https://s3.amazonaws.com/my-blog-content/2022/2022-08-27-Backprop-and-SGD-From-Scratch-Part-3/2022-08-27T212719_1661636200052_0.png title=2022-08-27T212719.png><br><br><br></p><pre><code data-lang=python class=python>			  layers = artifacts[&quot;9&quot;][&quot;model&quot;]
			  Y_actual, total_loss = n.loss(layers, X, Y)
			  plot.scatter_plot_by_z(X, Y_actual)

</code></pre><p><img src=https://s3.amazonaws.com/my-blog-content/2022/2022-08-27-Backprop-and-SGD-From-Scratch-Part-3/2022-08-27T213455-scatter_1661636207913_0.png title=2022-08-27T213455-scatter.png><br></p></li><li>17:39 ok haha that's kind of confusing. Not sure why the second time around, pretty sure I did not re-generate the data, the loss on this training round went down and stayed down. Likely the first time around we must have jumped too far from the minimum irrecoverably. And the second time, since indeed the weights are generated randomly, we stayed close.</li><li>But also for the second round, when plotting some outputs, clearly we see something funky is going on. And also I suspect that since I have not fixed that whole 95% to 5% dataset imbalance, some funkiness is happening and indeed the loss does appear to be small because the penalty on the imbalanced dataset is not shining through.</li><li>17:47 So the imbalanced dataset is likely messing with learning and also with the perception of the loss as well.</li><li>20:30 ok to balance out that data, probably simplest is to generate data where the circle is just bigger</li><li>20:52 ok so I ended up with something like,<p><br></p><pre><code data-lang=python class=python>			  # dataset.py
			  import math
			  import numpy as np
			  from collections import Counter
			  
			  def build_dataset_inside_outside_circle(balance=0.5):
			      # Create some data in a 20x20 box centered at origin.
			      num_samples = 10000
			      radius = math.sqrt(40*40*balance/math.pi)
			      X = np.random.random((num_samples, 2)) * 40 + -20
			      f = (lambda a: int(np.sqrt(a[0]**2 + a[1]**2) &lt;= radius))
			      Y = np.array(list(map(f, X)))
			  
			      # Validate balance
			      assert abs(Counter(Y)[1]/num_samples - balance) &lt; 0.02
			      return X, Y

</code></pre><pre><code data-lang=python class=python>			  import dataset
			  import plot
			  
			  X, Y = dataset.build_dataset_inside_outside_circle(0.5)
			  plot.scatter_plot_by_z(X, Y)  # saving to 2022-08-28T005137-scatter.png

</code></pre><p><br><img src=https://s3.amazonaws.com/my-blog-content/2022/2022-08-27-Backprop-and-SGD-From-Scratch-Part-3/2022-08-28T005137-scatter_1661648053490_0.png title=2022-08-28T005137-scatter.png><br></p></li><li>20:58 ok lets see what happens with training then ,<p><br></p><pre><code data-lang=python class=python>			  
			  layers = n.initialize_network_layers()
			  loss_vec, layers, artifacts = n.train_network(X, Y, layers, log_loss_every_k_steps=10, steps=1000)
			   outer: 100%|███████████████████████████████████████████████| 1000/1000 [04:45&lt;00:00,  3.51it/s]
			  
			  plot.plot_loss_vec(loss_vec)
			  # saving to 2022-08-28T012206.png

</code></pre><p><br><img src=https://s3.amazonaws.com/my-blog-content/2022/2022-08-27-Backprop-and-SGD-From-Scratch-Part-3/2022-08-28T012206_1661649829702_0.png title=2022-08-28T012206.png><br></p></li><li>21:20 ok so this time definitely a little more time to train since I've been measuring log loss every 10 steps on all <code>10,000</code> samples but I can do fewer next time to iterate more quickly.<ul><li>Especially since darn, indeed this time, the loss spiraled out of control</li><li>Out of curiosity, let me plot the outputs for basically the earliest model ,<pre><code data-lang=python class=python>				  
				  layers = artifacts[&quot;10&quot;][&quot;model&quot;]
				  Y_actual, total_loss = n.loss(layers, X, Y)
				  plot.scatter_plot_by_z(X, Y_actual) # saving to 2022-08-28T012619-scatter.png                                                          

</code></pre><p><img src=https://s3.amazonaws.com/my-blog-content/2022/2022-08-27-Backprop-and-SGD-From-Scratch-Part-3/2022-08-28T012619-scatter_1661650089030_0.png title=2022-08-28T012619-scatter.png><br></p></li><li>ok wow pretty quirky.</li></ul></li><li>21:28 ok yea so super curious about what does reducing learning rate do then. Added some additional code to support this too.<p><br></p><pre><code data-lang=python class=python>			  import network as n
			  model = n.initialize_model({&quot;learning_rate&quot;: 0.01})
			  (
			      loss_vec, model, artifacts, X_validation, Y_validation, Y_prob
			  )  = n.train_network(X, Y, model)
			   outer: 100%|███████████████████████████████████████████████████| 60/60 [00:01&lt;00:00, 31.19it/s]
			  

</code></pre></li><li>21:49 ok lets look at a first run then ,<pre><code data-lang=python class=python>			  plot.plot_loss_vec(loss_vec)
			  # saving to 2022-08-28T015127.png

</code></pre><p><img src=https://s3.amazonaws.com/my-blog-content/2022/2022-08-27-Backprop-and-SGD-From-Scratch-Part-3/2022-08-28T015127_1661651602769_0.png title=2022-08-28T015127.png><br><br></p><pre><code data-lang=python class=python>			  plot.scatter_plot_by_z(X_validation, Y_prob)  # saving to 2022-08-28T015518-scatter.png

</code></pre><p><img src=https://s3.amazonaws.com/my-blog-content/2022/2022-08-27-Backprop-and-SGD-From-Scratch-Part-3/2022-08-28T015518-scatter_1661651808095_0.png title=2022-08-28T015518-scatter.png><br></p></li><li>21:56 darn okay still not learning, despite the additional balancing and lower learning rate. Super curious what is the fundamental issue in this network. Curious to debug this.</li><li></li></ul></li></ul></li><li>16:03 also I learned the plant in the office is called the swiss cheese plant<ul><li><a href=https:www.plantindex.com/swiss-cheese-plant/>https://www.plantindex.com/swiss-cheese-plant/</a></li><li><img src=https://s3.amazonaws.com/my-blog-content/2022/2022-08-27-Backprop-and-SGD-From-Scratch-Part-3/image_1661630670633_0.png title=image.png></li></ul></li><li>hmm</li></ul></div><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://michal.piekarczyk.xyz/>&copy; My blog 2022</a><div></div></div></footer></body></html>