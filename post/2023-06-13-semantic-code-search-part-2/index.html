<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>semantic code search part 2 | michal.piekarczyk.xyz</title>
<meta name=keywords content><meta name=description content="public:: true blog-date:: 2023-06-13 Ok continuing from last time, where I ran sentence_transformers model 'msmarco-MiniLM-L-6-v3' against a code search problem of comparing query lines against a source code corpus actually from the sentence_transformers github
This time, I wanted to write some code around measuring the successful hits from a model run using cosine similarity from sentence_transformers
Query set choice I expanded the set of queries slightly, but not that much yet so I could focus on the evaluation code."><meta name=author content="Michal Piekarczyk"><link rel=canonical href=https://michal.piekarczyk.xyz/post/2023-06-13-semantic-code-search-part-2/><link crossorigin=anonymous href=/assets/css/stylesheet.dd867d536fb6202811c1ee15fa181ef8945826662b49d3016ac91365a2621d58.css integrity="sha256-3YZ9U2+2ICgRwe4V+hge+JRYJmYrSdMBaskTZaJiHVg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://michal.piekarczyk.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://michal.piekarczyk.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://michal.piekarczyk.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://michal.piekarczyk.xyz/apple-touch-icon.png><link rel=mask-icon href=https://michal.piekarczyk.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-74MK08REDT"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-74MK08REDT",{anonymize_ip:!1})}</script><meta property="og:title" content="semantic code search part 2"><meta property="og:description" content="public:: true blog-date:: 2023-06-13 Ok continuing from last time, where I ran sentence_transformers model 'msmarco-MiniLM-L-6-v3' against a code search problem of comparing query lines against a source code corpus actually from the sentence_transformers github
This time, I wanted to write some code around measuring the successful hits from a model run using cosine similarity from sentence_transformers
Query set choice I expanded the set of queries slightly, but not that much yet so I could focus on the evaluation code."><meta property="og:type" content="article"><meta property="og:url" content="https://michal.piekarczyk.xyz/post/2023-06-13-semantic-code-search-part-2/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-06-13T00:00:00+00:00"><meta property="article:modified_time" content="2023-06-13T18:52:18-04:00"><meta property="og:site_name" content="michal.piekarczyk.xyz"><meta name=twitter:card content="summary"><meta name=twitter:title content="semantic code search part 2"><meta name=twitter:description content="public:: true blog-date:: 2023-06-13 Ok continuing from last time, where I ran sentence_transformers model 'msmarco-MiniLM-L-6-v3' against a code search problem of comparing query lines against a source code corpus actually from the sentence_transformers github
This time, I wanted to write some code around measuring the successful hits from a model run using cosine similarity from sentence_transformers
Query set choice I expanded the set of queries slightly, but not that much yet so I could focus on the evaluation code."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://michal.piekarczyk.xyz/post/"},{"@type":"ListItem","position":2,"name":"semantic code search part 2","item":"https://michal.piekarczyk.xyz/post/2023-06-13-semantic-code-search-part-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"semantic code search part 2","name":"semantic code search part 2","description":"public:: true blog-date:: 2023-06-13 Ok continuing from last time, where I ran sentence_transformers model 'msmarco-MiniLM-L-6-v3' against a code search problem of comparing query lines against a source code corpus actually from the sentence_transformers github\nThis time, I wanted to write some code around measuring the successful hits from a model run using cosine similarity from sentence_transformers\nQuery set choice I expanded the set of queries slightly, but not that much yet so I could focus on the evaluation code.","keywords":[],"articleBody":"public:: true blog-date:: 2023-06-13 Ok continuing from last time, where I ran sentence_transformers model 'msmarco-MiniLM-L-6-v3' against a code search problem of comparing query lines against a source code corpus actually from the sentence_transformers github\nThis time, I wanted to write some code around measuring the successful hits from a model run using cosine similarity from sentence_transformers\nQuery set choice I expanded the set of queries slightly, but not that much yet so I could focus on the evaluation code.\nInitially building a dataset, had a snag with reproducibility So take earlier queries, adding some more manually, and building dataset from them,\nqueries = [ \"snapshot_download\", \"SentenceEvaluator\", \"get_torch_home\", \"os.path.join\", \"flax_model.msgpack\", \"torch.nn.functional.normalize\", \"BATCH_HARD_TRIPLET_LOSS\", \"SentenceTransformer('model-name')\", \"DEPRECATED: This class is no longer used\", \"module_config['path']\", \"config_sentence_transformers.json\", \"os.path.join(checkpoint_path, subdir)\" \"torch.nn.utils.clip_grad_norm\", \"getEffectiveLevel\", \"torch.cuda\", ] corpus = [x[\"line\"] for x in dataset if \"Sentence\" in x[\"path\"]] import json import os import pandas as pd import code_search as cs from pathlib import Path from date_utils import utc_ts repos_dir = os.getenv(\"REPOS_DIR\") target_dir = Path(repos_dir) / \"sentence-transformers\" dataset = cs.build_texts_from_repository(target_dir) workdir = Path(repos_dir) / \"code_search\" # Let me save the dataset actually, and build from there, df = pd.DataFrame.from_records(dataset) path = (workdir / \"datasets\" / f\"{utc_ts()}-dataset.csv\") print(\"saving\", path.relative_to(repos_dir)) # saving code_search/datasets/2023-06-13T164234Z-dataset.csv # Only the non-blank lines, df[df.line != \"\"].shape, df.shape # ((16593, 3), (21953, 3)) df.to_csv(path, index=False) df2 = pd.read_csv(path) print(df.equals(df2)) # False, oops was getting False , because of blank lines,\nIn [20]: df.iloc[:2] Out[20]: line_number line path 0 0 from setuptools import setup, find_packages setup.py 1 1 setup.py In [21]: df2.iloc[:2] Out[21]: line_number line path 0 0 from setuptools import setup, find_packages setup.py 1 1 NaN setup.py But yea that’s okay, I updated the build_texts_from_repository func to ignore blanks def build_texts_from_repository(repo_dir): \"\"\"Return a dataset of the non-blank lines of code \"\"\" dataset = [] for path in chain( Path(repo_dir).glob(\"**/*.py\"), Path(repo_dir).glob(\"**/*.md\"), ): assert path.is_file() and path.suffix lines = path.read_text().splitlines() dataset.extend( [ { \"line_number\": i, \"line\": line, \"path\": str(path.relative_to(repo_dir))} for i, line in enumerate(lines) if line.strip() != \"\" ] ) return dataset 12:52 slightly updated my func, \"build_texts_from_repository\" to not include the blank lines or lines with just whitespace also !\nok trying again,\nimport json import os import pandas as pd import code_search as cs from pathlib import Path from date_utils import utc_ts repos_dir = os.getenv(\"REPOS_DIR\") target_dir = Path(repos_dir) / \"sentence-transformers\" dataset = cs.build_texts_from_repository(target_dir) workdir = Path(repos_dir) / \"code_search\" df = pd.DataFrame.from_records(dataset) # Now should be only the non-blank lines, print(\"blanks\", df[df.line == \"\"].shape[0]) # blanks 0 path = (workdir / \"datasets\" / f\"{utc_ts()}-dataset.csv\") print(\"saving\", path.relative_to(repos_dir)) # saving code_search/datasets/2023-06-13T170451Z-dataset.csv df.to_csv(path, index=False) df2 = pd.read_csv(path) print(df.equals(df2)) # True # And vanilla python equals? df2.to_dict(orient=\"records\") == dataset # Out[62]: True 13:05 ok cool, worked this time ! 13:48 save the subset, too,\n# Only the subset with sentence filenames, path = (workdir / \"datasets\" / f\"{utc_ts()}-dataset-sentence-filenames.csv\") print(\"saving\", path.relative_to(repos_dir)) # saving code_search/datasets/2023-06-13T174927Z-dataset-sentence-filenames.csv df = pd.DataFrame.from_records( [x for x in dataset if \"Sentence\" in x[\"path\"]] ) df.to_csv(path, index=False) print(\"read equals\", df.equals(pd.read_csv(path))) # read equals True First let’s build a query set 13:37 ok lets run the simplistic search first,\ndef build_query_dataset(queries, dataset): \"\"\" Args: queries: plain list of strings dataset: list of dictionaries with [\"line_number\", \"line\", \"path\"] Example [{'line_number': 35, 'line': ' name = \"_\"+name', 'path': 'sentence_transformers/evaluation/MSEEvaluatorFromDataFrame.py'}, {'line_number': 110, 'line': 'if not os.path.exists(queries_filepath):', 'path': 'examples/training/ms_marco/train_bi-encoder_mnrl.py'}, {'line_number': 52, 'line': \"tracer = logging.getLogger('elasticsearch') \", 'path': 'examples/training/data_augmentation/train_sts_indomain_bm25.py'}] \"\"\" search_results = [] for query in tqdm(queries): findings = [ {\"query\": query, **x } for x in dataset if query in x[\"line\"] ] search_results.extend(findings) return search_results import os from pathlib import Path import code_search as cs import pandas as pd repos_dir = os.getenv(\"REPOS_DIR\") path = (Path(repos_dir) / \"code_search/datasets/2023-06-13T174927Z-dataset-sentence-filenames.csv\" ) dataset = pd.read_csv(path).to_dict(orient=\"records\") queries = [ \"snapshot_download\", \"SentenceEvaluator\", \"get_torch_home\", \"os.path.join\", \"flax_model.msgpack\", \"torch.nn.functional.normalize\", \"BATCH_HARD_TRIPLET_LOSS\", \"SentenceTransformer('model-name')\", \"DEPRECATED: This class is no longer used\", \"module_config['path']\", \"config_sentence_transformers.json\", \"os.path.join(checkpoint_path, subdir)\" \"torch.nn.utils.clip_grad_norm\", \"getEffectiveLevel\", \"torch.cuda\", ] search_results = cs.build_query_dataset(queries, dataset) 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 14/14 [00:00\u003c00:00, 6913.96it/s] In [5]: len(search_results) Out[5]: 43 In [8]: len(queries) Out[8]: 14 searchdf = pd.DataFrame.from_records(search_results) searchdf[\"query\"].value_counts() # os.path.join 20 torch.cuda 5 SentenceEvaluator 4 config_sentence_transformers.json 3 snapshot_download 2 get_torch_home 2 flax_model.msgpack 1 torch.nn.functional.normalize 1 BATCH_HARD_TRIPLET_LOSS 1 SentenceTransformer('model-name') 1 DEPRECATED: This class is no longer used 1 module_config['path'] 1 getEffectiveLevel 1 Name: query, dtype: int64 13:59 ok haha that was instantaneous. Ok so lets evaluate the sentence_transformer accuracy then, Maybe this is a bit unbalanced, but this is good enough for now.\nAnd running the query semantic search And again using the use of semantic_search as nicely described in https://www.sbert.net/examples/applications/semantic-search/README.html#python ,\n14:55 For now let’s use the number 20 from above, as the number of results to retrieve for each query, since that is the max number of results we get for any query.\nimport torch import os import pandas as pd from pathlib import Path from sentence_transformers import SentenceTransformer, util from sentence_transformers.util import semantic_search from importlib import reload import code_search as cs hf_token = os.getenv(\"HF_TOKEN\") embedder = SentenceTransformer( 'msmarco-MiniLM-L-6-v3', use_auth_token=hf_token, ) repos_dir = os.getenv(\"REPOS_DIR\") path = (Path(repos_dir) / \"code_search/datasets/2023-06-13T174927Z-dataset-sentence-filenames.csv\" ) dataset = pd.read_csv(path).to_dict(orient=\"records\") corpus = [x[\"line\"] for x in dataset] corpus_embeddings = embedder.encode(corpus, convert_to_tensor=True) queries = [ \"snapshot_download\", \"SentenceEvaluator\", \"get_torch_home\", \"os.path.join\", \"flax_model.msgpack\", \"torch.nn.functional.normalize\", \"BATCH_HARD_TRIPLET_LOSS\", \"SentenceTransformer('model-name')\", \"DEPRECATED: This class is no longer used\", \"module_config['path']\", \"config_sentence_transformers.json\", \"os.path.join(checkpoint_path, subdir)\" \"torch.nn.utils.clip_grad_norm\", \"getEffectiveLevel\", \"torch.cuda\", ] top_k = 20 # hat is the max number of results we get for any query so far. resultsdf = cs.run_semantic_search(embedder, dataset, queries, top_k) Merge results 16:46 merging results and initial dataset, the results are pytorch tensors which looks like they are treated as objects in pandas land ,\nipdb\u003e p resultsdf.head() score idx query 0 tensor(0.6807) tensor(73) snapshot_download 1 tensor(0.5153) tensor(24) snapshot_download 2 tensor(0.4511) tensor(72) snapshot_download 3 tensor(0.3790) tensor(584) snapshot_download 4 tensor(0.3619) tensor(55) snapshot_download ipdb\u003e p resultsdf.head().dtypes score object idx object query object dtype: object ipdb\u003e so let me cast that,\nipdb\u003e p resultsdf.astype({\"idx\": \"int\", \"score\": \"float\"}).merge(truthdf, left_on=\"idx\", right_index=True, how=\"left\").head() score idx query line_number line path 0 0.680669 73 snapshot_download 86 snapshot_download(model_na... sentence_transformers/SentenceTransformer.py 1 0.515324 24 snapshot_download 25 from .util import import_from_string, batch_to... sentence_transformers/SentenceTransformer.py 2 0.451125 72 snapshot_download 85 # Download from hub with c... sentence_transformers/SentenceTransformer.py 3 0.379038 584 snapshot_download 725 optimizer.step() sentence_transformers/SentenceTransformer.py 4 0.361899 55 snapshot_download 62 cache_folder = os.path.join(to... sentence_transformers/SentenceTransformer.py ipdb\u003e In [25]: with ipdb.launch_ipdb_on_exception(): ...: resultsdf = cs.run_semantic_search(embedder, dataset, queries, top_k) ...: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 14/14 [00:00\u003c00:00, 100.97it/s] In [26]: resultsdf.head() Out[26]: score query line_number line path 0 0.680669 snapshot_download 86 snapshot_download(model_na... sentence_transformers/SentenceTransformer.py 1 0.515324 snapshot_download 25 from .util import import_from_string, batch_to... sentence_transformers/SentenceTransformer.py 2 0.451125 snapshot_download 85 # Download from hub with c... sentence_transformers/SentenceTransformer.py 3 0.379038 snapshot_download 725 optimizer.step() sentence_transformers/SentenceTransformer.py 4 0.361899 snapshot_download 62 cache_folder = os.path.join(to... sentence_transformers/SentenceTransformer.py Evaluate 17:11 ok so how to evaluate truth against the results now\nMaybe, given a threshold, like 0.5 , how many hits and misses. Perhaps one way to evaluate , would be to left join truthdf with resultsdf in order to count the hits at least. And misses are the left anti-join then.\nimport pandas as pd from date_utils import utc_ts repos_dir = os.getenv(\"REPOS_DIR\") search_results = cs.build_query_dataset(queries, dataset) truthdf = pd.DataFrame.from_records(search_results) workdir = Path(repos_dir) / \"code_search\" In [37]: set(truthdf.columns.tolist()) \u0026 set(resultsdf.columns.tolist()) Out[37]: {'line', 'line_number', 'path', 'query'} eval_df = pd.merge( truthdf, resultsdf.drop([\"line\"], axis=1), on=[\"query\", \"path\", \"line_number\"], how=\"left\") path = (workdir / f\"{utc_ts()}-evaldf.csv\") print(\"saving\", path.relative_to(repos_dir)) # saving code_search/2023-06-13T213516Z-evaldf.csv eval_df.to_csv(path, index=False) In [46]: eval_df Out[46]: query line_number line path score 0 snapshot_download 25 from .util import import_from_string, batch_to... sentence_transformers/SentenceTransformer.py 0.515324 1 snapshot_download 86 snapshot_download(model_na... sentence_transformers/SentenceTransformer.py 0.680669 2 SentenceEvaluator 24 from .evaluation import SentenceEvaluator sentence_transformers/SentenceTransformer.py 0.700384 3 SentenceEvaluator 576 evaluator: SentenceEvaluator = None, sentence_transformers/SentenceTransformer.py 0.749687 4 SentenceEvaluator 756 def evaluate(self, evaluator: SentenceEval... sentence_transformers/SentenceTransformer.py 0.403172 5 SentenceEvaluator 0 class SentenceEvaluator: sentence_transformers/evaluation/SentenceEvalu... 0.818287 6 get_torch_home 56 from torch.hub import _get... sentence_transformers/SentenceTransformer.py 0.865429 7 get_torch_home 58 torch_cache_home = _get_to... sentence_transformers/SentenceTransformer.py 0.859171 8 os.path.join 60 torch_cache_home = os.path... sentence_transformers/SentenceTransformer.py NaN 9 os.path.join 62 cache_folder = os.path.join(to... sentence_transformers/SentenceTransformer.py NaN 10 os.path.join 82 model_path = os.path.join(cach... sentence_transformers/SentenceTransformer.py 0.662760 11 os.path.join 84 if not os.path.exists(os.path.... sentence_transformers/SentenceTransformer.py 0.737865 12 os.path.join 93 if os.path.exists(os.path.join(mod... sentence_transformers/SentenceTransformer.py 0.704441 13 os.path.join 362 with open(os.path.join(path, 'config_s... sentence_transformers/SentenceTransformer.py NaN 14 os.path.join 371 model_path = os.path.join(path... sentence_transformers/SentenceTransformer.py 0.666143 15 os.path.join 377 with open(os.path.join(path, 'modules.... sentence_transformers/SentenceTransformer.py 0.623291 16 os.path.join 428 with open(os.path.join(path, \"README.m... sentence_transformers/SentenceTransformer.py 0.619979 17 os.path.join 487 create_model_card = replace_mo... sentence_transformers/SentenceTransformer.py NaN 18 os.path.join 494 file_path = os.path.join(r... sentence_transformers/SentenceTransformer.py 0.800986 19 os.path.join 520 shutil.rmtree(os.path.join... sentence_transformers/SentenceTransformer.py NaN 20 os.path.join 774 eval_path = os.path.join(output_pa... sentence_transformers/SentenceTransformer.py 0.621379 21 os.path.join 788 self.save(os.path.join(checkpoint_path... sentence_transformers/SentenceTransformer.py 0.598843 22 os.path.join 795 old_checkpoints.append({'s... sentence_transformers/SentenceTransformer.py NaN 23 os.path.join 816 config_sentence_transformers_json_path... sentence_transformers/SentenceTransformer.py NaN 24 os.path.join 825 model_card_path = os.path.join(model_p... sentence_transformers/SentenceTransformer.py 0.637539 25 os.path.join 834 modules_json_path = os.path.join(model... sentence_transformers/SentenceTransformer.py 0.627189 26 os.path.join 841 module = module_class.load(os.path... sentence_transformers/SentenceTransformer.py NaN 27 os.path.join 20 for line in open(os.path.join(self.fol... sentence_transformers/readers/LabelSentenceRea... 0.568704 28 flax_model.msgpack 90 ignore... sentence_transformers/SentenceTransformer.py 0.427975 29 torch.nn.functional.normalize 183 embeddings = torch.nn.... sentence_transformers/SentenceTransformer.py 0.624402 30 BATCH_HARD_TRIPLET_LOSS 13 This dataset can be used for some specific... sentence_transformers/datasets/SentenceLabelDa... 0.738400 31 SentenceTransformer('model-name') 5 model = SentenceTransformer('model-name') docs/package_reference/SentenceTransformer.md 0.909370 32 DEPRECATED: This class is no longer used 8 DEPRECATED: This class is no longer used. ... sentence_transformers/datasets/SentencesDatase... 0.766369 33 module_config['path'] 841 module = module_class.load(os.path... sentence_transformers/SentenceTransformer.py 0.627141 34 config_sentence_transformers.json 362 with open(os.path.join(path, 'config_s... sentence_transformers/SentenceTransformer.py 0.548365 35 config_sentence_transformers.json 815 # Check if the config_sentence_transfo... sentence_transformers/SentenceTransformer.py 0.662415 36 config_sentence_transformers.json 816 config_sentence_transformers_json_path... sentence_transformers/SentenceTransformer.py 0.760809 37 getEffectiveLevel 135 show_progress_bar = (logger.getEff... sentence_transformers/SentenceTransformer.py 0.428602 38 torch.cuda 103 device = \"cuda\" if torch.cuda.is_a... sentence_transformers/SentenceTransformer.py 0.779811 39 torch.cuda 215 if torch.cuda.is_available(): sentence_transformers/SentenceTransformer.py 0.835975 40 torch.cuda 216 target_devices = ['cuda:{}'.fo... sentence_transformers/SentenceTransformer.py 0.616090 41 torch.cuda 637 from torch.cuda.amp import autocast sentence_transformers/SentenceTransformer.py 0.695091 42 torch.cuda 638 scaler = torch.cuda.amp.GradScaler() sentence_transformers/SentenceTransformer.py 0.645202 see the results slightly better perhaps,\nIn [58]: eval_df[\"line\"] = eval_df[\"line\"].map(lambda x:x.strip()) In [63]: eval_df[[\"query\", \"line\", \"score\"]] Out[63]: query line score 0 snapshot_download from .util import import_from_string, batch_to_device, fullname, snapshot_download 0.515324 1 snapshot_download snapshot_download(model_name_or_path, 0.680669 2 SentenceEvaluator from .evaluation import SentenceEvaluator 0.700384 3 SentenceEvaluator evaluator: SentenceEvaluator = None, 0.749687 4 SentenceEvaluator def evaluate(self, evaluator: SentenceEvaluator, output_path: str = None): 0.403172 5 SentenceEvaluator class SentenceEvaluator: 0.818287 6 get_torch_home from torch.hub import _get_torch_home 0.865429 7 get_torch_home torch_cache_home = _get_torch_home() 0.859171 8 os.path.join torch_cache_home = os.path.expanduser(os.getenv('TORCH_HOME', os.path.join(os.getenv('XDG_CACHE_... NaN 9 os.path.join cache_folder = os.path.join(torch_cache_home, 'sentence_transformers') NaN 10 os.path.join model_path = os.path.join(cache_folder, model_name_or_path.replace(\"/\", \"_\")) 0.662760 11 os.path.join if not os.path.exists(os.path.join(model_path, 'modules.json')): 0.737865 12 os.path.join if os.path.exists(os.path.join(model_path, 'modules.json')): #Load as SentenceTransformer model 0.704441 13 os.path.join with open(os.path.join(path, 'config_sentence_transformers.json'), 'w') as fOut: NaN 14 os.path.join model_path = os.path.join(path, str(idx)+\"_\"+type(module).__name__) 0.666143 15 os.path.join with open(os.path.join(path, 'modules.json'), 'w') as fOut: 0.623291 16 os.path.join with open(os.path.join(path, \"README.md\"), \"w\", encoding='utf8') as fOut: 0.619979 17 os.path.join create_model_card = replace_model_card or not os.path.exists(os.path.join(tmp_dir, 'README.md')) NaN 18 os.path.join file_path = os.path.join(root, filename) 0.800986 19 os.path.join shutil.rmtree(os.path.join(tmp_dir, f), onerror=on_rm_error) NaN 20 os.path.join eval_path = os.path.join(output_path, \"eval\") 0.621379 21 os.path.join self.save(os.path.join(checkpoint_path, str(step))) 0.598843 22 os.path.join old_checkpoints.append({'step': int(subdir), 'path': os.path.join(checkpoint_path, subdir)}) NaN 23 os.path.join config_sentence_transformers_json_path = os.path.join(model_path, 'config_sentence_transformers.... NaN 24 os.path.join model_card_path = os.path.join(model_path, 'README.md') 0.637539 25 os.path.join modules_json_path = os.path.join(model_path, 'modules.json') 0.627189 26 os.path.join module = module_class.load(os.path.join(model_path, module_config['path'])) NaN 27 os.path.join for line in open(os.path.join(self.folder, filename), encoding=\"utf-8\"): 0.568704 28 flax_model.msgpack ignore_files=['flax_model.msgpack', 'rust_model.ot', 'tf_model.h5'], 0.427975 29 torch.nn.functional.normalize embeddings = torch.nn.functional.normalize(embeddings, p=2, dim=1) 0.624402 30 BATCH_HARD_TRIPLET_LOSS This dataset can be used for some specific Triplet Losses like BATCH_HARD_TRIPLET_LOSS which req... 0.738400 31 SentenceTransformer('model-name') model = SentenceTransformer('model-name') 0.909370 32 DEPRECATED: This class is no longer used DEPRECATED: This class is no longer used. Instead of wrapping your List of InputExamples in a Se... 0.766369 33 module_config['path'] module = module_class.load(os.path.join(model_path, module_config['path'])) 0.627141 34 config_sentence_transformers.json with open(os.path.join(path, 'config_sentence_transformers.json'), 'w') as fOut: 0.548365 35 config_sentence_transformers.json # Check if the config_sentence_transformers.json file exists (exists since v2 of the framework) 0.662415 36 config_sentence_transformers.json config_sentence_transformers_json_path = os.path.join(model_path, 'config_sentence_transformers.... 0.760809 37 getEffectiveLevel show_progress_bar = (logger.getEffectiveLevel()==logging.INFO or logger.getEffectiveLevel()==log... 0.428602 38 torch.cuda device = \"cuda\" if torch.cuda.is_available() else \"cpu\" 0.779811 39 torch.cuda if torch.cuda.is_available(): 0.835975 40 torch.cuda target_devices = ['cuda:{}'.format(i) for i in range(torch.cuda.device_count())] 0.616090 41 torch.cuda from torch.cuda.amp import autocast 0.695091 42 torch.cuda scaler = torch.cuda.amp.GradScaler() 0.645202 17:40 ok cool , although wonder how not all the “os.path.join” lines were matched. Maybe some debugging to do. Also should still built the [[anti join]] to get the misses aka [[false-positive]] too.\n","wordCount":"1959","inLanguage":"en","datePublished":"2023-06-13T00:00:00Z","dateModified":"2023-06-13T18:52:18-04:00","author":{"@type":"Person","name":"Michal Piekarczyk"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://michal.piekarczyk.xyz/post/2023-06-13-semantic-code-search-part-2/"},"publisher":{"@type":"Organization","name":"michal.piekarczyk.xyz","logo":{"@type":"ImageObject","url":"https://michal.piekarczyk.xyz/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://michal.piekarczyk.xyz/ accesskey=h title="michal.piekarczyk.xyz (Alt + H)">michal.piekarczyk.xyz</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://michal.piekarczyk.xyz/post/ title=posts><span>posts</span></a></li><li><a href=https://michal.piekarczyk.xyz/project/ title=projects><span>projects</span></a></li><li><a href=https://michal.piekarczyk.xyz/handy/ title=handy><span>handy</span></a></li><li><a href=https://michal.piekarczyk.xyz/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://michal.piekarczyk.xyz/about/ title=about><span>about</span></a></li><li><a href=https://world.hey.com/michal.piekarczyk title=frivolity><span>frivolity</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://michal.piekarczyk.xyz/>Home</a>&nbsp;»&nbsp;<a href=https://michal.piekarczyk.xyz/post/>Posts</a></div><h1 class=post-title>semantic code search part 2</h1><div class=post-meta>&lt;span title='2023-06-13 00:00:00 +0000 UTC'>June 13, 2023&lt;/span>&amp;nbsp;·&amp;nbsp;10 min&amp;nbsp;·&amp;nbsp;1959 words&amp;nbsp;·&amp;nbsp;Michal Piekarczyk</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#initially-building-a-dataset-had-a-snag-with-reproducibility>Initially building a dataset, had a snag with reproducibility</a><ul><li><a href=#but-yea-thats-okay-i-updated-the-build_texts_from_repository--func-to-ignore-blanks>But yea that&rsquo;s okay, I updated the <code>build_texts_from_repository</code> func to ignore blanks</a></li></ul></li><li><a href=#first-lets-build-a-query-set>First let&rsquo;s build a query set</a></li></ul><ul><li><a href=#semantic-search>semantic search</a></li><li><a href=#merge-results>Merge results</a></li><li><a href=#evaluate>Evaluate</a></li></ul></nav></div></details></div><div class=post-content><p>public:: true
blog-date:: 2023-06-13
Ok continuing from <a href=/post/2023-06-11-semantic-code-search-first-stab/>last time</a>, where I ran <code>sentence_transformers</code> model <code>'msmarco-MiniLM-L-6-v3'</code> against a code search problem of comparing query lines against a source code corpus actually from the <a href=https://github.com/UKPLab/sentence-transformers>sentence_transformers github</a></p><p>This time, I wanted to write some code around measuring the successful hits from a model run using cosine similarity from sentence_transformers</p><h1 id=query-set-choice>Query set choice<a hidden class=anchor aria-hidden=true href=#query-set-choice>#</a></h1><p>I expanded the set of queries slightly, but not that much yet so I could focus on the evaluation code.</p><h2 id=initially-building-a-dataset-had-a-snag-with-reproducibility>Initially building a dataset, had a snag with reproducibility<a hidden class=anchor aria-hidden=true href=#initially-building-a-dataset-had-a-snag-with-reproducibility>#</a></h2><p>So take earlier queries, adding some more manually, and building dataset from them,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>queries <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;snapshot_download&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;SentenceEvaluator&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;get_torch_home&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os.path.join&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;flax_model.msgpack&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;torch.nn.functional.normalize&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;BATCH_HARD_TRIPLET_LOSS&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;SentenceTransformer(&#39;model-name&#39;)&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;DEPRECATED: This class is no longer used&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;module_config[&#39;path&#39;]&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;config_sentence_transformers.json&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os.path.join(checkpoint_path, subdir)&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;torch.nn.utils.clip_grad_norm&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;getEffectiveLevel&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;torch.cuda&#34;</span>,
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>corpus <span style=color:#f92672>=</span> [x[<span style=color:#e6db74>&#34;line&#34;</span>] <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> dataset <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;Sentence&#34;</span> <span style=color:#f92672>in</span> x[<span style=color:#e6db74>&#34;path&#34;</span>]]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd 
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> code_search <span style=color:#66d9ef>as</span> cs
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pathlib <span style=color:#f92672>import</span> Path
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> date_utils <span style=color:#f92672>import</span> utc_ts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>repos_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;REPOS_DIR&#34;</span>)
</span></span><span style=display:flex><span>target_dir <span style=color:#f92672>=</span> Path(repos_dir) <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;sentence-transformers&#34;</span>
</span></span><span style=display:flex><span>dataset <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>build_texts_from_repository(target_dir)
</span></span><span style=display:flex><span>workdir <span style=color:#f92672>=</span> Path(repos_dir) <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;code_search&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Let me save the dataset actually, and build from there, </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame<span style=color:#f92672>.</span>from_records(dataset)
</span></span><span style=display:flex><span>path <span style=color:#f92672>=</span> (workdir <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;datasets&#34;</span> <span style=color:#f92672>/</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>utc_ts()<span style=color:#e6db74>}</span><span style=color:#e6db74>-dataset.csv&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;saving&#34;</span>, path<span style=color:#f92672>.</span>relative_to(repos_dir))
</span></span><span style=display:flex><span><span style=color:#75715e># saving code_search/datasets/2023-06-13T164234Z-dataset.csv</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Only the non-blank lines,</span>
</span></span><span style=display:flex><span>df[df<span style=color:#f92672>.</span>line <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span>]<span style=color:#f92672>.</span>shape, df<span style=color:#f92672>.</span>shape  <span style=color:#75715e># ((16593, 3), (21953, 3))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>to_csv(path, index<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>df2 <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(path)
</span></span><span style=display:flex><span>print(df<span style=color:#f92672>.</span>equals(df2))  <span style=color:#75715e># False,</span>
</span></span></code></pre></div><p>oops was getting False , because of blank lines,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>In [<span style=color:#ae81ff>20</span>]: df<span style=color:#f92672>.</span>iloc[:<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>Out[<span style=color:#ae81ff>20</span>]: 
</span></span><span style=display:flex><span>   line_number                                         line      path
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>            <span style=color:#ae81ff>0</span>  <span style=color:#f92672>from</span> setuptools <span style=color:#f92672>import</span> setup, find_packages  setup<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>                                               setup<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>In [<span style=color:#ae81ff>21</span>]: df2<span style=color:#f92672>.</span>iloc[:<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>Out[<span style=color:#ae81ff>21</span>]: 
</span></span><span style=display:flex><span>   line_number                                         line      path
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>            <span style=color:#ae81ff>0</span>  <span style=color:#f92672>from</span> setuptools <span style=color:#f92672>import</span> setup, find_packages  setup<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>                                          NaN  setup<span style=color:#f92672>.</span>py
</span></span></code></pre></div><h3 id=but-yea-thats-okay-i-updated-the-build_texts_from_repository--func-to-ignore-blanks>But yea that&rsquo;s okay, I updated the <code>build_texts_from_repository</code> func to ignore blanks<a hidden class=anchor aria-hidden=true href=#but-yea-thats-okay-i-updated-the-build_texts_from_repository--func-to-ignore-blanks>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>build_texts_from_repository</span>(repo_dir):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Return a dataset of the non-blank lines of code
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    dataset <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> path <span style=color:#f92672>in</span> chain(
</span></span><span style=display:flex><span>        Path(repo_dir)<span style=color:#f92672>.</span>glob(<span style=color:#e6db74>&#34;**/*.py&#34;</span>),
</span></span><span style=display:flex><span>        Path(repo_dir)<span style=color:#f92672>.</span>glob(<span style=color:#e6db74>&#34;**/*.md&#34;</span>),
</span></span><span style=display:flex><span>    ):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> path<span style=color:#f92672>.</span>is_file() <span style=color:#f92672>and</span> path<span style=color:#f92672>.</span>suffix
</span></span><span style=display:flex><span>        lines <span style=color:#f92672>=</span> path<span style=color:#f92672>.</span>read_text()<span style=color:#f92672>.</span>splitlines()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        dataset<span style=color:#f92672>.</span>extend(
</span></span><span style=display:flex><span>            [
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;line_number&#34;</span>: i,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;line&#34;</span>: line,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;path&#34;</span>: str(path<span style=color:#f92672>.</span>relative_to(repo_dir))}
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> i, line <span style=color:#f92672>in</span> enumerate(lines)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> line<span style=color:#f92672>.</span>strip() <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> dataset
</span></span></code></pre></div><p>12:52 slightly updated my func, <code>"build_texts_from_repository"</code> to not include the blank lines or lines with just whitespace also !</p><p>ok trying again,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd 
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> code_search <span style=color:#66d9ef>as</span> cs
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pathlib <span style=color:#f92672>import</span> Path
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> date_utils <span style=color:#f92672>import</span> utc_ts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>repos_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;REPOS_DIR&#34;</span>)
</span></span><span style=display:flex><span>target_dir <span style=color:#f92672>=</span> Path(repos_dir) <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;sentence-transformers&#34;</span>
</span></span><span style=display:flex><span>dataset <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>build_texts_from_repository(target_dir)
</span></span><span style=display:flex><span>workdir <span style=color:#f92672>=</span> Path(repos_dir) <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;code_search&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame<span style=color:#f92672>.</span>from_records(dataset)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Now should be only the non-blank lines,</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;blanks&#34;</span>, df[df<span style=color:#f92672>.</span>line <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>]<span style=color:#f92672>.</span>shape[<span style=color:#ae81ff>0</span>])  <span style=color:#75715e># blanks 0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>path <span style=color:#f92672>=</span> (workdir <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;datasets&#34;</span> <span style=color:#f92672>/</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>utc_ts()<span style=color:#e6db74>}</span><span style=color:#e6db74>-dataset.csv&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;saving&#34;</span>, path<span style=color:#f92672>.</span>relative_to(repos_dir))
</span></span><span style=display:flex><span><span style=color:#75715e># saving code_search/datasets/2023-06-13T170451Z-dataset.csv</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>to_csv(path, index<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>df2 <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(path)
</span></span><span style=display:flex><span>print(df<span style=color:#f92672>.</span>equals(df2))  <span style=color:#75715e># True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># And vanilla python equals?</span>
</span></span><span style=display:flex><span>df2<span style=color:#f92672>.</span>to_dict(orient<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;records&#34;</span>) <span style=color:#f92672>==</span> dataset
</span></span><span style=display:flex><span><span style=color:#75715e># Out[62]: True</span>
</span></span></code></pre></div><p>13:05 ok cool, worked this time !
13:48 save the subset, too,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Only the subset with sentence filenames, </span>
</span></span><span style=display:flex><span>path <span style=color:#f92672>=</span> (workdir <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;datasets&#34;</span> <span style=color:#f92672>/</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>utc_ts()<span style=color:#e6db74>}</span><span style=color:#e6db74>-dataset-sentence-filenames.csv&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;saving&#34;</span>, path<span style=color:#f92672>.</span>relative_to(repos_dir))
</span></span><span style=display:flex><span><span style=color:#75715e># saving code_search/datasets/2023-06-13T174927Z-dataset-sentence-filenames.csv</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame<span style=color:#f92672>.</span>from_records(
</span></span><span style=display:flex><span>    [x <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> dataset <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;Sentence&#34;</span> <span style=color:#f92672>in</span> x[<span style=color:#e6db74>&#34;path&#34;</span>]]
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>to_csv(path, index<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;read equals&#34;</span>, df<span style=color:#f92672>.</span>equals(pd<span style=color:#f92672>.</span>read_csv(path)))  <span style=color:#75715e># read equals True</span>
</span></span></code></pre></div><h2 id=first-lets-build-a-query-set>First let&rsquo;s build a query set<a hidden class=anchor aria-hidden=true href=#first-lets-build-a-query-set>#</a></h2><p>13:37 ok lets run the simplistic search first,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>build_query_dataset</span>(queries, dataset):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Args:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        queries: plain list of strings
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        dataset: list of dictionaries with [&#34;line_number&#34;, &#34;line&#34;, &#34;path&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            Example
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            [{&#39;line_number&#39;: 35,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &#39;line&#39;: &#39;            name = &#34;_&#34;+name&#39;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &#39;path&#39;: &#39;sentence_transformers/evaluation/MSEEvaluatorFromDataFrame.py&#39;},
</span></span></span><span style=display:flex><span><span style=color:#e6db74>             {&#39;line_number&#39;: 110,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &#39;line&#39;: &#39;if not os.path.exists(queries_filepath):&#39;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &#39;path&#39;: &#39;examples/training/ms_marco/train_bi-encoder_mnrl.py&#39;},
</span></span></span><span style=display:flex><span><span style=color:#e6db74>             {&#39;line_number&#39;: 52,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &#39;line&#39;: &#34;tracer = logging.getLogger(&#39;elasticsearch&#39;) &#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &#39;path&#39;: &#39;examples/training/data_augmentation/train_sts_indomain_bm25.py&#39;}]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    search_results <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> query <span style=color:#f92672>in</span> tqdm(queries):
</span></span><span style=display:flex><span>        findings <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            {<span style=color:#e6db74>&#34;query&#34;</span>: query, <span style=color:#f92672>**</span>x
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> dataset <span style=color:#66d9ef>if</span> query <span style=color:#f92672>in</span> x[<span style=color:#e6db74>&#34;line&#34;</span>]
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        search_results<span style=color:#f92672>.</span>extend(findings)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> search_results
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pathlib <span style=color:#f92672>import</span> Path
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> code_search <span style=color:#66d9ef>as</span> cs
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>repos_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;REPOS_DIR&#34;</span>)
</span></span><span style=display:flex><span>path <span style=color:#f92672>=</span> (Path(repos_dir) <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;code_search/datasets/2023-06-13T174927Z-dataset-sentence-filenames.csv&#34;</span>
</span></span><span style=display:flex><span>       )
</span></span><span style=display:flex><span>dataset <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(path)<span style=color:#f92672>.</span>to_dict(orient<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;records&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>queries <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;snapshot_download&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;SentenceEvaluator&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;get_torch_home&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os.path.join&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;flax_model.msgpack&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;torch.nn.functional.normalize&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;BATCH_HARD_TRIPLET_LOSS&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;SentenceTransformer(&#39;model-name&#39;)&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;DEPRECATED: This class is no longer used&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;module_config[&#39;path&#39;]&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;config_sentence_transformers.json&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os.path.join(checkpoint_path, subdir)&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;torch.nn.utils.clip_grad_norm&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;getEffectiveLevel&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;torch.cuda&#34;</span>,
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>search_results <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>build_query_dataset(queries, dataset)
</span></span><span style=display:flex><span><span style=color:#ae81ff>100</span><span style=color:#f92672>%|</span><span style=color:#960050;background-color:#1e0010>███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>14</span><span style=color:#f92672>/</span><span style=color:#ae81ff>14</span> [<span style=color:#ae81ff>00</span>:<span style=color:#ae81ff>00</span><span style=color:#f92672>&lt;</span><span style=color:#ae81ff>00</span>:<span style=color:#ae81ff>00</span>, <span style=color:#ae81ff>6913.96</span>it<span style=color:#f92672>/</span>s]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>In [<span style=color:#ae81ff>5</span>]: len(search_results)
</span></span><span style=display:flex><span>Out[<span style=color:#ae81ff>5</span>]: <span style=color:#ae81ff>43</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>In [<span style=color:#ae81ff>8</span>]: len(queries)
</span></span><span style=display:flex><span>Out[<span style=color:#ae81ff>8</span>]: <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>searchdf <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame<span style=color:#f92672>.</span>from_records(search_results)
</span></span><span style=display:flex><span>searchdf[<span style=color:#e6db74>&#34;query&#34;</span>]<span style=color:#f92672>.</span>value_counts()
</span></span><span style=display:flex><span><span style=color:#75715e># </span>
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                                <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>torch<span style=color:#f92672>.</span>cuda                                   <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>SentenceEvaluator                            <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>config_sentence_transformers<span style=color:#f92672>.</span>json            <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>snapshot_download                            <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>get_torch_home                               <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>flax_model<span style=color:#f92672>.</span>msgpack                           <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>torch<span style=color:#f92672>.</span>nn<span style=color:#f92672>.</span>functional<span style=color:#f92672>.</span>normalize                <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>BATCH_HARD_TRIPLET_LOSS                      <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>SentenceTransformer(<span style=color:#e6db74>&#39;model-name&#39;</span>)            <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>DEPRECATED: This <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>is</span> no longer used     <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>module_config[<span style=color:#e6db74>&#39;path&#39;</span>]                        <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>getEffectiveLevel                            <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Name: query, dtype: int64
</span></span></code></pre></div><p>13:59 ok haha that was instantaneous. Ok so lets evaluate the sentence_transformer accuracy then,
Maybe this is a bit unbalanced, but this is good enough for now.</p><h1 id=and-running-the-query>And running the query<a hidden class=anchor aria-hidden=true href=#and-running-the-query>#</a></h1><h2 id=semantic-search>semantic search<a hidden class=anchor aria-hidden=true href=#semantic-search>#</a></h2><p>And again using the use of semantic_search as nicely described in <a href=https://www.sbert.net/examples/applications/semantic-search/README.html#python>https://www.sbert.net/examples/applications/semantic-search/README.html#python</a> ,</p><p>14:55 For now let&rsquo;s use the number <code>20</code> from above, as the number of results to retrieve for each query, since that is the max number of results we get for any query.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> torch
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pathlib <span style=color:#f92672>import</span> Path
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sentence_transformers <span style=color:#f92672>import</span> SentenceTransformer, util
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sentence_transformers.util <span style=color:#f92672>import</span> semantic_search
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> importlib <span style=color:#f92672>import</span> reload
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> code_search <span style=color:#66d9ef>as</span> cs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hf_token <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;HF_TOKEN&#34;</span>)
</span></span><span style=display:flex><span>embedder <span style=color:#f92672>=</span> SentenceTransformer(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;msmarco-MiniLM-L-6-v3&#39;</span>,
</span></span><span style=display:flex><span>    use_auth_token<span style=color:#f92672>=</span>hf_token,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>repos_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;REPOS_DIR&#34;</span>)
</span></span><span style=display:flex><span>path <span style=color:#f92672>=</span> (Path(repos_dir) <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;code_search/datasets/2023-06-13T174927Z-dataset-sentence-filenames.csv&#34;</span>
</span></span><span style=display:flex><span>       )
</span></span><span style=display:flex><span>dataset <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(path)<span style=color:#f92672>.</span>to_dict(orient<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;records&#34;</span>)
</span></span><span style=display:flex><span>corpus <span style=color:#f92672>=</span> [x[<span style=color:#e6db74>&#34;line&#34;</span>] <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> dataset]
</span></span><span style=display:flex><span>corpus_embeddings <span style=color:#f92672>=</span> embedder<span style=color:#f92672>.</span>encode(corpus, convert_to_tensor<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>queries <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;snapshot_download&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;SentenceEvaluator&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;get_torch_home&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os.path.join&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;flax_model.msgpack&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;torch.nn.functional.normalize&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;BATCH_HARD_TRIPLET_LOSS&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;SentenceTransformer(&#39;model-name&#39;)&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;DEPRECATED: This class is no longer used&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;module_config[&#39;path&#39;]&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;config_sentence_transformers.json&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os.path.join(checkpoint_path, subdir)&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;torch.nn.utils.clip_grad_norm&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;getEffectiveLevel&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;torch.cuda&#34;</span>,
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>top_k <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>  <span style=color:#75715e># hat is the max number of  results we get for any query so far.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>resultsdf <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>run_semantic_search(embedder, dataset, queries, top_k)
</span></span></code></pre></div><h2 id=merge-results>Merge results<a hidden class=anchor aria-hidden=true href=#merge-results>#</a></h2><p>16:46 merging results and initial dataset, the results are pytorch tensors which looks like they are treated as objects in pandas land ,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>ipdb<span style=color:#f92672>&gt;</span> p resultsdf<span style=color:#f92672>.</span>head()
</span></span><span style=display:flex><span>            score          idx              query
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>  tensor(<span style=color:#ae81ff>0.6807</span>)   tensor(<span style=color:#ae81ff>73</span>)  snapshot_download
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>  tensor(<span style=color:#ae81ff>0.5153</span>)   tensor(<span style=color:#ae81ff>24</span>)  snapshot_download
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>  tensor(<span style=color:#ae81ff>0.4511</span>)   tensor(<span style=color:#ae81ff>72</span>)  snapshot_download
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>  tensor(<span style=color:#ae81ff>0.3790</span>)  tensor(<span style=color:#ae81ff>584</span>)  snapshot_download
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>  tensor(<span style=color:#ae81ff>0.3619</span>)   tensor(<span style=color:#ae81ff>55</span>)  snapshot_download
</span></span><span style=display:flex><span>ipdb<span style=color:#f92672>&gt;</span> p resultsdf<span style=color:#f92672>.</span>head()<span style=color:#f92672>.</span>dtypes
</span></span><span style=display:flex><span>score    object
</span></span><span style=display:flex><span>idx      object
</span></span><span style=display:flex><span>query    object
</span></span><span style=display:flex><span>dtype: object
</span></span><span style=display:flex><span>ipdb<span style=color:#f92672>&gt;</span> 
</span></span></code></pre></div><p>so let me cast that,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>ipdb<span style=color:#f92672>&gt;</span> p resultsdf<span style=color:#f92672>.</span>astype({<span style=color:#e6db74>&#34;idx&#34;</span>: <span style=color:#e6db74>&#34;int&#34;</span>, <span style=color:#e6db74>&#34;score&#34;</span>: <span style=color:#e6db74>&#34;float&#34;</span>})<span style=color:#f92672>.</span>merge(truthdf, left_on<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;idx&#34;</span>, right_index<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, how<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;left&#34;</span>)<span style=color:#f92672>.</span>head()
</span></span><span style=display:flex><span>      score  idx              query  line_number                                               line                                          path
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0.680669</span>   <span style=color:#ae81ff>73</span>  snapshot_download           <span style=color:#ae81ff>86</span>                      snapshot_download(model_na<span style=color:#f92672>...</span>  sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0.515324</span>   <span style=color:#ae81ff>24</span>  snapshot_download           <span style=color:#ae81ff>25</span>  <span style=color:#f92672>from</span> .util <span style=color:#f92672>import</span> import_from_string, batch_to<span style=color:#f92672>...</span>  sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>  <span style=color:#ae81ff>0.451125</span>   <span style=color:#ae81ff>72</span>  snapshot_download           <span style=color:#ae81ff>85</span>                      <span style=color:#75715e># Download from hub with c...  sentence_transformers/SentenceTransformer.py</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>0.379038</span>  <span style=color:#ae81ff>584</span>  snapshot_download          <span style=color:#ae81ff>725</span>                                   optimizer<span style=color:#f92672>.</span>step()  sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>  <span style=color:#ae81ff>0.361899</span>   <span style=color:#ae81ff>55</span>  snapshot_download           <span style=color:#ae81ff>62</span>                  cache_folder <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(to<span style=color:#f92672>...</span>  sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span>ipdb<span style=color:#f92672>&gt;</span> 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>In [<span style=color:#ae81ff>25</span>]: <span style=color:#66d9ef>with</span> ipdb<span style=color:#f92672>.</span>launch_ipdb_on_exception():
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>:     resultsdf <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>run_semantic_search(embedder, dataset, queries, top_k)
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>: 
</span></span><span style=display:flex><span><span style=color:#ae81ff>100</span><span style=color:#f92672>%|</span><span style=color:#960050;background-color:#1e0010>████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>14</span><span style=color:#f92672>/</span><span style=color:#ae81ff>14</span> [<span style=color:#ae81ff>00</span>:<span style=color:#ae81ff>00</span><span style=color:#f92672>&lt;</span><span style=color:#ae81ff>00</span>:<span style=color:#ae81ff>00</span>, <span style=color:#ae81ff>100.97</span>it<span style=color:#f92672>/</span>s]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>In [<span style=color:#ae81ff>26</span>]: resultsdf<span style=color:#f92672>.</span>head()
</span></span><span style=display:flex><span>Out[<span style=color:#ae81ff>26</span>]: 
</span></span><span style=display:flex><span>      score              query  line_number                                               line                                          path
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0.680669</span>  snapshot_download           <span style=color:#ae81ff>86</span>                      snapshot_download(model_na<span style=color:#f92672>...</span>  sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0.515324</span>  snapshot_download           <span style=color:#ae81ff>25</span>  <span style=color:#f92672>from</span> .util <span style=color:#f92672>import</span> import_from_string, batch_to<span style=color:#f92672>...</span>  sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>  <span style=color:#ae81ff>0.451125</span>  snapshot_download           <span style=color:#ae81ff>85</span>                      <span style=color:#75715e># Download from hub with c...  sentence_transformers/SentenceTransformer.py</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>0.379038</span>  snapshot_download          <span style=color:#ae81ff>725</span>                                   optimizer<span style=color:#f92672>.</span>step()  sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>  <span style=color:#ae81ff>0.361899</span>  snapshot_download           <span style=color:#ae81ff>62</span>                  cache_folder <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(to<span style=color:#f92672>...</span>  sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py
</span></span></code></pre></div><h2 id=evaluate>Evaluate<a hidden class=anchor aria-hidden=true href=#evaluate>#</a></h2><p>17:11 ok so how to evaluate truth against the results now</p><p>Maybe, given a threshold, like <code>0.5</code> , how many hits and misses.
Perhaps one way to evaluate , would be to left join <code>truthdf</code> with <code>resultsdf</code> in order to count the hits at least. And misses are the left anti-join then.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> date_utils <span style=color:#f92672>import</span> utc_ts
</span></span><span style=display:flex><span>repos_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;REPOS_DIR&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>search_results <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>build_query_dataset(queries, dataset)
</span></span><span style=display:flex><span>truthdf <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame<span style=color:#f92672>.</span>from_records(search_results)
</span></span><span style=display:flex><span>workdir <span style=color:#f92672>=</span> Path(repos_dir) <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;code_search&#34;</span>
</span></span><span style=display:flex><span>In [<span style=color:#ae81ff>37</span>]: set(truthdf<span style=color:#f92672>.</span>columns<span style=color:#f92672>.</span>tolist()) <span style=color:#f92672>&amp;</span> set(resultsdf<span style=color:#f92672>.</span>columns<span style=color:#f92672>.</span>tolist())
</span></span><span style=display:flex><span>Out[<span style=color:#ae81ff>37</span>]: {<span style=color:#e6db74>&#39;line&#39;</span>, <span style=color:#e6db74>&#39;line_number&#39;</span>, <span style=color:#e6db74>&#39;path&#39;</span>, <span style=color:#e6db74>&#39;query&#39;</span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>eval_df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>merge(
</span></span><span style=display:flex><span>    truthdf,
</span></span><span style=display:flex><span>    resultsdf<span style=color:#f92672>.</span>drop([<span style=color:#e6db74>&#34;line&#34;</span>], axis<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>    on<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;query&#34;</span>, <span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#e6db74>&#34;line_number&#34;</span>],
</span></span><span style=display:flex><span>    how<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;left&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>path <span style=color:#f92672>=</span> (workdir 
</span></span><span style=display:flex><span>        <span style=color:#f92672>/</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>utc_ts()<span style=color:#e6db74>}</span><span style=color:#e6db74>-evaldf.csv&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;saving&#34;</span>, path<span style=color:#f92672>.</span>relative_to(repos_dir))
</span></span><span style=display:flex><span><span style=color:#75715e># saving code_search/2023-06-13T213516Z-evaldf.csv</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>eval_df<span style=color:#f92672>.</span>to_csv(path, index<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>In [<span style=color:#ae81ff>46</span>]: eval_df
</span></span><span style=display:flex><span>Out[<span style=color:#ae81ff>46</span>]: 
</span></span><span style=display:flex><span>                                       query  line_number                                               line                                               path     score
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>                          snapshot_download           <span style=color:#ae81ff>25</span>  <span style=color:#f92672>from</span> .util <span style=color:#f92672>import</span> import_from_string, batch_to<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.515324</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>                          snapshot_download           <span style=color:#ae81ff>86</span>                      snapshot_download(model_na<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.680669</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>                          SentenceEvaluator           <span style=color:#ae81ff>24</span>          <span style=color:#f92672>from</span> .evaluation <span style=color:#f92672>import</span> SentenceEvaluator       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.700384</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>                          SentenceEvaluator          <span style=color:#ae81ff>576</span>               evaluator: SentenceEvaluator <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>,       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.749687</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>                          SentenceEvaluator          <span style=color:#ae81ff>756</span>      <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>evaluate</span>(self, evaluator: SentenceEval<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.403172</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>                          SentenceEvaluator            <span style=color:#ae81ff>0</span>                           <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SentenceEvaluator</span>:  sentence_transformers<span style=color:#f92672>/</span>evaluation<span style=color:#f92672>/</span>SentenceEvalu<span style=color:#f92672>...</span>  <span style=color:#ae81ff>0.818287</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>6</span>                             get_torch_home           <span style=color:#ae81ff>56</span>                      <span style=color:#f92672>from</span> torch.hub <span style=color:#f92672>import</span> _get<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.865429</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>7</span>                             get_torch_home           <span style=color:#ae81ff>58</span>                      torch_cache_home <span style=color:#f92672>=</span> _get_to<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.859171</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>8</span>                               os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join           <span style=color:#ae81ff>60</span>                      torch_cache_home <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py       NaN
</span></span><span style=display:flex><span><span style=color:#ae81ff>9</span>                               os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join           <span style=color:#ae81ff>62</span>                  cache_folder <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(to<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py       NaN
</span></span><span style=display:flex><span><span style=color:#ae81ff>10</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join           <span style=color:#ae81ff>82</span>                  model_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(cach<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.662760</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join           <span style=color:#ae81ff>84</span>                  <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(os<span style=color:#f92672>.</span>path<span style=color:#f92672>....</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.737865</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>12</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join           <span style=color:#ae81ff>93</span>              <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(mod<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.704441</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>13</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>362</span>          <span style=color:#66d9ef>with</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(path, <span style=color:#e6db74>&#39;config_s...       sentence_transformers/SentenceTransformer.py       NaN</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>14</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>371</span>                  model_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(path<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.666143</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>15</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>377</span>          <span style=color:#66d9ef>with</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(path, <span style=color:#e6db74>&#39;modules....       sentence_transformers/SentenceTransformer.py  0.623291</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>16</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>428</span>          <span style=color:#66d9ef>with</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(path, <span style=color:#e6db74>&#34;README.m...       sentence_transformers/SentenceTransformer.py  0.619979</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>17</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>487</span>                  create_model_card <span style=color:#f92672>=</span> replace_mo<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py       NaN
</span></span><span style=display:flex><span><span style=color:#ae81ff>18</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>494</span>                      file_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(r<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.800986</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>19</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>520</span>                      shutil<span style=color:#f92672>.</span>rmtree(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py       NaN
</span></span><span style=display:flex><span><span style=color:#ae81ff>20</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>774</span>              eval_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(output_pa<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.621379</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>21</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>788</span>          self<span style=color:#f92672>.</span>save(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(checkpoint_path<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.598843</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>22</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>795</span>                      old_checkpoints<span style=color:#f92672>.</span>append({<span style=color:#e6db74>&#39;s...       sentence_transformers/SentenceTransformer.py       NaN</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>23</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>816</span>          config_sentence_transformers_json_path<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py       NaN
</span></span><span style=display:flex><span><span style=color:#ae81ff>24</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>825</span>          model_card_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(model_p<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.637539</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>25</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>834</span>          modules_json_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(model<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.627189</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>26</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join          <span style=color:#ae81ff>841</span>              module <span style=color:#f92672>=</span> module_class<span style=color:#f92672>.</span>load(os<span style=color:#f92672>.</span>path<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py       NaN
</span></span><span style=display:flex><span><span style=color:#ae81ff>27</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join           <span style=color:#ae81ff>20</span>          <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(self<span style=color:#f92672>.</span>fol<span style=color:#f92672>...</span>  sentence_transformers<span style=color:#f92672>/</span>readers<span style=color:#f92672>/</span>LabelSentenceRea<span style=color:#f92672>...</span>  <span style=color:#ae81ff>0.568704</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>28</span>                        flax_model<span style=color:#f92672>.</span>msgpack           <span style=color:#ae81ff>90</span>                                          ignore<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.427975</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>29</span>             torch<span style=color:#f92672>.</span>nn<span style=color:#f92672>.</span>functional<span style=color:#f92672>.</span>normalize          <span style=color:#ae81ff>183</span>                          embeddings <span style=color:#f92672>=</span> torch<span style=color:#f92672>.</span>nn<span style=color:#f92672>....</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.624402</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>30</span>                   BATCH_HARD_TRIPLET_LOSS           <span style=color:#ae81ff>13</span>      This dataset can be used <span style=color:#66d9ef>for</span> some specific<span style=color:#f92672>...</span>  sentence_transformers<span style=color:#f92672>/</span>datasets<span style=color:#f92672>/</span>SentenceLabelDa<span style=color:#f92672>...</span>  <span style=color:#ae81ff>0.738400</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>31</span>         SentenceTransformer(<span style=color:#e6db74>&#39;model-name&#39;</span>)            <span style=color:#ae81ff>5</span>          model <span style=color:#f92672>=</span> SentenceTransformer(<span style=color:#e6db74>&#39;model-name&#39;</span>)      docs<span style=color:#f92672>/</span>package_reference<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>md  <span style=color:#ae81ff>0.909370</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>32</span>  DEPRECATED: This <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>is</span> no longer used            <span style=color:#ae81ff>8</span>      DEPRECATED: This <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>is</span> no longer used<span style=color:#f92672>.</span> <span style=color:#f92672>...</span>  sentence_transformers<span style=color:#f92672>/</span>datasets<span style=color:#f92672>/</span>SentencesDatase<span style=color:#f92672>...</span>  <span style=color:#ae81ff>0.766369</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>33</span>                     module_config[<span style=color:#e6db74>&#39;path&#39;</span>]          <span style=color:#ae81ff>841</span>              module <span style=color:#f92672>=</span> module_class<span style=color:#f92672>.</span>load(os<span style=color:#f92672>.</span>path<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.627141</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>34</span>         config_sentence_transformers<span style=color:#f92672>.</span>json          <span style=color:#ae81ff>362</span>          <span style=color:#66d9ef>with</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(path, <span style=color:#e6db74>&#39;config_s...       sentence_transformers/SentenceTransformer.py  0.548365</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>35</span>         config_sentence_transformers<span style=color:#f92672>.</span>json          <span style=color:#ae81ff>815</span>          <span style=color:#75715e># Check if the config_sentence_transfo...       sentence_transformers/SentenceTransformer.py  0.662415</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>36</span>         config_sentence_transformers<span style=color:#f92672>.</span>json          <span style=color:#ae81ff>816</span>          config_sentence_transformers_json_path<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.760809</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>37</span>                         getEffectiveLevel          <span style=color:#ae81ff>135</span>              show_progress_bar <span style=color:#f92672>=</span> (logger<span style=color:#f92672>.</span>getEff<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.428602</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>38</span>                                torch<span style=color:#f92672>.</span>cuda          <span style=color:#ae81ff>103</span>              device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cuda&#34;</span> <span style=color:#66d9ef>if</span> torch<span style=color:#f92672>.</span>cuda<span style=color:#f92672>.</span>is_a<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.779811</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>39</span>                                torch<span style=color:#f92672>.</span>cuda          <span style=color:#ae81ff>215</span>                      <span style=color:#66d9ef>if</span> torch<span style=color:#f92672>.</span>cuda<span style=color:#f92672>.</span>is_available():       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.835975</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>40</span>                                torch<span style=color:#f92672>.</span>cuda          <span style=color:#ae81ff>216</span>                  target_devices <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;cuda:</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>fo<span style=color:#f92672>...</span>       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.616090</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>41</span>                                torch<span style=color:#f92672>.</span>cuda          <span style=color:#ae81ff>637</span>                <span style=color:#f92672>from</span> torch.cuda.amp <span style=color:#f92672>import</span> autocast       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.695091</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>42</span>                                torch<span style=color:#f92672>.</span>cuda          <span style=color:#ae81ff>638</span>               scaler <span style=color:#f92672>=</span> torch<span style=color:#f92672>.</span>cuda<span style=color:#f92672>.</span>amp<span style=color:#f92672>.</span>GradScaler()       sentence_transformers<span style=color:#f92672>/</span>SentenceTransformer<span style=color:#f92672>.</span>py  <span style=color:#ae81ff>0.645202</span>
</span></span></code></pre></div><p>see the results slightly better perhaps,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>In [<span style=color:#ae81ff>58</span>]: eval_df[<span style=color:#e6db74>&#34;line&#34;</span>] <span style=color:#f92672>=</span> eval_df[<span style=color:#e6db74>&#34;line&#34;</span>]<span style=color:#f92672>.</span>map(<span style=color:#66d9ef>lambda</span> x:x<span style=color:#f92672>.</span>strip())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>In [<span style=color:#ae81ff>63</span>]: eval_df[[<span style=color:#e6db74>&#34;query&#34;</span>, <span style=color:#e6db74>&#34;line&#34;</span>, <span style=color:#e6db74>&#34;score&#34;</span>]]
</span></span><span style=display:flex><span>Out[<span style=color:#ae81ff>63</span>]: 
</span></span><span style=display:flex><span>                                       query                                                                                                 line     score
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>                          snapshot_download                   <span style=color:#f92672>from</span> .util <span style=color:#f92672>import</span> import_from_string, batch_to_device, fullname, snapshot_download  <span style=color:#ae81ff>0.515324</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>                          snapshot_download                                                                snapshot_download(model_name_or_path,  <span style=color:#ae81ff>0.680669</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>                          SentenceEvaluator                                                            <span style=color:#f92672>from</span> .evaluation <span style=color:#f92672>import</span> SentenceEvaluator  <span style=color:#ae81ff>0.700384</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>                          SentenceEvaluator                                                                 evaluator: SentenceEvaluator <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>,  <span style=color:#ae81ff>0.749687</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>                          SentenceEvaluator                           <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>evaluate</span>(self, evaluator: SentenceEvaluator, output_path: str <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>):  <span style=color:#ae81ff>0.403172</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>                          SentenceEvaluator                                                                             <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SentenceEvaluator</span>:  <span style=color:#ae81ff>0.818287</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>6</span>                             get_torch_home                                                                <span style=color:#f92672>from</span> torch.hub <span style=color:#f92672>import</span> _get_torch_home  <span style=color:#ae81ff>0.865429</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>7</span>                             get_torch_home                                                                 torch_cache_home <span style=color:#f92672>=</span> _get_torch_home()  <span style=color:#ae81ff>0.859171</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>8</span>                               os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join  torch_cache_home <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>expanduser(os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;TORCH_HOME&#39;</span>, os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;XDG_CACHE_...       NaN</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>9</span>                               os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                               cache_folder <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(torch_cache_home, <span style=color:#e6db74>&#39;sentence_transformers&#39;</span>)       NaN
</span></span><span style=display:flex><span><span style=color:#ae81ff>10</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                        model_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(cache_folder, model_name_or_path<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#e6db74>&#34;_&#34;</span>))  <span style=color:#ae81ff>0.662760</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                                     <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(model_path, <span style=color:#e6db74>&#39;modules.json&#39;</span>)):  <span style=color:#ae81ff>0.737865</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>12</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join   <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(model_path, <span style=color:#e6db74>&#39;modules.json&#39;</span>)):    <span style=color:#75715e>#Load as SentenceTransformer model  0.704441</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>13</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                     <span style=color:#66d9ef>with</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(path, <span style=color:#e6db74>&#39;config_sentence_transformers.json&#39;</span>), <span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>as</span> fOut:       NaN
</span></span><span style=display:flex><span><span style=color:#ae81ff>14</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                                  model_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(path, str(idx)<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;_&#34;</span><span style=color:#f92672>+</span>type(module)<span style=color:#f92672>.</span>__name__)  <span style=color:#ae81ff>0.666143</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>15</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                                          <span style=color:#66d9ef>with</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(path, <span style=color:#e6db74>&#39;modules.json&#39;</span>), <span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>as</span> fOut:  <span style=color:#ae81ff>0.623291</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>16</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                            <span style=color:#66d9ef>with</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(path, <span style=color:#e6db74>&#34;README.md&#34;</span>), <span style=color:#e6db74>&#34;w&#34;</span>, encoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;utf8&#39;</span>) <span style=color:#66d9ef>as</span> fOut:  <span style=color:#ae81ff>0.619979</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>17</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join     create_model_card <span style=color:#f92672>=</span> replace_model_card <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(tmp_dir, <span style=color:#e6db74>&#39;README.md&#39;</span>))       NaN
</span></span><span style=display:flex><span><span style=color:#ae81ff>18</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                                                             file_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(root, filename)  <span style=color:#ae81ff>0.800986</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>19</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                                         shutil<span style=color:#f92672>.</span>rmtree(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(tmp_dir, f), onerror<span style=color:#f92672>=</span>on_rm_error)       NaN
</span></span><span style=display:flex><span><span style=color:#ae81ff>20</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                                                        eval_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(output_path, <span style=color:#e6db74>&#34;eval&#34;</span>)  <span style=color:#ae81ff>0.621379</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>21</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                                                  self<span style=color:#f92672>.</span>save(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(checkpoint_path, str(step)))  <span style=color:#ae81ff>0.598843</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>22</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join         old_checkpoints<span style=color:#f92672>.</span>append({<span style=color:#e6db74>&#39;step&#39;</span>: int(subdir), <span style=color:#e6db74>&#39;path&#39;</span>: os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(checkpoint_path, subdir)})       NaN
</span></span><span style=display:flex><span><span style=color:#ae81ff>23</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join  config_sentence_transformers_json_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(model_path, <span style=color:#e6db74>&#39;config_sentence_transformers....       NaN</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>24</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                                              model_card_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(model_path, <span style=color:#e6db74>&#39;README.md&#39;</span>)  <span style=color:#ae81ff>0.637539</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>25</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                                         modules_json_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(model_path, <span style=color:#e6db74>&#39;modules.json&#39;</span>)  <span style=color:#ae81ff>0.627189</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>26</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                          module <span style=color:#f92672>=</span> module_class<span style=color:#f92672>.</span>load(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(model_path, module_config[<span style=color:#e6db74>&#39;path&#39;</span>]))       NaN
</span></span><span style=display:flex><span><span style=color:#ae81ff>27</span>                              os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join                             <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(self<span style=color:#f92672>.</span>folder, filename), encoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;utf-8&#34;</span>):  <span style=color:#ae81ff>0.568704</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>28</span>                        flax_model<span style=color:#f92672>.</span>msgpack                                 ignore_files<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;flax_model.msgpack&#39;</span>, <span style=color:#e6db74>&#39;rust_model.ot&#39;</span>, <span style=color:#e6db74>&#39;tf_model.h5&#39;</span>],  <span style=color:#ae81ff>0.427975</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>29</span>             torch<span style=color:#f92672>.</span>nn<span style=color:#f92672>.</span>functional<span style=color:#f92672>.</span>normalize                                   embeddings <span style=color:#f92672>=</span> torch<span style=color:#f92672>.</span>nn<span style=color:#f92672>.</span>functional<span style=color:#f92672>.</span>normalize(embeddings, p<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, dim<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)  <span style=color:#ae81ff>0.624402</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>30</span>                   BATCH_HARD_TRIPLET_LOSS  This dataset can be used <span style=color:#66d9ef>for</span> some specific Triplet Losses like BATCH_HARD_TRIPLET_LOSS which req<span style=color:#f92672>...</span>  <span style=color:#ae81ff>0.738400</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>31</span>         SentenceTransformer(<span style=color:#e6db74>&#39;model-name&#39;</span>)                                                            model <span style=color:#f92672>=</span> SentenceTransformer(<span style=color:#e6db74>&#39;model-name&#39;</span>)  <span style=color:#ae81ff>0.909370</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>32</span>  DEPRECATED: This <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>is</span> no longer used  DEPRECATED: This <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>is</span> no longer used<span style=color:#f92672>.</span> Instead of wrapping your List of InputExamples <span style=color:#f92672>in</span> a Se<span style=color:#f92672>...</span>  <span style=color:#ae81ff>0.766369</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>33</span>                     module_config[<span style=color:#e6db74>&#39;path&#39;</span>]                          module <span style=color:#f92672>=</span> module_class<span style=color:#f92672>.</span>load(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(model_path, module_config[<span style=color:#e6db74>&#39;path&#39;</span>]))  <span style=color:#ae81ff>0.627141</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>34</span>         config_sentence_transformers<span style=color:#f92672>.</span>json                     <span style=color:#66d9ef>with</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(path, <span style=color:#e6db74>&#39;config_sentence_transformers.json&#39;</span>), <span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>as</span> fOut:  <span style=color:#ae81ff>0.548365</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>35</span>         config_sentence_transformers<span style=color:#f92672>.</span>json      <span style=color:#75715e># Check if the config_sentence_transformers.json file exists (exists since v2 of the framework)  0.662415</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>36</span>         config_sentence_transformers<span style=color:#f92672>.</span>json  config_sentence_transformers_json_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(model_path, <span style=color:#e6db74>&#39;config_sentence_transformers....  0.760809</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>37</span>                         getEffectiveLevel  show_progress_bar <span style=color:#f92672>=</span> (logger<span style=color:#f92672>.</span>getEffectiveLevel()<span style=color:#f92672>==</span>logging<span style=color:#f92672>.</span>INFO <span style=color:#f92672>or</span> logger<span style=color:#f92672>.</span>getEffectiveLevel()<span style=color:#f92672>==</span>log<span style=color:#f92672>...</span>  <span style=color:#ae81ff>0.428602</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>38</span>                                torch<span style=color:#f92672>.</span>cuda                                              device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cuda&#34;</span> <span style=color:#66d9ef>if</span> torch<span style=color:#f92672>.</span>cuda<span style=color:#f92672>.</span>is_available() <span style=color:#66d9ef>else</span> <span style=color:#e6db74>&#34;cpu&#34;</span>  <span style=color:#ae81ff>0.779811</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>39</span>                                torch<span style=color:#f92672>.</span>cuda                                                                        <span style=color:#66d9ef>if</span> torch<span style=color:#f92672>.</span>cuda<span style=color:#f92672>.</span>is_available():  <span style=color:#ae81ff>0.835975</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>40</span>                                torch<span style=color:#f92672>.</span>cuda                     target_devices <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;cuda:</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(i) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(torch<span style=color:#f92672>.</span>cuda<span style=color:#f92672>.</span>device_count())]  <span style=color:#ae81ff>0.616090</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>41</span>                                torch<span style=color:#f92672>.</span>cuda                                                                  <span style=color:#f92672>from</span> torch.cuda.amp <span style=color:#f92672>import</span> autocast  <span style=color:#ae81ff>0.695091</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>42</span>                                torch<span style=color:#f92672>.</span>cuda                                                                 scaler <span style=color:#f92672>=</span> torch<span style=color:#f92672>.</span>cuda<span style=color:#f92672>.</span>amp<span style=color:#f92672>.</span>GradScaler()  <span style=color:#ae81ff>0.645202</span>
</span></span></code></pre></div><p>17:40 ok cool , although wonder how not all the &ldquo;os.path.join&rdquo; lines were matched. Maybe some debugging to do.
Also should still built the [[anti join]] to get the misses aka [[false-positive]] too.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://michal.piekarczyk.xyz/post/2023-06-25-everybody-loves-reynauds/><span class=title>« Prev</span><br><span>everybody loves reynauds</span>
</a><a class=next href=https://michal.piekarczyk.xyz/post/2023-06-12-logseq-publish-hugo-with-python/><span class=title>Next »</span><br><span>logseq publish hugo with python</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://michal.piekarczyk.xyz/>michal.piekarczyk.xyz</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>