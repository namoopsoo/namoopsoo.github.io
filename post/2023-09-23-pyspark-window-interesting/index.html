<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Odd pyspark window function behavior | michal.piekarczyk.xyz</title>
<meta name=keywords content><meta name=description content="I was working through some odd window function behavior Analyzing some feature drift data, I wanted to obtain min, max and mean drift values for features, partitioning on the compare_date here. I would have just done a group by, but I also wanted to get the baseline_date relevant to the largest drift score and so I went with the below approach. But I ended up with some strange results.
from pyspark."><meta name=author content="Michal Piekarczyk"><link rel=canonical href=https://michal.piekarczyk.xyz/post/2023-09-23-pyspark-window-interesting/><link crossorigin=anonymous href=/assets/css/stylesheet.dd867d536fb6202811c1ee15fa181ef8945826662b49d3016ac91365a2621d58.css integrity="sha256-3YZ9U2+2ICgRwe4V+hge+JRYJmYrSdMBaskTZaJiHVg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://michal.piekarczyk.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://michal.piekarczyk.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://michal.piekarczyk.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://michal.piekarczyk.xyz/apple-touch-icon.png><link rel=mask-icon href=https://michal.piekarczyk.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-74MK08REDT"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-74MK08REDT",{anonymize_ip:!1})}</script><meta property="og:title" content="Odd pyspark window function behavior"><meta property="og:description" content="I was working through some odd window function behavior Analyzing some feature drift data, I wanted to obtain min, max and mean drift values for features, partitioning on the compare_date here. I would have just done a group by, but I also wanted to get the baseline_date relevant to the largest drift score and so I went with the below approach. But I ended up with some strange results.
from pyspark."><meta property="og:type" content="article"><meta property="og:url" content="https://michal.piekarczyk.xyz/post/2023-09-23-pyspark-window-interesting/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-09-23T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-23T12:39:45-04:00"><meta property="og:site_name" content="michal.piekarczyk.xyz"><meta name=twitter:card content="summary"><meta name=twitter:title content="Odd pyspark window function behavior"><meta name=twitter:description content="I was working through some odd window function behavior Analyzing some feature drift data, I wanted to obtain min, max and mean drift values for features, partitioning on the compare_date here. I would have just done a group by, but I also wanted to get the baseline_date relevant to the largest drift score and so I went with the below approach. But I ended up with some strange results.
from pyspark."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://michal.piekarczyk.xyz/post/"},{"@type":"ListItem","position":2,"name":"Odd pyspark window function behavior","item":"https://michal.piekarczyk.xyz/post/2023-09-23-pyspark-window-interesting/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Odd pyspark window function behavior","name":"Odd pyspark window function behavior","description":"I was working through some odd window function behavior Analyzing some feature drift data, I wanted to obtain min, max and mean drift values for features, partitioning on the compare_date here. I would have just done a group by, but I also wanted to get the baseline_date relevant to the largest drift score and so I went with the below approach. But I ended up with some strange results.\nfrom pyspark.","keywords":[],"articleBody":"I was working through some odd window function behavior Analyzing some feature drift data, I wanted to obtain min, max and mean drift values for features, partitioning on the compare_date here. I would have just done a group by, but I also wanted to get the baseline_date relevant to the largest drift score and so I went with the below approach. But I ended up with some strange results.\nfrom pyspark.sql.window import Window import pyspark.sql.functions as F toy_df = spark.createDataFrame( [{'feature': 'feat1', 'category': 'cat1', 'Drift score': 0.0, 'group': 'blah', 'baseline_date': '20191231', 'compare_date': '20230131'}, {'feature': 'feat1', 'category': 'cat1', 'Drift score': 0.0, 'group': 'blah', 'baseline_date': '20220131', 'compare_date': '20230131'}, {'feature': 'feat1', 'category': 'cat1', 'Drift score': 0.0, 'group': 'blah', 'baseline_date': '20220731', 'compare_date': '20230131'}, {'feature': 'feat2', 'category': 'cat1', 'Drift score': 0.16076398135644604, 'group': 'blah', 'baseline_date': '20191231', 'compare_date': '20230131'}, {'feature': 'feat2', 'category': 'cat1', 'Drift score': 0.07818495131083669, 'group': 'blah', 'baseline_date': '20220131', 'compare_date': '20230131'}, {'feature': 'feat2', 'category': 'cat1', 'Drift score': 0.07164427544566881, 'group': 'blah', 'baseline_date': '20220731', 'compare_date': '20230131'}, {'feature': 'feat3', 'category': 'cat1', 'Drift score': 0.2018208744775895, 'group': 'blah', 'baseline_date': '20191231', 'compare_date': '20230131'}, {'feature': 'feat3', 'category': 'cat1', 'Drift score': 0.06897468871439233, 'group': 'blah', 'baseline_date': '20220131', 'compare_date': '20230131'}, {'feature': 'feat3', 'category': 'cat1', 'Drift score': 0.07111383432227428, 'group': 'blah', 'baseline_date': '20220731', 'compare_date': '20230131'}, {'feature': 'feat5', 'category': 'cat1', 'Drift score': 0.20151850543660316, 'group': 'blah', 'baseline_date': '20191231', 'compare_date': '20230131'}, {'feature': 'feat5', 'category': 'cat1', 'Drift score': 0.05584133483840621, 'group': 'blah', 'baseline_date': '20220131', 'compare_date': '20230131'}, {'feature': 'feat5', 'category': 'cat1', 'Drift score': 0.056223672793567, 'group': 'blah', 'baseline_date': '20220731', 'compare_date': '20230131'}, {'feature': 'feat6', 'category': 'cat1', 'Drift score': 0.10648175064912868, 'group': 'blah', 'baseline_date': '20191231', 'compare_date': '20230131'}, {'feature': 'feat6', 'category': 'cat1', 'Drift score': 0.03398787644288803, 'group': 'blah', 'baseline_date': '20220131', 'compare_date': '20230131'}, {'feature': 'feat6', 'category': 'cat1', 'Drift score': 0.027693531284292805, 'group': 'blah', 'baseline_date': '20220731', 'compare_date': '20230131'}, {'feature': 'feat7', 'category': 'cat1', 'Drift score': 0.12696742943404185, 'group': 'blah', 'baseline_date': '20191231', 'compare_date': '20230131'}, {'feature': 'feat7', 'category': 'cat1', 'Drift score': 0.07147622765870758, 'group': 'blah', 'baseline_date': '20220131', 'compare_date': '20230131'}, {'feature': 'feat7', 'category': 'cat1', 'Drift score': 0.07478091185430771, 'group': 'blah', 'baseline_date': '20220731', 'compare_date': '20230131'}, {'feature': 'feat8', 'category': 'cat2', 'Drift score': 0.11779958630386245, 'group': 'blah', 'baseline_date': '20191231', 'compare_date': '20230131'}, {'feature': 'feat8', 'category': 'cat2', 'Drift score': 0.04240444683921199, 'group': 'blah', 'baseline_date': '20220131', 'compare_date': '20230131'}] ) toy_df.show() +--------------------+-------------+--------+------------+-------+-----+ | Drift score|baseline_date|category|compare_date|feature|group| +--------------------+-------------+--------+------------+-------+-----+ | 0.0| 20191231| cat1| 20230131| feat1| blah| | 0.0| 20220131| cat1| 20230131| feat1| blah| | 0.0| 20220731| cat1| 20230131| feat1| blah| | 0.16076398135644604| 20191231| cat1| 20230131| feat2| blah| | 0.07818495131083669| 20220131| cat1| 20230131| feat2| blah| | 0.07164427544566881| 20220731| cat1| 20230131| feat2| blah| | 0.2018208744775895| 20191231| cat1| 20230131| feat3| blah| | 0.06897468871439233| 20220131| cat1| 20230131| feat3| blah| | 0.07111383432227428| 20220731| cat1| 20230131| feat3| blah| | 0.20151850543660316| 20191231| cat1| 20230131| feat5| blah| | 0.05584133483840621| 20220131| cat1| 20230131| feat5| blah| | 0.056223672793567| 20220731| cat1| 20230131| feat5| blah| | 0.10648175064912868| 20191231| cat1| 20230131| feat6| blah| | 0.03398787644288803| 20220131| cat1| 20230131| feat6| blah| |0.027693531284292805| 20220731| cat1| 20230131| feat6| blah| | 0.12696742943404185| 20191231| cat1| 20230131| feat7| blah| | 0.07147622765870758| 20220131| cat1| 20230131| feat7| blah| | 0.07478091185430771| 20220731| cat1| 20230131| feat7| blah| | 0.11779958630386245| 20191231| cat2| 20230131| feat8| blah| | 0.04240444683921199| 20220131| cat2| 20230131| feat8| blah| +--------------------+-------------+--------+------------+-------+-----+ Applying the window function here, w = Window.partitionBy(\"group\", \"feature\", \"compare_date\", ).orderBy(F.col(\"Drift score\").desc()) ( toy_df .withColumn(\"mean_score\", F.round(F.mean(\"Drift score\").over(w), 4)) .withColumn(\"max_score\", F.round(F.max(\"Drift score\").over(w), 4)) .withColumn(\"min_score\", F.round(F.min(\"Drift score\").over(w), 4)) .withColumn(\"baseline_date_max_score\", F.first(\"baseline_date\").over(w)) .withColumn(\"row_num\", F.row_number().over(w)) .where(F.col(\"row_num\") == 1) .drop(\"row_num\") .select(\"category\", \"feature\", \"compare_date\", \"mean_score\", \"max_score\", \"min_score\", \"baseline_date_max_score\") .show() ) +--------+-------+------------+----------+---------+---------+-----------------------+ |category|feature|compare_date|mean_score|max_score|min_score|baseline_date_max_score| +--------+-------+------------+----------+---------+---------+-----------------------+ | cat1| feat1| 20230131| 0.0| 0.0| 0.0| 20191231| | cat1| feat2| 20230131| 0.1608| 0.1608| 0.1608| 20191231| | cat1| feat3| 20230131| 0.2018| 0.2018| 0.2018| 20191231| | cat1| feat5| 20230131| 0.2015| 0.2015| 0.2015| 20191231| | cat1| feat6| 20230131| 0.1065| 0.1065| 0.1065| 20191231| | cat1| feat7| 20230131| 0.127| 0.127| 0.127| 20191231| | cat2| feat8| 20230131| 0.1178| 0.1178| 0.1178| 20191231| +--------+-------+------------+----------+---------+---------+-----------------------+ I was confused why are the min, max and mean all the same. I thought, could it be my data is corrupted and some of my partitions only have one row?\nI took out the filter by ‚Äúrow_num‚Äù, to try debugging,\nw = Window.partitionBy(\"group\", \"feature\", \"compare_date\", ).orderBy(F.col(\"Drift score\").desc()) ( toy_df .withColumn(\"mean_score\", F.round(F.mean(\"Drift score\").over(w), 4)) .withColumn(\"max_score\", F.round(F.max(\"Drift score\").over(w), 4)) .withColumn(\"min_score\", F.round(F.min(\"Drift score\").over(w), 4)) .withColumn(\"baseline_date_max_score\", F.first(\"baseline_date\").over(w)) .withColumn(\"row_num\", F.row_number().over(w)) .select(\"category\", \"feature\", \"compare_date\", \"Drift score\" , \"mean_score\", \"max_score\", \"min_score\", ) .show() ) +--------+-------+------------+--------------------+----------+---------+---------+ |category|feature|compare_date| Drift score|mean_score|max_score|min_score| +--------+-------+------------+--------------------+----------+---------+---------+ | cat1| feat1| 20230131| 0.0| 0.0| 0.0| 0.0| | cat1| feat1| 20230131| 0.0| 0.0| 0.0| 0.0| | cat1| feat1| 20230131| 0.0| 0.0| 0.0| 0.0| | cat1| feat2| 20230131| 0.16076398135644604| 0.1608| 0.1608| 0.1608| | cat1| feat2| 20230131| 0.07818495131083669| 0.1195| 0.1608| 0.0782| | cat1| feat2| 20230131| 0.07164427544566881| 0.1035| 0.1608| 0.0716| | cat1| feat3| 20230131| 0.2018208744775895| 0.2018| 0.2018| 0.2018| | cat1| feat3| 20230131| 0.07111383432227428| 0.1365| 0.2018| 0.0711| | cat1| feat3| 20230131| 0.06897468871439233| 0.114| 0.2018| 0.069| | cat1| feat5| 20230131| 0.20151850543660316| 0.2015| 0.2015| 0.2015| | cat1| feat5| 20230131| 0.056223672793567| 0.1289| 0.2015| 0.0562| | cat1| feat5| 20230131| 0.05584133483840621| 0.1045| 0.2015| 0.0558| | cat1| feat6| 20230131| 0.10648175064912868| 0.1065| 0.1065| 0.1065| | cat1| feat6| 20230131| 0.03398787644288803| 0.0702| 0.1065| 0.034| | cat1| feat6| 20230131|0.027693531284292805| 0.0561| 0.1065| 0.0277| | cat1| feat7| 20230131| 0.12696742943404185| 0.127| 0.127| 0.127| | cat1| feat7| 20230131| 0.07478091185430771| 0.1009| 0.127| 0.0748| | cat1| feat7| 20230131| 0.07147622765870758| 0.0911| 0.127| 0.0715| | cat2| feat8| 20230131| 0.11779958630386245| 0.1178| 0.1178| 0.1178| | cat2| feat8| 20230131| 0.04240444683921199| 0.0801| 0.1178| 0.0424| +--------+-------+------------+--------------------+----------+---------+---------+ Now this looked even more weird, since somehow the min, max and mean were different for different rows in the partitions. I forget where, I read somewhere that the use of the orderBy, which I needed for one of the columns, was creating a weird situation for the min max mean columns, so I took that out.\nEnded up with w = Window.partitionBy(\"group\", \"feature\", \"compare_date\", ) ( toy_df .withColumn(\"mean_score\", F.round(F.mean(\"Drift score\").over(w), 4)) .withColumn(\"max_score\", F.round(F.max(\"Drift score\").over(w), 4)) .withColumn(\"min_score\", F.round(F.min(\"Drift score\").over(w), 4)) .withColumn(\"baseline_date_max_score\", F.first(\"baseline_date\").over(w.orderBy(F.col(\"Drift score\").desc()))) .withColumn(\"row_num\", F.row_number().over(w.orderBy(\"Drift score\"))) .select(\"category\", \"feature\", \"compare_date\", \"Drift score\" , \"mean_score\", \"max_score\", \"min_score\", \"baseline_date_max_score\" ) .show() ) +--------+-------+------------+--------------------+----------+---------+---------+-----------------------+ |category|feature|compare_date| Drift score|mean_score|max_score|min_score|baseline_date_max_score| +--------+-------+------------+--------------------+----------+---------+---------+-----------------------+ | cat1| feat1| 20230131| 0.0| 0.0| 0.0| 0.0| 20191231| | cat1| feat1| 20230131| 0.0| 0.0| 0.0| 0.0| 20191231| | cat1| feat1| 20230131| 0.0| 0.0| 0.0| 0.0| 20191231| | cat1| feat2| 20230131| 0.16076398135644604| 0.1035| 0.1608| 0.0716| 20191231| | cat1| feat2| 20230131| 0.07818495131083669| 0.1035| 0.1608| 0.0716| 20191231| | cat1| feat2| 20230131| 0.07164427544566881| 0.1035| 0.1608| 0.0716| 20191231| | cat1| feat3| 20230131| 0.2018208744775895| 0.114| 0.2018| 0.069| 20191231| | cat1| feat3| 20230131| 0.07111383432227428| 0.114| 0.2018| 0.069| 20191231| | cat1| feat3| 20230131| 0.06897468871439233| 0.114| 0.2018| 0.069| 20191231| | cat1| feat5| 20230131| 0.20151850543660316| 0.1045| 0.2015| 0.0558| 20191231| | cat1| feat5| 20230131| 0.056223672793567| 0.1045| 0.2015| 0.0558| 20191231| | cat1| feat5| 20230131| 0.05584133483840621| 0.1045| 0.2015| 0.0558| 20191231| | cat1| feat6| 20230131| 0.10648175064912868| 0.0561| 0.1065| 0.0277| 20191231| | cat1| feat6| 20230131| 0.03398787644288803| 0.0561| 0.1065| 0.0277| 20191231| | cat1| feat6| 20230131|0.027693531284292805| 0.0561| 0.1065| 0.0277| 20191231| | cat1| feat7| 20230131| 0.12696742943404185| 0.0911| 0.127| 0.0715| 20191231| | cat1| feat7| 20230131| 0.07478091185430771| 0.0911| 0.127| 0.0715| 20191231| | cat1| feat7| 20230131| 0.07147622765870758| 0.0911| 0.127| 0.0715| 20191231| | cat2| feat8| 20230131| 0.11779958630386245| 0.0801| 0.1178| 0.0424| 20191231| | cat2| feat8| 20230131| 0.04240444683921199| 0.0801| 0.1178| 0.0424| 20191231| +--------+-------+------------+--------------------+----------+---------+---------+-----------------------+ Finally Can now filter out the non aggregate rows\nw = Window.partitionBy(\"group\", \"feature\", \"compare_date\", ) ( toy_df .withColumn(\"mean_score\", F.round(F.mean(\"Drift score\").over(w), 4)) .withColumn(\"max_score\", F.round(F.max(\"Drift score\").over(w), 4)) .withColumn(\"min_score\", F.round(F.min(\"Drift score\").over(w), 4)) .withColumn(\"baseline_date_max_score\", F.first(\"baseline_date\").over(w.orderBy(F.col(\"Drift score\").desc()))) .withColumn(\"row_num\", F.row_number().over(w.orderBy(\"Drift score\"))) .where(F.col(\"row_num\") == 1) .drop(\"row_num\") .select(\"category\", \"feature\", \"compare_date\", \"mean_score\", \"max_score\", \"min_score\", \"baseline_date_max_score\" ) .show() ) +--------+-------+------------+----------+---------+---------+-----------------------+ |category|feature|compare_date|mean_score|max_score|min_score|baseline_date_max_score| +--------+-------+------------+----------+---------+---------+-----------------------+ | cat1| feat1| 20230131| 0.0| 0.0| 0.0| 20191231| | cat1| feat2| 20230131| 0.1035| 0.1608| 0.0716| 20191231| | cat1| feat3| 20230131| 0.114| 0.2018| 0.069| 20191231| | cat1| feat5| 20230131| 0.1045| 0.2015| 0.0558| 20191231| | cat1| feat6| 20230131| 0.0561| 0.1065| 0.0277| 20191231| | cat1| feat7| 20230131| 0.0911| 0.127| 0.0715| 20191231| | cat2| feat8| 20230131| 0.0801| 0.1178| 0.0424| 20191231| +--------+-------+------------+----------+---------+---------+-----------------------+ What explains this odd behavior?\nFace palm ! I did not notice this at the time, but a colleague pointed out ü§¶‚Äç‚ôÇÔ∏è that although min, max, mean don‚Äôt require orderBy, but when providing it, they will offer cumulative quantities. Indeed spot checking this he was right ! Nice üòÄ\n","wordCount":"1275","inLanguage":"en","datePublished":"2023-09-23T00:00:00Z","dateModified":"2023-09-23T12:39:45-04:00","author":{"@type":"Person","name":"Michal Piekarczyk"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://michal.piekarczyk.xyz/post/2023-09-23-pyspark-window-interesting/"},"publisher":{"@type":"Organization","name":"michal.piekarczyk.xyz","logo":{"@type":"ImageObject","url":"https://michal.piekarczyk.xyz/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://michal.piekarczyk.xyz/ accesskey=h title="michal.piekarczyk.xyz (Alt + H)">michal.piekarczyk.xyz</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://michal.piekarczyk.xyz/post/ title=posts><span>posts</span></a></li><li><a href=https://michal.piekarczyk.xyz/project/ title=projects><span>projects</span></a></li><li><a href=https://michal.piekarczyk.xyz/handy/ title=handy><span>handy</span></a></li><li><a href=https://michal.piekarczyk.xyz/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://michal.piekarczyk.xyz/about/ title=about><span>about</span></a></li><li><a href=https://world.hey.com/michal.piekarczyk title=frivolity><span>frivolity</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://michal.piekarczyk.xyz/>Home</a>&nbsp;¬ª&nbsp;<a href=https://michal.piekarczyk.xyz/post/>Posts</a></div><h1 class=post-title>Odd pyspark window function behavior</h1><div class=post-meta>&lt;span title='2023-09-23 00:00:00 +0000 UTC'>September 23, 2023&lt;/span>&amp;nbsp;¬∑&amp;nbsp;6 min&amp;nbsp;¬∑&amp;nbsp;1275 words&amp;nbsp;¬∑&amp;nbsp;Michal Piekarczyk</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#i-was-working-through-some-odd-window-function-behavior>I was working through some odd window function behavior</a></li><li><a href=#applying-the-window-function-here>Applying the window function here,</a><ul><li><a href=#now-this-looked-even-more-weird-since-somehow-the-min-max-and-mean-were-different-for-different-rows-in-the-partitions>Now this looked even more weird, since somehow the min, max and mean were different for different rows in the partitions.</a></li></ul></li><li><a href=#ended--up-with>Ended up with</a></li><li><a href=#finally>Finally</a></li><li><a href=#face-palm->Face palm !</a></li></ul></nav></div></details></div><div class=post-content><h2 id=i-was-working-through-some-odd-window-function-behavior>I was working through some odd window function behavior<a hidden class=anchor aria-hidden=true href=#i-was-working-through-some-odd-window-function-behavior>#</a></h2><p>Analyzing some feature drift data, I wanted to obtain min, max and mean drift values for features, partitioning on the <code>compare_date</code> here.
I would have just done a group by, but I also wanted to get the <code>baseline_date</code> relevant to the largest drift score and so I went with the below approach.
But I ended up with some strange results.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pyspark.sql.window <span style=color:#f92672>import</span> Window
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pyspark.sql.functions <span style=color:#66d9ef>as</span> F
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>toy_df <span style=color:#f92672>=</span> spark<span style=color:#f92672>.</span>createDataFrame(
</span></span><span style=display:flex><span>    [{<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat1&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.0</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20191231&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat1&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.0</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220131&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat1&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.0</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220731&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat2&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.16076398135644604</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20191231&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat2&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.07818495131083669</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220131&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat2&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.07164427544566881</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220731&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat3&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.2018208744775895</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20191231&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat3&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.06897468871439233</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220131&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat3&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.07111383432227428</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220731&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat5&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.20151850543660316</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20191231&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat5&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.05584133483840621</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220131&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat5&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.056223672793567</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220731&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat6&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.10648175064912868</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20191231&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat6&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.03398787644288803</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220131&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat6&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.027693531284292805</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220731&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat7&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.12696742943404185</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20191231&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat7&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.07147622765870758</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220131&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat7&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat1&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.07478091185430771</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220731&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat8&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat2&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.11779958630386245</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20191231&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}, {<span style=color:#e6db74>&#39;feature&#39;</span>: <span style=color:#e6db74>&#39;feat8&#39;</span>, <span style=color:#e6db74>&#39;category&#39;</span>: <span style=color:#e6db74>&#39;cat2&#39;</span>, <span style=color:#e6db74>&#39;Drift score&#39;</span>: <span style=color:#ae81ff>0.04240444683921199</span>, <span style=color:#e6db74>&#39;group&#39;</span>: <span style=color:#e6db74>&#39;blah&#39;</span>, <span style=color:#e6db74>&#39;baseline_date&#39;</span>: <span style=color:#e6db74>&#39;20220131&#39;</span>, <span style=color:#e6db74>&#39;compare_date&#39;</span>: <span style=color:#e6db74>&#39;20230131&#39;</span>}]
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>toy_df<span style=color:#f92672>.</span>show()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------------------+-------------+--------+------------+-------+-----+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>         Drift score<span style=color:#f92672>|</span>baseline_date<span style=color:#f92672>|</span>category<span style=color:#f92672>|</span>compare_date<span style=color:#f92672>|</span>feature<span style=color:#f92672>|</span>group<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------------------+-------------+--------+------------+-------+-----+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>                 <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat1<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>                 <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220131</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat1<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>                 <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220731</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat1<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.16076398135644604</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat2<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07818495131083669</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220131</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat2<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07164427544566881</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220731</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat2<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>  <span style=color:#ae81ff>0.2018208744775895</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat3<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.06897468871439233</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220131</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat3<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07111383432227428</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220731</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat3<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.20151850543660316</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat5<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.05584133483840621</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220131</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat5<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.056223672793567</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220731</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat5<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.10648175064912868</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat6<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.03398787644288803</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220131</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat6<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#ae81ff>0.027693531284292805</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220731</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat6<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.12696742943404185</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat7<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07147622765870758</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220131</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat7<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07478091185430771</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220731</span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat7<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.11779958630386245</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>    cat2<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat8<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.04240444683921199</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>20220131</span><span style=color:#f92672>|</span>    cat2<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  feat8<span style=color:#f92672>|</span> blah<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------------------+-------------+--------+------------+-------+-----+</span>
</span></span></code></pre></div><h2 id=applying-the-window-function-here>Applying the window function here,<a hidden class=anchor aria-hidden=true href=#applying-the-window-function-here>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>w <span style=color:#f92672>=</span> Window<span style=color:#f92672>.</span>partitionBy(<span style=color:#e6db74>&#34;group&#34;</span>, <span style=color:#e6db74>&#34;feature&#34;</span>, <span style=color:#e6db74>&#34;compare_date&#34;</span>, )<span style=color:#f92672>.</span>orderBy(F<span style=color:#f92672>.</span>col(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>desc())
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    toy_df
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;mean_score&#34;</span>, F<span style=color:#f92672>.</span>round(F<span style=color:#f92672>.</span>mean(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>over(w), <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;max_score&#34;</span>, F<span style=color:#f92672>.</span>round(F<span style=color:#f92672>.</span>max(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>over(w), <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;min_score&#34;</span>, F<span style=color:#f92672>.</span>round(F<span style=color:#f92672>.</span>min(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>over(w), <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;baseline_date_max_score&#34;</span>, F<span style=color:#f92672>.</span>first(<span style=color:#e6db74>&#34;baseline_date&#34;</span>)<span style=color:#f92672>.</span>over(w))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;row_num&#34;</span>, F<span style=color:#f92672>.</span>row_number()<span style=color:#f92672>.</span>over(w))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>where(F<span style=color:#f92672>.</span>col(<span style=color:#e6db74>&#34;row_num&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>drop(<span style=color:#e6db74>&#34;row_num&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#34;category&#34;</span>, <span style=color:#e6db74>&#34;feature&#34;</span>, <span style=color:#e6db74>&#34;compare_date&#34;</span>, <span style=color:#e6db74>&#34;mean_score&#34;</span>, <span style=color:#e6db74>&#34;max_score&#34;</span>, <span style=color:#e6db74>&#34;min_score&#34;</span>, <span style=color:#e6db74>&#34;baseline_date_max_score&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>show()
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------+-------+------------+----------+---------+---------+-----------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>category<span style=color:#f92672>|</span>feature<span style=color:#f92672>|</span>compare_date<span style=color:#f92672>|</span>mean_score<span style=color:#f92672>|</span>max_score<span style=color:#f92672>|</span>min_score<span style=color:#f92672>|</span>baseline_date_max_score<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------+-------+------------+----------+---------+---------+-----------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>       <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat2<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1608</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1608</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1608</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat3<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.2018</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2018</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2018</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat5<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.2015</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2015</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2015</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat6<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1065</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1065</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1065</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat7<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>0.127</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.127</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.127</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat2<span style=color:#f92672>|</span>  feat8<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1178</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1178</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1178</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------+-------+------------+----------+---------+---------+-----------------------+</span>
</span></span></code></pre></div><p>I was confused why are the min, max and mean all the same. I thought, could it be my data is corrupted and some of my partitions only have one row?</p><p>I took out the filter by &ldquo;row_num&rdquo;, to try debugging,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>w <span style=color:#f92672>=</span> Window<span style=color:#f92672>.</span>partitionBy(<span style=color:#e6db74>&#34;group&#34;</span>, <span style=color:#e6db74>&#34;feature&#34;</span>, <span style=color:#e6db74>&#34;compare_date&#34;</span>, )<span style=color:#f92672>.</span>orderBy(F<span style=color:#f92672>.</span>col(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>desc())
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    toy_df
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;mean_score&#34;</span>, F<span style=color:#f92672>.</span>round(F<span style=color:#f92672>.</span>mean(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>over(w), <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;max_score&#34;</span>, F<span style=color:#f92672>.</span>round(F<span style=color:#f92672>.</span>max(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>over(w), <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;min_score&#34;</span>, F<span style=color:#f92672>.</span>round(F<span style=color:#f92672>.</span>min(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>over(w), <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;baseline_date_max_score&#34;</span>, F<span style=color:#f92672>.</span>first(<span style=color:#e6db74>&#34;baseline_date&#34;</span>)<span style=color:#f92672>.</span>over(w))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;row_num&#34;</span>, F<span style=color:#f92672>.</span>row_number()<span style=color:#f92672>.</span>over(w))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#34;category&#34;</span>, <span style=color:#e6db74>&#34;feature&#34;</span>, <span style=color:#e6db74>&#34;compare_date&#34;</span>, <span style=color:#e6db74>&#34;Drift score&#34;</span> , <span style=color:#e6db74>&#34;mean_score&#34;</span>, <span style=color:#e6db74>&#34;max_score&#34;</span>, <span style=color:#e6db74>&#34;min_score&#34;</span>,  )
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>show()
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------+-------+------------+--------------------+----------+---------+---------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>category<span style=color:#f92672>|</span>feature<span style=color:#f92672>|</span>compare_date<span style=color:#f92672>|</span>         Drift score<span style=color:#f92672>|</span>mean_score<span style=color:#f92672>|</span>max_score<span style=color:#f92672>|</span>min_score<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------+-------+------------+--------------------+----------+---------+---------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>                 <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>       <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>                 <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>       <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>                 <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>       <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat2<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.16076398135644604</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1608</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1608</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1608</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat2<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07818495131083669</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1195</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1608</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0782</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat2<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07164427544566881</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1035</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1608</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0716</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat3<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  <span style=color:#ae81ff>0.2018208744775895</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.2018</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2018</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2018</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat3<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07111383432227428</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1365</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2018</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0711</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat3<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.06897468871439233</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>0.114</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2018</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.069</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat5<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.20151850543660316</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.2015</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2015</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2015</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat5<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.056223672793567</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1289</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2015</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0562</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat5<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.05584133483840621</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1045</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2015</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0558</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat6<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.10648175064912868</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1065</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1065</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1065</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat6<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.03398787644288803</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0702</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1065</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.034</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat6<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span><span style=color:#ae81ff>0.027693531284292805</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0561</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1065</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0277</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat7<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.12696742943404185</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>0.127</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.127</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.127</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat7<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07478091185430771</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1009</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.127</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0748</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat7<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07147622765870758</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0911</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.127</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0715</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat2<span style=color:#f92672>|</span>  feat8<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.11779958630386245</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1178</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1178</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1178</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat2<span style=color:#f92672>|</span>  feat8<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.04240444683921199</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0801</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1178</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0424</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------+-------+------------+--------------------+----------+---------+---------+</span>
</span></span></code></pre></div><h3 id=now-this-looked-even-more-weird-since-somehow-the-min-max-and-mean-were-different-for-different-rows-in-the-partitions>Now this looked even more weird, since somehow the min, max and mean were different for different rows in the partitions.<a hidden class=anchor aria-hidden=true href=#now-this-looked-even-more-weird-since-somehow-the-min-max-and-mean-were-different-for-different-rows-in-the-partitions>#</a></h3><p>I forget where, I read somewhere that the use of the <code>orderBy</code>, which I needed for one of the columns, was creating a weird situation for the min max mean columns, so I took that out.</p><h2 id=ended--up-with>Ended up with<a hidden class=anchor aria-hidden=true href=#ended--up-with>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>w <span style=color:#f92672>=</span> Window<span style=color:#f92672>.</span>partitionBy(<span style=color:#e6db74>&#34;group&#34;</span>, <span style=color:#e6db74>&#34;feature&#34;</span>, <span style=color:#e6db74>&#34;compare_date&#34;</span>, )
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    toy_df
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;mean_score&#34;</span>, F<span style=color:#f92672>.</span>round(F<span style=color:#f92672>.</span>mean(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>over(w), <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;max_score&#34;</span>, F<span style=color:#f92672>.</span>round(F<span style=color:#f92672>.</span>max(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>over(w), <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;min_score&#34;</span>, F<span style=color:#f92672>.</span>round(F<span style=color:#f92672>.</span>min(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>over(w), <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;baseline_date_max_score&#34;</span>, F<span style=color:#f92672>.</span>first(<span style=color:#e6db74>&#34;baseline_date&#34;</span>)<span style=color:#f92672>.</span>over(w<span style=color:#f92672>.</span>orderBy(F<span style=color:#f92672>.</span>col(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>desc())))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;row_num&#34;</span>, F<span style=color:#f92672>.</span>row_number()<span style=color:#f92672>.</span>over(w<span style=color:#f92672>.</span>orderBy(<span style=color:#e6db74>&#34;Drift score&#34;</span>)))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#34;category&#34;</span>, <span style=color:#e6db74>&#34;feature&#34;</span>, <span style=color:#e6db74>&#34;compare_date&#34;</span>, <span style=color:#e6db74>&#34;Drift score&#34;</span> , <span style=color:#e6db74>&#34;mean_score&#34;</span>, <span style=color:#e6db74>&#34;max_score&#34;</span>, <span style=color:#e6db74>&#34;min_score&#34;</span>, <span style=color:#e6db74>&#34;baseline_date_max_score&#34;</span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>show()
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------+-------+------------+--------------------+----------+---------+---------+-----------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>category<span style=color:#f92672>|</span>feature<span style=color:#f92672>|</span>compare_date<span style=color:#f92672>|</span>         Drift score<span style=color:#f92672>|</span>mean_score<span style=color:#f92672>|</span>max_score<span style=color:#f92672>|</span>min_score<span style=color:#f92672>|</span>baseline_date_max_score<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------+-------+------------+--------------------+----------+---------+---------+-----------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>                 <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>       <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>                 <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>       <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>                 <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>       <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat2<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.16076398135644604</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1035</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1608</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0716</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat2<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07818495131083669</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1035</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1608</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0716</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat2<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07164427544566881</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1035</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1608</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0716</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat3<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>  <span style=color:#ae81ff>0.2018208744775895</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>0.114</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2018</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.069</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat3<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07111383432227428</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>0.114</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2018</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.069</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat3<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.06897468871439233</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>0.114</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2018</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.069</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat5<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.20151850543660316</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1045</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2015</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0558</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat5<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.056223672793567</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1045</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2015</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0558</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat5<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.05584133483840621</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1045</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2015</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0558</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat6<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.10648175064912868</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0561</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1065</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0277</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat6<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.03398787644288803</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0561</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1065</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0277</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat6<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span><span style=color:#ae81ff>0.027693531284292805</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0561</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1065</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0277</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat7<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.12696742943404185</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0911</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.127</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0715</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat7<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07478091185430771</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0911</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.127</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0715</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat7<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.07147622765870758</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0911</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.127</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0715</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat2<span style=color:#f92672>|</span>  feat8<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.11779958630386245</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0801</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1178</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0424</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat2<span style=color:#f92672>|</span>  feat8<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span> <span style=color:#ae81ff>0.04240444683921199</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0801</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1178</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0424</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------+-------+------------+--------------------+----------+---------+---------+-----------------------+</span>
</span></span></code></pre></div><h2 id=finally>Finally<a hidden class=anchor aria-hidden=true href=#finally>#</a></h2><p>Can now filter out the non aggregate rows</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>w <span style=color:#f92672>=</span> Window<span style=color:#f92672>.</span>partitionBy(<span style=color:#e6db74>&#34;group&#34;</span>, <span style=color:#e6db74>&#34;feature&#34;</span>, <span style=color:#e6db74>&#34;compare_date&#34;</span>, )
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    toy_df
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;mean_score&#34;</span>, F<span style=color:#f92672>.</span>round(F<span style=color:#f92672>.</span>mean(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>over(w), <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;max_score&#34;</span>, F<span style=color:#f92672>.</span>round(F<span style=color:#f92672>.</span>max(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>over(w), <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;min_score&#34;</span>, F<span style=color:#f92672>.</span>round(F<span style=color:#f92672>.</span>min(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>over(w), <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;baseline_date_max_score&#34;</span>, F<span style=color:#f92672>.</span>first(<span style=color:#e6db74>&#34;baseline_date&#34;</span>)<span style=color:#f92672>.</span>over(w<span style=color:#f92672>.</span>orderBy(F<span style=color:#f92672>.</span>col(<span style=color:#e6db74>&#34;Drift score&#34;</span>)<span style=color:#f92672>.</span>desc())))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;row_num&#34;</span>, F<span style=color:#f92672>.</span>row_number()<span style=color:#f92672>.</span>over(w<span style=color:#f92672>.</span>orderBy(<span style=color:#e6db74>&#34;Drift score&#34;</span>)))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>where(F<span style=color:#f92672>.</span>col(<span style=color:#e6db74>&#34;row_num&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>drop(<span style=color:#e6db74>&#34;row_num&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#34;category&#34;</span>, <span style=color:#e6db74>&#34;feature&#34;</span>, <span style=color:#e6db74>&#34;compare_date&#34;</span>, <span style=color:#e6db74>&#34;mean_score&#34;</span>, <span style=color:#e6db74>&#34;max_score&#34;</span>, <span style=color:#e6db74>&#34;min_score&#34;</span>, <span style=color:#e6db74>&#34;baseline_date_max_score&#34;</span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>show()
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------+-------+------------+----------+---------+---------+-----------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>category<span style=color:#f92672>|</span>feature<span style=color:#f92672>|</span>compare_date<span style=color:#f92672>|</span>mean_score<span style=color:#f92672>|</span>max_score<span style=color:#f92672>|</span>min_score<span style=color:#f92672>|</span>baseline_date_max_score<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------+-------+------------+----------+---------+---------+-----------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat1<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>       <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>0.0</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat2<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1035</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1608</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0716</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat3<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>     <span style=color:#ae81ff>0.114</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2018</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.069</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat5<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.1045</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.2015</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0558</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat6<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0561</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1065</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0277</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat1<span style=color:#f92672>|</span>  feat7<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0911</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.127</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0715</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    cat2<span style=color:#f92672>|</span>  feat8<span style=color:#f92672>|</span>    <span style=color:#ae81ff>20230131</span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>0.0801</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.1178</span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>0.0424</span><span style=color:#f92672>|</span>               <span style=color:#ae81ff>20191231</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------+-------+------------+----------+---------+---------+-----------------------+</span>
</span></span></code></pre></div><p>What explains this odd behavior?</p><h2 id=face-palm->Face palm !<a hidden class=anchor aria-hidden=true href=#face-palm->#</a></h2><p>I did not notice this at the time, but a colleague pointed out ü§¶‚Äç‚ôÇÔ∏è that although min, max, mean don&rsquo;t require orderBy, but when providing it, they will offer cumulative quantities. Indeed spot checking this he was right ! Nice üòÄ</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://michal.piekarczyk.xyz/post/2023-09-24-no-coffee-from-kamira/><span class=title>¬´ Prev</span><br><span>Help diagnose no coffee coming out of your Kamira Espresso Machine</span>
</a><a class=next href=https://michal.piekarczyk.xyz/post/2023-09-10-summary-learning-how-to-learn-coursera/><span class=title>Next ¬ª</span><br><span>summary learning how to learn coursera</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://michal.piekarczyk.xyz/>michal.piekarczyk.xyz</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>