<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Exporting messages from Apple imessages | michal.piekarczyk.xyz</title>
<meta name=keywords content><meta name=description content="The problem Messages have been clogging up my iphone for a while now and at this point, they are taking up maybe 15Gigs. Most of this is photo attchments. I thought an options was to manually go through the phone UI, deleting photo attachments to save space, but I did a bit of this tedium and the storage space did not seem to clear up. Maybe it is delayed? The other alternative is to hit a button that says &ldquo;only keep messages up to a year old&rdquo;."><meta name=author content="Michal Piekarczyk"><link rel=canonical href=https://michal.piekarczyk.xyz/post/2023-12-09-imessage-export/><link crossorigin=anonymous href=/assets/css/stylesheet.dd867d536fb6202811c1ee15fa181ef8945826662b49d3016ac91365a2621d58.css integrity="sha256-3YZ9U2+2ICgRwe4V+hge+JRYJmYrSdMBaskTZaJiHVg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://michal.piekarczyk.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://michal.piekarczyk.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://michal.piekarczyk.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://michal.piekarczyk.xyz/apple-touch-icon.png><link rel=mask-icon href=https://michal.piekarczyk.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-74MK08REDT"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-74MK08REDT",{anonymize_ip:!1})}</script><meta property="og:title" content="Exporting messages from Apple imessages"><meta property="og:description" content="The problem Messages have been clogging up my iphone for a while now and at this point, they are taking up maybe 15Gigs. Most of this is photo attchments. I thought an options was to manually go through the phone UI, deleting photo attachments to save space, but I did a bit of this tedium and the storage space did not seem to clear up. Maybe it is delayed? The other alternative is to hit a button that says &ldquo;only keep messages up to a year old&rdquo;."><meta property="og:type" content="article"><meta property="og:url" content="https://michal.piekarczyk.xyz/post/2023-12-09-imessage-export/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-12-09T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-10T12:37:43-05:00"><meta property="og:site_name" content="michal.piekarczyk.xyz"><meta name=twitter:card content="summary"><meta name=twitter:title content="Exporting messages from Apple imessages"><meta name=twitter:description content="The problem Messages have been clogging up my iphone for a while now and at this point, they are taking up maybe 15Gigs. Most of this is photo attchments. I thought an options was to manually go through the phone UI, deleting photo attachments to save space, but I did a bit of this tedium and the storage space did not seem to clear up. Maybe it is delayed? The other alternative is to hit a button that says &ldquo;only keep messages up to a year old&rdquo;."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://michal.piekarczyk.xyz/post/"},{"@type":"ListItem","position":2,"name":"Exporting messages from Apple imessages","item":"https://michal.piekarczyk.xyz/post/2023-12-09-imessage-export/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Exporting messages from Apple imessages","name":"Exporting messages from Apple imessages","description":"The problem Messages have been clogging up my iphone for a while now and at this point, they are taking up maybe 15Gigs. Most of this is photo attchments. I thought an options was to manually go through the phone UI, deleting photo attachments to save space, but I did a bit of this tedium and the storage space did not seem to clear up. Maybe it is delayed? The other alternative is to hit a button that says \u0026ldquo;only keep messages up to a year old\u0026rdquo;.","keywords":[],"articleBody":"The problem Messages have been clogging up my iphone for a while now and at this point, they are taking up maybe 15Gigs. Most of this is photo attchments. I thought an options was to manually go through the phone UI, deleting photo attachments to save space, but I did a bit of this tedium and the storage space did not seem to clear up. Maybe it is delayed? The other alternative is to hit a button that says “only keep messages up to a year old”. In reality, I don’t need the 15 Gigs of photo attachments, but I don’t want to lose the text data.\nMac laptop based export Luckily a month or two ago I started syncing imessages through icloud and so I was able to try out ReagentX’s imessage-exporter on github. Looks like this only pulled scattered 1meg ofconversations, for sure only from this last month or two.\nI am on macos Ventura so I could not do the itunes backup as stated in the reddit thread , but I tried the unencrypted iphone backup that you can use just when you connect your phone to your laptop. In this backup there was a Manifest.db , which allowed me to find a sms.db in there and also Attachments. I was able to also use imessage-exporter on this sms.db, however the --attachment-root option looks like was not supported for iphone based extraction with the version I tried. Still, now I have an additional 13meg of text data.\nNote on using the Manifest.db in the iphone export The imessage-exporter was not handling the 15gig of attachments I pulled from the iphone export at least now, but just writing out here what I did just in case this is available in the future.\nFirst I used ChatGPT to quickly cook up some sqlite code to inspect this Manifest.db, and then to pull out the table to csv,\nimport sqlite3 from pathlib import Path def get_table_schemas(database_file): conn = sqlite3.connect(database_file) cursor = conn.cursor() # Get a list of all tables in the database cursor.execute(\"SELECT name FROM sqlite_master WHERE type='table';\") tables = cursor.fetchall() table_schemas = {} for table in tables: table_name = table[0] cursor.execute(f\"PRAGMA table_info({table_name});\") columns = cursor.fetchall() schema = {} for column in columns: column_name = column[1] data_type = column[2] not_null = column[3] default_value = column[4] primary_key = column[5] schema[column_name] = { \"data_type\": data_type, \"not_null\": not_null, \"default_value\": default_value, \"primary_key\": primary_key } table_schemas[table_name] = schema conn.close() return table_schemas def print_schemas(schemas): for table_name, schema in schemas.items(): print(f\"Table: {table_name}\") for column_name, column_info in schema.items(): print(f\" Column: {column_name}\") print(f\" Data Type: {column_info['data_type']}\") print(f\" Not Null: {column_info['not_null']}\") print(f\" Default Value: {column_info['default_value']}\") print(f\" Primary Key: {column_info['primary_key']}\") def export_table_to_csv(database_file, table_name, csv_file): conn = sqlite3.connect(database_file) cursor = conn.cursor() cursor.execute(f\"SELECT * FROM {table_name};\") data = cursor.fetchall() column_names = [description[0] for description in cursor.description] with open(csv_file, 'w', newline='') as file: writer = csv.writer(file) writer.writerow(column_names) writer.writerows(data) conn.close() So looking at the schema, with print_schemas , I saw two tables, Files and Properties. And I extracted both, like,\npath = (Path(\"/Users/michal/Library/Application Support/MobileSync\") / \"Backup/00008020-000E7C903A23002E\" / \"Manifest.db\") import pandas as pd import csv export_table_to_csv(str(path), \"Files\", str(path.with_stem(path.stem + \"-Files\").with_suffix(\".csv\"))) export_table_to_csv(str(path), \"Properties\", str(path.with_stem(path.stem + \"-Properties\").with_suffix(\".csv\"))) manifestdf = pd.read_csv(path.with_suffix(\".csv\")) I did a search for sms like,\nmanifestdf[(manifestdf.relativePath.notnull()) \u0026 (manifestdf.relativePath.str.contains(\"sms\"))][[ \"fileID\",\"domain\",\"relativePath\"]].to_dict(orient=\"records\") which dug out, this sms.db ,\n{'fileID': '3d0d7e5fb2ce288813306e4d4636395e047a3d28', 'domain': 'HomeDomain', 'relativePath': 'Library/SMS/sms.db'}, I did also notice “Library/SMS/Attachments/” , “Library/SMS/Drafts/” in there, so I tried digging out the Attachments like this ,\nattachments_records = manifestdf[ (manifestdf.relativePath.notnull()) \u0026 (manifestdf.relativePath.str.contains(\"SMS/Attachments\")) ][[\"fileID\",\"domain\",\"relativePath\"]].to_dict(orient=\"records\") Somehow a lot of the data appeared to be missing, somehow, so I filtered by not missing,\nsource_dir = (Path(\"/Users/michal/Library/Application Support/MobileSync\") / \"Backup/00008020-000E7C903A23002E\") destination_dir = ( Path(\"/Users/michal/imessage-data\") / \"2023-12-09-1934-from-iphone-hmm\" / \"Attachments\" ) attachments_exist = [] for x in attachments_records: if (source_dir / x[\"fileID\"][:2] / x[\"fileID\"]).exists(): attachments_exist.append(x) attachments_exist[:2] # [{'fileID': '7112c681ea44f8b64609aa943b5b1182a393136a', # 'domain': 'MediaDomain', # 'relativePath': 'Library/SMS/Attachments/61/01/72A08FCD-CD0B-4AF7-83CF-F5E94D546A64/IMG_1976.PNG'}, # {'fileID': '1faae24aef070aebc630d8b315b1630f2ffc5be3', # 'domain': 'MediaDomain', # 'relativePath': 'Library/SMS/Attachments/61/01/FA8E24CD-AF3D-4607-B954-347E5DEF57AA/IMG_0714.jpeg'}] After some trial and error, I ended up with this for the copy,\ndef copy_attachments(attachments_records, source_dir, destination_dir): for record in attachments_records: first_two_characters = record[\"fileID\"][:2] from_path = source_dir / first_two_characters / record[\"fileID\"] if from_path.exists(): relative_path = Path(\"/\".join(record[\"relativePath\"].split(\"/\")[3:])) to_path = destination_dir / relative_path if not to_path.parent.exists(): to_path.parent.mkdir(parents=True, exist_ok=True) shutil.copy(from_path, to_path) ... ... Though as I mentioned earlier, the imessage export call, basically did not work. The diagnostics option ignores the attachments,\nimessage-exporter --db-path /Users/michal/imessage-data/2023-12-09-1934-from-iphone-hmm/sms.db --attachment-root /Users/michal/imessage-data/2023-12-09-1934-from-iphone-hmm/Attachments --diagnostics Building cache... [1/4] Caching chats... [2/4] Caching chatrooms... [3/4] Caching participants... [4/4] Caching reactions... Cache built! iMessage Database Diagnostics Contacts with more than one ID: 49 Message diagnostic data: Total messages: 76650 Messages not associated with a chat: 2112 Messages belonging to more than one chat: 26 Attachment diagnostic data: Total attachments: 16272 Data referenced in table: 16.15 GB Data present on disk: 0.00 B Missing files: 16272 (100%) No path provided: 189 No file located: 16083 Global diagnostic data: Total database size: 171.45 MB Duplicated contacts: 74 Duplicated chats: 6 Done! And later also, using the --platform iOS option I saw that the --attachment-root option is only supported for --platform macOS , so I am stuck at this point. But maybe later this can be worked out.\nIn any case, the good news is that I was able to dig out the text data, which was more important to me and now I feel more comfortable to just go with the “only keep 1 years worth of data \" option, moving forward 😀.\n","wordCount":"885","inLanguage":"en","datePublished":"2023-12-09T00:00:00Z","dateModified":"2023-12-10T12:37:43-05:00","author":{"@type":"Person","name":"Michal Piekarczyk"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://michal.piekarczyk.xyz/post/2023-12-09-imessage-export/"},"publisher":{"@type":"Organization","name":"michal.piekarczyk.xyz","logo":{"@type":"ImageObject","url":"https://michal.piekarczyk.xyz/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://michal.piekarczyk.xyz/ accesskey=h title="michal.piekarczyk.xyz (Alt + H)">michal.piekarczyk.xyz</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://michal.piekarczyk.xyz/post/ title=posts><span>posts</span></a></li><li><a href=https://michal.piekarczyk.xyz/project/ title=projects><span>projects</span></a></li><li><a href=https://michal.piekarczyk.xyz/handy/ title=handy><span>handy</span></a></li><li><a href=https://michal.piekarczyk.xyz/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://michal.piekarczyk.xyz/about/ title=about><span>about</span></a></li><li><a href=https://world.hey.com/michal.piekarczyk title=frivolity><span>frivolity</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://michal.piekarczyk.xyz/>Home</a>&nbsp;»&nbsp;<a href=https://michal.piekarczyk.xyz/post/>Posts</a></div><h1 class=post-title>Exporting messages from Apple imessages</h1><div class=post-meta>&lt;span title='2023-12-09 00:00:00 +0000 UTC'>December 9, 2023&lt;/span>&amp;nbsp;·&amp;nbsp;5 min&amp;nbsp;·&amp;nbsp;885 words&amp;nbsp;·&amp;nbsp;Michal Piekarczyk</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents></nav></div></details></div><div class=post-content><h1 id=the-problem>The problem<a hidden class=anchor aria-hidden=true href=#the-problem>#</a></h1><p>Messages have been clogging up my iphone for a while now and at this point, they are taking up maybe 15Gigs. Most of this is photo attchments. I thought an options was to manually go through the phone UI, deleting photo attachments to save space, but I did a bit of this tedium and the storage space did not seem to clear up. Maybe it is delayed? The other alternative is to hit a button that says &ldquo;only keep messages up to a year old&rdquo;. In reality, I don&rsquo;t need the 15 Gigs of photo attachments, but I don&rsquo;t want to lose the text data.</p><h1 id=mac-laptop-based-export>Mac laptop based export<a hidden class=anchor aria-hidden=true href=#mac-laptop-based-export>#</a></h1><p>Luckily a month or two ago I started syncing imessages through icloud and so I was able to try out <a href=https://github.com/ReagentX/imessage-exporter>ReagentX&rsquo;s imessage-exporter</a> on github. Looks like this only pulled scattered <code>1meg</code> ofconversations, for sure only from this last month or two.</p><p>I am on macos Ventura so I could not do the itunes backup as stated in the <a href=https://www.reddit.com/r/apple/comments/10cp8dh/i_wanted_to_be_able_to_exportbackup_imessage/>reddit thread</a> , but I tried the unencrypted iphone backup that you can use just when you connect your phone to your laptop. In this backup there was a <code>Manifest.db</code> , which allowed me to find a <code>sms.db</code> in there and also Attachments. I was able to also use <code>imessage-exporter</code> on this <code>sms.db</code>, however the <code>--attachment-root</code> option looks like was not supported for iphone based extraction with the version I tried. Still, now I have an additional <code>13meg</code> of text data.</p><h1 id=note-on-using-the-manifestdb-in-the-iphone-export>Note on using the <code>Manifest.db</code> in the iphone export<a hidden class=anchor aria-hidden=true href=#note-on-using-the-manifestdb-in-the-iphone-export>#</a></h1><p>The <code>imessage-exporter</code> was not handling the 15gig of attachments I pulled from the iphone export at least now, but just writing out here what I did just in case this is available in the future.</p><p>First I used ChatGPT to quickly cook up some <code>sqlite</code> code to inspect this <code>Manifest.db</code>, and then to pull out the table to csv,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sqlite3
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pathlib <span style=color:#f92672>import</span> Path
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_table_schemas</span>(database_file):
</span></span><span style=display:flex><span>    conn <span style=color:#f92672>=</span> sqlite3<span style=color:#f92672>.</span>connect(database_file)
</span></span><span style=display:flex><span>    cursor <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Get a list of all tables in the database</span>
</span></span><span style=display:flex><span>    cursor<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;;&#34;</span>)
</span></span><span style=display:flex><span>    tables <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    table_schemas <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> table <span style=color:#f92672>in</span> tables:
</span></span><span style=display:flex><span>        table_name <span style=color:#f92672>=</span> table[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>        cursor<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;PRAGMA table_info(</span><span style=color:#e6db74>{</span>table_name<span style=color:#e6db74>}</span><span style=color:#e6db74>);&#34;</span>)
</span></span><span style=display:flex><span>        columns <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span>fetchall()
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        schema <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> column <span style=color:#f92672>in</span> columns:
</span></span><span style=display:flex><span>            column_name <span style=color:#f92672>=</span> column[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>            data_type <span style=color:#f92672>=</span> column[<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>            not_null <span style=color:#f92672>=</span> column[<span style=color:#ae81ff>3</span>]
</span></span><span style=display:flex><span>            default_value <span style=color:#f92672>=</span> column[<span style=color:#ae81ff>4</span>]
</span></span><span style=display:flex><span>            primary_key <span style=color:#f92672>=</span> column[<span style=color:#ae81ff>5</span>]
</span></span><span style=display:flex><span>            schema[column_name] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;data_type&#34;</span>: data_type,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;not_null&#34;</span>: not_null,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;default_value&#34;</span>: default_value,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;primary_key&#34;</span>: primary_key
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        table_schemas[table_name] <span style=color:#f92672>=</span> schema
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    conn<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> table_schemas
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>print_schemas</span>(schemas):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> table_name, schema <span style=color:#f92672>in</span> schemas<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Table: </span><span style=color:#e6db74>{</span>table_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> column_name, column_info <span style=color:#f92672>in</span> schema<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;  Column: </span><span style=color:#e6db74>{</span>column_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;    Data Type: </span><span style=color:#e6db74>{</span>column_info[<span style=color:#e6db74>&#39;data_type&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;    Not Null: </span><span style=color:#e6db74>{</span>column_info[<span style=color:#e6db74>&#39;not_null&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;    Default Value: </span><span style=color:#e6db74>{</span>column_info[<span style=color:#e6db74>&#39;default_value&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;    Primary Key: </span><span style=color:#e6db74>{</span>column_info[<span style=color:#e6db74>&#39;primary_key&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>export_table_to_csv</span>(database_file, table_name, csv_file):
</span></span><span style=display:flex><span>    conn <span style=color:#f92672>=</span> sqlite3<span style=color:#f92672>.</span>connect(database_file)
</span></span><span style=display:flex><span>    cursor <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cursor<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;SELECT * FROM </span><span style=color:#e6db74>{</span>table_name<span style=color:#e6db74>}</span><span style=color:#e6db74>;&#34;</span>)
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span>fetchall()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    column_names <span style=color:#f92672>=</span> [description[<span style=color:#ae81ff>0</span>] <span style=color:#66d9ef>for</span> description <span style=color:#f92672>in</span> cursor<span style=color:#f92672>.</span>description]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(csv_file, <span style=color:#e6db74>&#39;w&#39;</span>, newline<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>) <span style=color:#66d9ef>as</span> file:
</span></span><span style=display:flex><span>        writer <span style=color:#f92672>=</span> csv<span style=color:#f92672>.</span>writer(file)
</span></span><span style=display:flex><span>        writer<span style=color:#f92672>.</span>writerow(column_names)
</span></span><span style=display:flex><span>        writer<span style=color:#f92672>.</span>writerows(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    conn<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><p>So looking at the schema, with <code>print_schemas</code> , I saw two tables, <code>Files</code> and <code>Properties</code>. And I extracted both, like,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>path <span style=color:#f92672>=</span> (Path(<span style=color:#e6db74>&#34;/Users/michal/Library/Application Support/MobileSync&#34;</span>)
</span></span><span style=display:flex><span>       <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;Backup/00008020-000E7C903A23002E&#34;</span> <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;Manifest.db&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> csv
</span></span><span style=display:flex><span>export_table_to_csv(str(path), <span style=color:#e6db74>&#34;Files&#34;</span>, 
</span></span><span style=display:flex><span>                    str(path<span style=color:#f92672>.</span>with_stem(path<span style=color:#f92672>.</span>stem <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-Files&#34;</span>)<span style=color:#f92672>.</span>with_suffix(<span style=color:#e6db74>&#34;.csv&#34;</span>)))
</span></span><span style=display:flex><span>export_table_to_csv(str(path), <span style=color:#e6db74>&#34;Properties&#34;</span>, 
</span></span><span style=display:flex><span>                    str(path<span style=color:#f92672>.</span>with_stem(path<span style=color:#f92672>.</span>stem <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-Properties&#34;</span>)<span style=color:#f92672>.</span>with_suffix(<span style=color:#e6db74>&#34;.csv&#34;</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>manifestdf <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(path<span style=color:#f92672>.</span>with_suffix(<span style=color:#e6db74>&#34;.csv&#34;</span>))
</span></span></code></pre></div><p>I did a search for <code>sms</code> like,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>manifestdf[(manifestdf<span style=color:#f92672>.</span>relativePath<span style=color:#f92672>.</span>notnull()) 
</span></span><span style=display:flex><span>           <span style=color:#f92672>&amp;</span> (manifestdf<span style=color:#f92672>.</span>relativePath<span style=color:#f92672>.</span>str<span style=color:#f92672>.</span>contains(<span style=color:#e6db74>&#34;sms&#34;</span>))][[
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;fileID&#34;</span>,<span style=color:#e6db74>&#34;domain&#34;</span>,<span style=color:#e6db74>&#34;relativePath&#34;</span>]]<span style=color:#f92672>.</span>to_dict(orient<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;records&#34;</span>)
</span></span></code></pre></div><p>which dug out, this <code>sms.db</code> ,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span> {<span style=color:#e6db74>&#39;fileID&#39;</span>: <span style=color:#e6db74>&#39;3d0d7e5fb2ce288813306e4d4636395e047a3d28&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;domain&#39;</span>: <span style=color:#e6db74>&#39;HomeDomain&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;relativePath&#39;</span>: <span style=color:#e6db74>&#39;Library/SMS/sms.db&#39;</span>},
</span></span></code></pre></div><p>I did also notice &ldquo;Library/SMS/Attachments/&rdquo; , &ldquo;Library/SMS/Drafts/&rdquo; in there, so I tried digging out the Attachments like this ,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>attachments_records <span style=color:#f92672>=</span> manifestdf[
</span></span><span style=display:flex><span>    (manifestdf<span style=color:#f92672>.</span>relativePath<span style=color:#f92672>.</span>notnull()) 
</span></span><span style=display:flex><span>    <span style=color:#f92672>&amp;</span> (manifestdf<span style=color:#f92672>.</span>relativePath<span style=color:#f92672>.</span>str<span style=color:#f92672>.</span>contains(<span style=color:#e6db74>&#34;SMS/Attachments&#34;</span>))
</span></span><span style=display:flex><span>    ][[<span style=color:#e6db74>&#34;fileID&#34;</span>,<span style=color:#e6db74>&#34;domain&#34;</span>,<span style=color:#e6db74>&#34;relativePath&#34;</span>]]<span style=color:#f92672>.</span>to_dict(orient<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;records&#34;</span>)
</span></span></code></pre></div><p>Somehow a lot of the data appeared to be missing, somehow, so I filtered by not missing,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>source_dir <span style=color:#f92672>=</span> (Path(<span style=color:#e6db74>&#34;/Users/michal/Library/Application Support/MobileSync&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;Backup/00008020-000E7C903A23002E&#34;</span>)
</span></span><span style=display:flex><span>destination_dir <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>    Path(<span style=color:#e6db74>&#34;/Users/michal/imessage-data&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;2023-12-09-1934-from-iphone-hmm&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;Attachments&#34;</span>
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>attachments_exist <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> attachments_records:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (source_dir <span style=color:#f92672>/</span> x[<span style=color:#e6db74>&#34;fileID&#34;</span>][:<span style=color:#ae81ff>2</span>] <span style=color:#f92672>/</span> x[<span style=color:#e6db74>&#34;fileID&#34;</span>])<span style=color:#f92672>.</span>exists():
</span></span><span style=display:flex><span>        attachments_exist<span style=color:#f92672>.</span>append(x)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>attachments_exist[:<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># [{&#39;fileID&#39;: &#39;7112c681ea44f8b64609aa943b5b1182a393136a&#39;,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   &#39;domain&#39;: &#39;MediaDomain&#39;,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   &#39;relativePath&#39;: &#39;Library/SMS/Attachments/61/01/72A08FCD-CD0B-4AF7-83CF-F5E94D546A64/IMG_1976.PNG&#39;},</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  {&#39;fileID&#39;: &#39;1faae24aef070aebc630d8b315b1630f2ffc5be3&#39;,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   &#39;domain&#39;: &#39;MediaDomain&#39;,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   &#39;relativePath&#39;: &#39;Library/SMS/Attachments/61/01/FA8E24CD-AF3D-4607-B954-347E5DEF57AA/IMG_0714.jpeg&#39;}]</span>
</span></span></code></pre></div><p>After some trial and error, I ended up with this for the copy,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>copy_attachments</span>(attachments_records, source_dir, destination_dir):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> record <span style=color:#f92672>in</span> attachments_records:
</span></span><span style=display:flex><span>        first_two_characters <span style=color:#f92672>=</span> record[<span style=color:#e6db74>&#34;fileID&#34;</span>][:<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>        from_path <span style=color:#f92672>=</span> source_dir <span style=color:#f92672>/</span> first_two_characters <span style=color:#f92672>/</span> record[<span style=color:#e6db74>&#34;fileID&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> from_path<span style=color:#f92672>.</span>exists():
</span></span><span style=display:flex><span>            relative_path <span style=color:#f92672>=</span> Path(<span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>.</span>join(record[<span style=color:#e6db74>&#34;relativePath&#34;</span>]<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;/&#34;</span>)[<span style=color:#ae81ff>3</span>:]))
</span></span><span style=display:flex><span>            to_path <span style=color:#f92672>=</span> destination_dir <span style=color:#f92672>/</span> relative_path
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> to_path<span style=color:#f92672>.</span>parent<span style=color:#f92672>.</span>exists():
</span></span><span style=display:flex><span>                to_path<span style=color:#f92672>.</span>parent<span style=color:#f92672>.</span>mkdir(parents<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, exist_ok<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>            shutil<span style=color:#f92672>.</span>copy(from_path, to_path)
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Though as I mentioned earlier, the imessage export call, basically did not work. The diagnostics option ignores the attachments,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>imessage-exporter     --db-path /Users/michal/imessage-data/2023-12-09-1934-from-iphone-hmm/sms.db   --attachment-root /Users/michal/imessage-data/2023-12-09-1934-from-iphone-hmm/Attachments  --diagnostics   
</span></span><span style=display:flex><span>Building cache...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>1/4<span style=color:#f92672>]</span> Caching chats...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>2/4<span style=color:#f92672>]</span> Caching chatrooms...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>3/4<span style=color:#f92672>]</span> Caching participants...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>4/4<span style=color:#f92672>]</span> Caching reactions...
</span></span><span style=display:flex><span>Cache built!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>iMessage Database Diagnostics
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Contacts with more than one ID: <span style=color:#ae81ff>49</span>
</span></span><span style=display:flex><span>Message diagnostic data:
</span></span><span style=display:flex><span>    Total messages: <span style=color:#ae81ff>76650</span>
</span></span><span style=display:flex><span>    Messages not associated with a chat: <span style=color:#ae81ff>2112</span>
</span></span><span style=display:flex><span>    Messages belonging to more than one chat: <span style=color:#ae81ff>26</span>
</span></span><span style=display:flex><span>Attachment diagnostic data:
</span></span><span style=display:flex><span>    Total attachments: <span style=color:#ae81ff>16272</span>
</span></span><span style=display:flex><span>        Data referenced in table: 16.15 GB
</span></span><span style=display:flex><span>        Data present on disk: 0.00 B
</span></span><span style=display:flex><span>    Missing files: <span style=color:#ae81ff>16272</span> <span style=color:#f92672>(</span>100%<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        No path provided: <span style=color:#ae81ff>189</span>
</span></span><span style=display:flex><span>        No file located: <span style=color:#ae81ff>16083</span>
</span></span><span style=display:flex><span>Global diagnostic data:
</span></span><span style=display:flex><span>    Total database size: 171.45 MB
</span></span><span style=display:flex><span>    Duplicated contacts: <span style=color:#ae81ff>74</span>
</span></span><span style=display:flex><span>    Duplicated chats: <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>Done!
</span></span></code></pre></div><p>And later also, using the <code>--platform iOS</code> option I saw that the <code>--attachment-root</code> option is only supported for <code>--platform macOS</code> , so I am stuck at this point. But maybe later this can be worked out.</p><p>In any case, the good news is that I was able to dig out the text data, which was more important to me and now I feel more comfortable to just go with the &ldquo;only keep 1 years worth of data " option, moving forward 😀.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://michal.piekarczyk.xyz/post/2023-12-23-learn-golang-through-chat-gpt-conversation/><span class=title>« Prev</span><br><span>Some of my notes through learning Golang by conversing with ChatGPT</span>
</a><a class=next href=https://michal.piekarczyk.xyz/post/2023-11-18-test-drive-chat-gpt-data-analysis/><span class=title>Next »</span><br><span>test drive chat gpt data analysis</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://michal.piekarczyk.xyz/>michal.piekarczyk.xyz</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>